<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>VG CONSTRUTORA — Gestor de Obras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f1f5f9; }
    .hidden { display:none !important; }
  </style>
</head>
<body class="text-slate-800">

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-lg p-8 max-w-sm w-full text-center">
      <h1 class="text-2xl font-bold mb-2">VG CONSTRUTORA</h1>
      <p class="text-sm text-slate-600 mb-5">Multi-obras • Multi-casas • Sócios • Rateio • Acertos</p>
      <button id="login-btn" class="bg-slate-900 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg w-full">
        Entrar com Google
      </button>
      <p id="login-msg" class="text-xs text-red-600 mt-4 h-4"></p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-wrapper" class="hidden">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">

      <div class="bg-white rounded-2xl shadow-lg p-4 flex flex-wrap items-center justify-between gap-4">
        <div>
          <h2 class="text-xl font-bold">VG CONSTRUTORA</h2>
          <p class="text-sm text-slate-500">Gestor de Obras</p>
        </div>
        <div class="flex items-center gap-3">
          <img id="user-photo" class="w-9 h-9 rounded-full" />
          <div class="text-sm">
            <div id="user-name" class="font-semibold"></div>
            <div id="user-email" class="text-slate-500"></div>
          </div>
          <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-white rounded-2xl shadow-lg p-4">
          <div class="flex items-center justify-between gap-2">
            <h3 class="font-bold">Obra</h3>
            <button id="obra-new-btn" class="text-sm bg-slate-900 hover:bg-slate-700 text-white font-bold px-3 py-2 rounded-lg">Nova</button>
          </div>
          <select id="obra-select" class="mt-3 w-full border rounded-lg p-2"></select>
          <div id="obra-status" class="text-xs text-slate-500 mt-2"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-4">
          <div class="flex items-center justify-between gap-2">
            <h3 class="font-bold">Casa / Unidade</h3>
            <button id="unidade-new-btn" class="text-sm bg-slate-900 hover:bg-slate-700 text-white font-bold px-3 py-2 rounded-lg">Nova</button>
          </div>
          <label class="text-xs text-slate-500 mt-3 block">Onde lançar</label>
          <select id="unidade-current" class="mt-1 w-full border rounded-lg p-2"></select>
          <label class="text-xs text-slate-500 mt-3 block">Visão / Filtro</label>
          <select id="unidade-view" class="mt-1 w-full border rounded-lg p-2"></select>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-4">
          <h3 class="font-bold">KPIs</h3>
          <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
            <div class="bg-slate-100 rounded-xl p-3">
              <div class="text-slate-500">Total (visão)</div>
              <div id="kpi-total" class="text-lg font-bold">R$ 0,00</div>
            </div>
            <div class="bg-slate-100 rounded-xl p-3">
              <div class="text-slate-500">Equalização</div>
              <div id="kpi-equal" class="text-sm font-bold">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold">Sócios (por obra)</h3>
          <button id="socios-save" class="bg-slate-900 hover:bg-slate-700 text-white font-bold px-4 py-2 rounded-lg">Salvar</button>
        </div>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
          <input id="socio-a" class="border rounded-lg p-2 font-semibold" placeholder="Sócio A" />
          <input id="socio-b" class="border rounded-lg p-2 font-semibold" placeholder="Sócio B" />
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-4">
        <h3 class="font-bold text-lg">Novo Lançamento</h3>
        <form id="lanc-form" class="mt-4 grid grid-cols-1 md:grid-cols-7 gap-2">
          <input id="lanc-dt" type="date" class="border rounded-lg p-2 md:col-span-1" required />
          <input id="lanc-desc" class="border rounded-lg p-2 md:col-span-2" placeholder="Descrição" required />
          <input id="lanc-valor" class="border rounded-lg p-2 md:col-span-1" placeholder="Valor" required />
          <select id="lanc-pagador" class="border rounded-lg p-2 md:col-span-1"></select>
          <input id="lanc-pa" type="number" step="0.01" min="0" max="1" value="0.5" class="border rounded-lg p-2 md:col-span-1" />
          <input id="lanc-pb" type="number" step="0.01" min="0" max="1" value="0.5" class="border rounded-lg p-2 md:col-span-1" />
          <button class="bg-slate-900 hover:bg-slate-700 text-white font-bold px-4 py-2 rounded-lg md:col-span-1">Salvar</button>
        </form>
        <p class="text-xs text-slate-500 mt-2">Regra: pA + pB = 1.00 (100%). Rateio entre casas é na seção Rateio.</p>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-4">
        <h3 class="font-bold text-lg">Acertos</h3>
        <form id="acerto-form" class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-2">
          <select id="acerto-de" class="border rounded-lg p-2"></select>
          <select id="acerto-para" class="border rounded-lg p-2"></select>
          <input id="acerto-valor" class="border rounded-lg p-2" placeholder="Valor" required />
          <button class="bg-teal-600 hover:bg-teal-700 text-white font-bold px-4 py-2 rounded-lg">Registrar</button>
        </form>
        <div id="balanca" class="mt-3 bg-slate-100 rounded-xl p-3 text-sm"></div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-4">
        <h3 class="font-bold text-lg">Rateio (um custo para várias casas)</h3>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-2">
          <input id="rat-desc" class="border rounded-lg p-2 md:col-span-2" placeholder="Descrição (ex: Materiais do muro)" />
          <input id="rat-valor" class="border rounded-lg p-2" placeholder="Valor total" />
          <select id="rat-from" class="border rounded-lg p-2"></select>
        </div>
        <div class="mt-3 bg-slate-50 rounded-xl p-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Destinos</div>
            <button id="rat-add-dest" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-3 py-2 rounded-lg">+ Destino</button>
          </div>
          <div id="rat-dests" class="mt-3 space-y-2"></div>
          <div class="mt-3 flex justify-end gap-2">
            <div id="rat-status" class="text-sm self-center"></div>
            <button id="rat-save" class="bg-slate-900 hover:bg-slate-700 text-white font-bold px-4 py-2 rounded-lg">Aplicar Rateio</button>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h3 class="font-bold text-lg">Lançamentos</h3>
          <div class="text-sm text-slate-500">Filtrando por: <span id="view-label" class="font-semibold"></span></div>
        </div>
        <div class="overflow-x-auto mt-3">
          <table class="w-full text-sm">
            <thead class="bg-slate-100">
              <tr>
                <th class="p-2 text-left">Data</th>
                <th class="p-2 text-left">Unidade</th>
                <th class="p-2 text-left">Descrição</th>
                <th class="p-2 text-left">Pagador</th>
                <th class="p-2 text-left">Valor</th>
                <th class="p-2 text-left">Ação</th>
              </tr>
            </thead>
            <tbody id="lanc-tbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot,
      query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "COLE_AQUI",
      authDomain: "COLE_AQUI",
      projectId: "COLE_AQUI",
      storageBucket: "COLE_AQUI",
      messagingSenderId: "COLE_AQUI",
      appId: "COLE_AQUI"
    };

    // ATENÇÃO: isso aqui NÃO é segurança real. Feche Firestore Rules.
    const ALLOW_EMAILS = new Set(["viictor.castro@gmail.com", "gcm.conceicao@gmail.com"]);

    const $ = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n||0));
    const parseNum = (v) => parseFloat(String(v||"").replace(/\./g,"").replace(",", ".")) || 0;

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let OBRA_ID = localStorage.getItem("obraId") || "";
    let unidadeCurrent = localStorage.getItem("unidadeCurrent") || "";
    let unidadeView = localStorage.getItem("unidadeView") || "OBRA_TODA";
    let listeners = [];

    const state = {
      obras: [], obra: null,
      unidades: [],
      config: { socioA:"Sócio A", socioB:"Sócio B" },
      lancamentos: [],
      acertos: [],
      rateios: []
    };

    const teardownRealtime = () => { listeners.forEach(u=>u()); listeners = []; };

    function refsFor(obraId) {
      return {
        obraDoc: doc(db, "obras", obraId),
        unidadesCol: collection(db, "obras", obraId, "unidades"),
        configDoc: doc(db, "obras", obraId, "config", "main"),
        lancamentosCol: collection(db, "obras", obraId, "lancamentos"),
        acertosCol: collection(db, "obras", obraId, "acertos"),
        rateiosCol: collection(db, "obras", obraId, "rateios"),
      };
    }

    function setupObrasList() {
      const obrasCol = collection(db, "obras");
      listeners.push(onSnapshot(query(obrasCol, orderBy("createdAt","desc")), (snap) => {
        state.obras = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        const sel = $("obra-select");

        if (state.obras.length === 0) {
          sel.innerHTML = `<option value="">Nenhuma obra — crie uma</option>`;
          $("obra-status").textContent = "Crie uma obra para começar.";
          return;
        }

        sel.innerHTML = state.obras.map(o => `<option value="${o.id}">${o.nome || o.id}</option>`).join("");

        if (!OBRA_ID) OBRA_ID = state.obras[0].id;
        sel.value = OBRA_ID;
        $("obra-status").textContent = `Obra ativa: ${state.obras.find(o=>o.id===OBRA_ID)?.nome || OBRA_ID}`;
        switchObra(OBRA_ID);
      }));
    }

    async function createObra() {
      const nome = prompt("Nome da obra (ex: Obra Terreno X):")?.trim();
      if (!nome) return;

      const obrasCol = collection(db, "obras");
      const ref = await addDoc(obrasCol, {
        nome,
        createdAt: serverTimestamp(),
        createdBy: currentUser.email
      });

      const r = refsFor(ref.id);
      await addDoc(r.unidadesCol, { nome:"Casa A", createdAt: serverTimestamp() });
      await addDoc(r.unidadesCol, { nome:"Casa B", createdAt: serverTimestamp() });
      await addDoc(r.unidadesCol, { nome:"Transitório", fixed:true, createdAt: serverTimestamp() });

      await setDoc(r.configDoc, { socioA:"Sócio A", socioB:"Sócio B", createdAt: serverTimestamp() }, { merge:true });

      OBRA_ID = ref.id;
      localStorage.setItem("obraId", OBRA_ID);
    }

    function switchObra(newId) {
      if (!newId) return;
      OBRA_ID = newId;
      localStorage.setItem("obraId", OBRA_ID);

      teardownRealtime();
      setupRealtimeForObra(OBRA_ID);
      setupObrasList(); // mantém lista atualizada
    }

    function setupRealtimeForObra(obraId) {
      const r = refsFor(obraId);

      listeners.push(onSnapshot(r.configDoc, (d) => {
        state.config = d.exists() ? d.data() : { socioA:"Sócio A", socioB:"Sócio B" };
        hydrateSocios();
        rerender();
      }));

      listeners.push(onSnapshot(query(r.unidadesCol, orderBy("createdAt","asc")), (snap) => {
        state.unidades = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hydrateUnidades();
        rerender();
      }));

      listeners.push(onSnapshot(query(r.lancamentosCol, orderBy("dt","desc")), (snap) => {
        state.lancamentos = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(query(r.acertosCol, orderBy("createdAt","desc")), (snap) => {
        state.acertos = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(query(r.rateiosCol, orderBy("createdAt","desc")), (snap) => {
        state.rateios = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        rerender();
      }));
    }

    function hydrateSocios() {
      const a = state.config?.socioA || "Sócio A";
      const b = state.config?.socioB || "Sócio B";
      $("socio-a").value = a;
      $("socio-b").value = b;

      const opts = [a,b].map(n => `<option value="${n}">${n}</option>`).join("");
      $("lanc-pagador").innerHTML = opts;
      $("acerto-de").innerHTML = opts;
      $("acerto-para").innerHTML = opts;
    }

    function hydrateUnidades() {
      const units = state.unidades || [];
      const trans = units.find(u => (u.nome||"").toLowerCase().includes("transit"));
      if (!unidadeCurrent || !units.some(u=>u.id===unidadeCurrent)) unidadeCurrent = trans?.id || units[0]?.id || "";
      if (unidadeView !== "OBRA_TODA" && !units.some(u=>u.id===unidadeView)) unidadeView = "OBRA_TODA";

      $("unidade-current").innerHTML = units.map(u => `<option value="${u.id}">${u.nome}</option>`).join("");
      $("unidade-current").value = unidadeCurrent;

      $("unidade-view").innerHTML = [
        `<option value="OBRA_TODA">Obra (Consolidado)</option>`,
        ...units.map(u => `<option value="${u.id}">${u.nome}</option>`)
      ].join("");
      $("unidade-view").value = unidadeView;

      $("rat-from").innerHTML = units.map(u => `<option value="${u.id}">${u.nome}</option>`).join("");
      if (trans) $("rat-from").value = trans.id;

      localStorage.setItem("unidadeCurrent", unidadeCurrent);
      localStorage.setItem("unidadeView", unidadeView);

      renderRateioDests();
    }

    async function createUnidade() {
      if (!OBRA_ID) return alert("Selecione uma obra.");
      const nome = prompt("Nome da unidade (Casa C / Edícula / etc):")?.trim();
      if (!nome) return;

      const r = refsFor(OBRA_ID);
      await addDoc(r.unidadesCol, { nome, createdAt: serverTimestamp() });
    }

    // RATEIO
    let rateioDests = [];
    function renderRateioDests() {
      if (!state.unidades.length) return;

      if (rateioDests.length === 0 && state.unidades.length >= 2) {
        // padrão: Casa A/B
        const a = state.unidades.find(u=>u.nome==="Casa A")?.id || state.unidades[0].id;
        const b = state.unidades.find(u=>u.nome==="Casa B")?.id || state.unidades[1].id;
        rateioDests = [{ unidadeId:a, p:0.5 }, { unidadeId:b, p:0.5 }];
      }

      const unitOpts = (selectedId) =>
        state.unidades.map(u => `<option value="${u.id}" ${u.id===selectedId?"selected":""}>${u.nome}</option>`).join("");

      $("rat-dests").innerHTML = rateioDests.map((d, idx) => `
        <div class="grid grid-cols-1 md:grid-cols-12 gap-2 items-center">
          <select data-idx="${idx}" class="rat-u border rounded-lg p-2 md:col-span-7">
            ${unitOpts(d.unidadeId)}
          </select>
          <input data-idx="${idx}" class="rat-p border rounded-lg p-2 md:col-span-4" type="number" step="0.01" min="0" max="1" value="${d.p}">
          <button data-idx="${idx}" class="rat-del bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg p-2 md:col-span-1">X</button>
        </div>
      `).join("");

      updateRateioStatus();
    }

    function updateRateioStatus() {
      const sum = rateioDests.reduce((s,d)=>s+(Number(d.p)||0),0);
      $("rat-status").textContent = `Soma %: ${(sum*100).toFixed(1)}% (precisa dar 100%)`;
      $("rat-status").className = sum > 0.999 && sum < 1.001 ? "text-sm text-green-700" : "text-sm text-red-700";
    }

    function computeSocios() {
      const a = state.config?.socioA || "Sócio A";
      const b = state.config?.socioB || "Sócio B";

      const lancs = (unidadeView === "OBRA_TODA")
        ? state.lancamentos
        : state.lancamentos.filter(l => l.unidadeId === unidadeView);

      const total = lancs.reduce((s,l)=>s+(l.valor||0),0);

      const pagoPorA = lancs.filter(l=>l.pagador===a).reduce((s,l)=>s+(l.valor||0),0);
      const pagoPorB = lancs.filter(l=>l.pagador===b).reduce((s,l)=>s+(l.valor||0),0);

      const devidoPorA = lancs.reduce((s,l)=>s+(l.valor||0)*(l.pA ?? 0.5),0);
      const devidoPorB = lancs.reduce((s,l)=>s+(l.valor||0)*(l.pB ?? 0.5),0);

      const acertos = state.acertos || [];
      const recebA = acertos.filter(x=>x.para===a).reduce((s,x)=>s+(x.valor||0),0);
      const pagA   = acertos.filter(x=>x.de===a).reduce((s,x)=>s+(x.valor||0),0);
      const saldoA = (pagoPorA - devidoPorA) - recebA + pagA;

      const recebB = acertos.filter(x=>x.para===b).reduce((s,x)=>s+(x.valor||0),0);
      const pagB   = acertos.filter(x=>x.de===b).reduce((s,x)=>s+(x.valor||0),0);
      const saldoB = (pagoPorB - devidoPorB) - recebB + pagB;

      let equal = "Saldos zerados";
      if (saldoA > 0.01) equal = `${b} paga ${fmt(saldoA)} para ${a}`;
      else if (saldoB > 0.01) equal = `${a} paga ${fmt(saldoB)} para ${b}`;

      return { a,b,total,saldoA,saldoB,equal };
    }

    function computeTotalVisao() {
      const lancs = (unidadeView === "OBRA_TODA")
        ? state.lancamentos
        : state.lancamentos.filter(l => l.unidadeId === unidadeView);

      // aplica rateios como transferências: subtrai origem e soma destinos
      const base = {};
      for (const u of state.unidades) base[u.id] = 0;
      for (const l of state.lancamentos) base[l.unidadeId] = (base[l.unidadeId]||0) + (l.valor||0);
      for (const r of state.rateios) {
        const v = r.valor || 0;
        if (r.fromUnidadeId) base[r.fromUnidadeId] = (base[r.fromUnidadeId]||0) - v;
        for (const d of (r.destinos||[])) base[d.unidadeId] = (base[d.unidadeId]||0) + v*(d.p||0);
      }

      if (unidadeView === "OBRA_TODA") return Object.values(base).reduce((s,n)=>s+n,0);
      return base[unidadeView] || 0;
    }

    function rerender() {
      $("view-label").textContent = unidadeView === "OBRA_TODA"
        ? "Obra (Consolidado)"
        : (state.unidades.find(u=>u.id===unidadeView)?.nome || "Unidade");

      $("kpi-total").textContent = fmt(computeTotalVisao());

      const c = computeSocios();
      $("kpi-equal").textContent = c.equal;
      $("balanca").innerHTML = `<div class="font-semibold">Equalização (visão atual):</div><div class="text-lg font-bold">${c.equal}</div>`;

      // tabela lançamentos
      const list = (unidadeView === "OBRA_TODA")
        ? state.lancamentos
        : state.lancamentos.filter(l => l.unidadeId === unidadeView);

      $("lanc-tbody").innerHTML = list.length ? list.map(l => `
        <tr class="border-b">
          <td class="p-2">${l.dt || ""}</td>
          <td class="p-2">${l.unidadeNome || ""}</td>
          <td class="p-2">${l.desc || ""}</td>
          <td class="p-2">${l.pagador || ""}</td>
          <td class="p-2 font-semibold">${fmt(l.valor)}</td>
          <td class="p-2"><button data-id="${l.id}" class="lanc-del text-red-600 font-bold">X</button></td>
        </tr>
      `).join("") : `<tr><td colspan="6" class="p-4 text-center text-slate-500">Nenhum lançamento.</td></tr>`;
    }

    // EVENTS
    $("obra-new-btn").addEventListener("click", createObra);
    $("unidade-new-btn").addEventListener("click", createUnidade);

    $("unidade-current").addEventListener("change", (e) => {
      unidadeCurrent = e.target.value;
      localStorage.setItem("unidadeCurrent", unidadeCurrent);
      rerender();
    });

    $("unidade-view").addEventListener("change", (e) => {
      unidadeView = e.target.value;
      localStorage.setItem("unidadeView", unidadeView);
      rerender();
    });

    $("socios-save").addEventListener("click", async () => {
      if (!OBRA_ID) return alert("Selecione uma obra.");
      const r = refsFor(OBRA_ID);
      await setDoc(r.configDoc, {
        socioA: $("socio-a").value.trim() || "Sócio A",
        socioB: $("socio-b").value.trim() || "Sócio B",
        updatedAt: serverTimestamp()
      }, { merge:true });
    });

    $("lanc-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!OBRA_ID) return alert("Selecione uma obra.");
      if (!unidadeCurrent) return alert("Selecione uma unidade (casa).");

      const dt = $("lanc-dt").value;
      const desc = $("lanc-desc").value.trim();
      const valor = parseNum($("lanc-valor").value);
      const pagador = $("lanc-pagador").value;
      const pA = Number($("lanc-pa").value);
      const pB = Number($("lanc-pb").value);

      if (!dt) return alert("Data obrigatória.");
      if (!desc) return alert("Descrição obrigatória.");
      if (valor <= 0) return alert("Valor deve ser positivo.");
      if (Math.abs((pA + pB) - 1) > 0.001) return alert("pA + pB precisa dar 1.00 (100%).");

      const r = refsFor(OBRA_ID);
      await addDoc(r.lancamentosCol, {
        dt, desc, valor,
        pagador, pA, pB,
        unidadeId: unidadeCurrent,
        unidadeNome: state.unidades.find(u=>u.id===unidadeCurrent)?.nome || "",
        createdBy: currentUser.email,
        createdAt: serverTimestamp()
      });

      $("lanc-desc").value = "";
      $("lanc-valor").value = "";
    });

    $("acerto-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!OBRA_ID) return alert("Selecione uma obra.");

      const de = $("acerto-de").value;
      const para = $("acerto-para").value;
      const valor = parseNum($("acerto-valor").value);

      if (de === para) return alert("De e Para devem ser diferentes.");
      if (valor <= 0) return alert("Valor do acerto deve ser positivo.");

      const r = refsFor(OBRA_ID);
      await addDoc(r.acertosCol, {
        de, para, valor,
        dt: serverTimestamp(),
        createdBy: currentUser.email,
        createdAt: serverTimestamp()
      });

      $("acerto-valor").value = "";
    });

    $("rat-add-dest").addEventListener("click", () => {
      const first = state.unidades[0]?.id || "";
      rateioDests.push({ unidadeId:first, p:0.25 });
      renderRateioDests();
    });

    $("rat-save").addEventListener("click", async () => {
      if (!OBRA_ID) return alert("Selecione uma obra.");
      const desc = $("rat-desc").value.trim();
      const valor = parseNum($("rat-valor").value);
      const fromUnidadeId = $("rat-from").value;

      if (!desc) return alert("Descrição do rateio obrigatória.");
      if (valor <= 0) return alert("Valor do rateio deve ser positivo.");

      const sum = rateioDests.reduce((s,d)=>s+(Number(d.p)||0),0);
      if (!(sum > 0.999 && sum < 1.001)) return alert("A soma dos percentuais precisa dar 100% (1.00).");

      const ids = rateioDests.map(d=>d.unidadeId);
      if (new Set(ids).size !== ids.length) return alert("Não repita a mesma unidade nos destinos.");

      const r = refsFor(OBRA_ID);
      await addDoc(r.rateiosCol, {
        desc, valor, fromUnidadeId,
        destinos: rateioDests.map(d => ({ unidadeId:d.unidadeId, p:Number(d.p)||0 })),
        createdBy: currentUser.email,
        createdAt: serverTimestamp(),
        dt: serverTimestamp()
      });

      $("rat-desc").value = "";
      $("rat-valor").value = "";
    });

    // Delegations
    document.body.addEventListener("click", async (e) => {
      if (e.target.classList.contains("rat-del")) {
        const idx = Number(e.target.dataset.idx);
        rateioDests.splice(idx, 1);
        renderRateioDests();
      }
      if (e.target.classList.contains("lanc-del")) {
        if (!OBRA_ID) return;
        const id = e.target.dataset.id;
        if (!confirm("Excluir lançamento?")) return;
        await deleteDoc(doc(db, "obras", OBRA_ID, "lancamentos", id));
      }
    });

    document.body.addEventListener("input", (e) => {
      if (e.target.classList.contains("rat-p")) {
        const idx = Number(e.target.dataset.idx);
        rateioDests[idx].p = Number(e.target.value) || 0;
        updateRateioStatus();
      }
    });

    document.body.addEventListener("change", (e) => {
      if (e.target.classList.contains("rat-u")) {
        const idx = Number(e.target.dataset.idx);
        rateioDests[idx].unidadeId = e.target.value;
        updateRateioStatus();
      }
    });

    // AUTH
    $("login-btn").addEventListener("click", () => {
      signInWithPopup(auth, provider).catch(err => {
        $("login-msg").textContent = err.code === "auth/unauthorized-domain"
          ? "Domínio não autorizado no Firebase."
          : "Erro no login.";
      });
    });

    $("logout-btn").addEventListener("click", () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user && ALLOW_EMAILS.has(user.email)) {
        currentUser = user;
        $("login-screen").classList.add("hidden");
        $("app-wrapper").classList.remove("hidden");
        $("user-photo").src = user.photoURL || "";
        $("user-name").textContent = user.displayName || "";
        $("user-email").textContent = user.email || "";
        $("lanc-dt").valueAsDate = new Date();
        teardownRealtime();
        setupObrasList();
      } else {
        if (user) signOut(auth);
        currentUser = null;
        teardownRealtime();
        $("app-wrapper").classList.add("hidden");
        $("login-screen").classList.remove("hidden");
      }
    });
  </script>
</body>
</html>
