<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>VG CONSTRUTORA — Gestor de Obras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f1f5f9; }
    .hidden { display:none !important; }
  </style>
</head>
<body class="text-slate-800">
  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-lg p-8 max-w-sm w-full text-center">
      <h1 class="text-2xl font-bold mb-2">VG CONSTRUTORA</h1>
      <p class="text-sm text-slate-600 mb-5">Controle completo por obra e por casa.</p>
      <button id="login-btn" class="bg-slate-900 hover:bg-slate-700 text-white font-bold py-3 px-6 rounded-lg w-full">
        Entrar com Google
      </button>
      <p id="login-msg" class="text-xs text-red-600 mt-4 h-4"></p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-wrapper" class="hidden">
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">

      <!-- Topbar -->
      <div class="bg-white rounded-2xl shadow-lg p-4 flex flex-wrap items-center justify-between gap-4">
        <div>
          <h2 class="text-xl font-bold">VG CONSTRUTORA</h2>
          <p class="text-sm text-slate-500">Dashboard • Previsão • Lucro • Controle</p>
        </div>
        <div class="flex items-center gap-3">
          <img id="user-photo" class="w-9 h-9 rounded-full" />
          <div class="text-sm">
            <div id="user-name" class="font-semibold"></div>
            <div id="user-email" class="text-slate-500"></div>
          </div>
          <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sair</button>
        </div>
      </div>

      <!-- Seletores -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-white rounded-2xl shadow-lg p-4">
          <div class="flex items-center justify-between gap-2">
            <h3 class="font-bold">Obra</h3>
            <button id="obra-new-btn" class="text-sm bg-slate-900 hover:bg-slate-700 text-white font-bold px-3 py-2 rounded-lg">Nova</button>
          </div>
          <select id="obra-select" class="mt-3 w-full border rounded-lg p-2"></select>
          <div id="obra-status" class="text-xs text-slate-500 mt-2"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-4">
          <div class="flex items-center justify-between gap-2">
            <h3 class="font-bold">Casa / Unidade</h3>
            <button id="unidade-new-btn" class="text-sm bg-slate-900 hover:bg-slate-700 text-white font-bold px-3 py-2 rounded-lg">Nova</button>
          </div>
          <label class="text-xs text-slate-500 mt-3 block">Onde lançar</label>
          <select id="unidade-current" class="mt-1 w-full border rounded-lg p-2"></select>
          <label class="text-xs text-slate-500 mt-3 block">Visão / Filtro</label>
          <select id="unidade-view" class="mt-1 w-full border rounded-lg p-2"></select>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-4 lg:col-span-1">
          <h3 class="font-bold">KPIs</h3>
          <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
            <div class="bg-slate-100 rounded-xl p-3">
              <div class="text-slate-500">Total (visão)</div>
              <div id="kpi-total" class="text-lg font-bold">R$ 0,00</div>
            </div>
            <div class="bg-slate-100 rounded-xl p-3">
              <div class="text-slate-500">Total (obra)</div>
              <div id="kpi-total-obra" class="text-lg font-bold">R$ 0,00</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Previsão -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <h3 class="font-bold text-lg">Dashboard — Previsão de Lucro</h3>
        <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
          <div class="bg-blue-50 rounded-xl p-3">
            <div class="text-blue-600 font-semibold">Receita Prevista</div>
            <div id="dash-receita" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div class="bg-red-50 rounded-xl p-3">
            <div class="text-red-600 font-semibold">Custo Total</div>
            <div id="dash-custo" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div class="bg-orange-50 rounded-xl p-3">
            <div class="text-orange-600 font-semibold">Encargos</div>
            <div id="dash-encargos" class="text-xl font-bold">R$ 0,00</div>
          </div>
          <div class="bg-green-50 rounded-xl p-3">
            <div class="text-green-600 font-semibold">Lucro Líquido</div>
            <div id="dash-lucro" class="text-xl font-bold">R$ 0,00</div>
            <div id="dash-margem" class="text-xs text-slate-600 mt-1">0%</div>
          </div>
        </div>
        <div id="dash-unidades" class="mt-3 text-xs text-slate-600"></div>
      </div>

      <!-- Sócios -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <h3 class="font-bold">Sócios</h3>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
          <input id="socio-a" class="border rounded-lg p-2 font-semibold" placeholder="Sócio A" />
          <input id="socio-b" class="border rounded-lg p-2 font-semibold" placeholder="Sócio B" />
        </div>
        <div class="mt-2 flex justify-end">
          <button id="socios-save" class="bg-slate-900 hover:bg-slate-700 text-white font-bold px-4 py-2 rounded-lg">
            Salvar
          </button>
        </div>
      </div>

      <!-- Vendas / Receitas -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <h3 class="font-bold text-lg">Vendas / Receitas (VGV)</h3>
        <form id="venda-form" class="mt-3 grid grid-cols-1 md:grid-cols-5 gap-2">
          <select id="venda-unidade" class="border rounded-lg p-2 md:col-span-1" required></select>
          <select id="venda-tipo" class="border rounded-lg p-2 md:col-span-1">
            <option value="prevista">Prevista</option>
            <option value="vendida">Vendida</option>
          </select>
          <input id="venda-valor" class="border rounded-lg p-2 md:col-span-1" placeholder="Valor (R$)" required />
          <input id="venda-dt" type="date" class="border rounded-lg p-2 md:col-span-1" placeholder="Data prevista" />
          <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg md:col-span-1">Adicionar</button>
        </form>
        <ul id="vendas-list" class="mt-3 space-y-2 text-sm"></ul>
      </div>

      <!-- Encargos / Impostos / Comissões -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <h3 class="font-bold text-lg">Encargos / Impostos / Comissões</h3>
        <form id="encargo-form" class="mt-3 grid grid-cols-1 md:grid-cols-6 gap-2">
          <input id="enc-nome" class="border rounded-lg p-2 md:col-span-2" placeholder="Nome (ex: Corretor)" required />
          <select id="enc-tipo" class="border rounded-lg p-2 md:col-span-1">
            <option value="percent">% Percentual</option>
            <option value="fixed">R$ Fixo</option>
          </select>
          <input id="enc-valor" class="border rounded-lg p-2 md:col-span-1" placeholder="Valor" required />
          <select id="enc-base" class="border rounded-lg p-2 md:col-span-1">
            <option value="receita">da Receita</option>
            <option value="custo">do Custo</option>
            <option value="lucro">do Lucro</option>
          </select>
          <select id="enc-escopo" class="border rounded-lg p-2 md:col-span-1">
            <option value="obra">Obra</option>
            <option value="unidade">Unidade</option>
          </select>
          <select id="enc-unidade" class="border rounded-lg p-2 md:col-span-2 hidden"></select>
          <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 py-2 rounded-lg md:col-span-2">Adicionar</button>
        </form>
        <ul id="encargos-list" class="mt-3 space-y-2 text-sm"></ul>
      </div>

      <!-- Cadastros rápidos -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-white rounded-2xl shadow-lg p-4">
          <h3 class="font-bold">Fornecedores</h3>
          <div class="mt-3 flex gap-2">
            <input id="forn-nome" class="w-full border rounded-lg p-2" placeholder="Nome do fornecedor" />
            <button id="forn-add" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-3 rounded-lg">+</button>
          </div>
          <ul id="forn-list" class="mt-3 text-sm space-y-2"></ul>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-4 lg:col-span-2">
          <h3 class="font-bold">Categorias (Categoria → Grupo → Subgrupo)</h3>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
            <input id="cat" class="border rounded-lg p-2" placeholder="Categoria (ex: Material)" />
            <input id="grp" class="border rounded-lg p-2" placeholder="Grupo (ex: Estrutura)" />
            <input id="sub" class="border rounded-lg p-2" placeholder="Subgrupo (ex: Cimento)" />
          </div>
          <div class="mt-2 flex justify-end">
            <button id="cat-add" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-4 py-2 rounded-lg">Adicionar</button>
          </div>
          <div id="cat-list" class="mt-3 text-sm grid grid-cols-1 md:grid-cols-2 gap-2"></div>
        </div>
      </div>

      <!-- Lançamento -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h3 class="font-bold text-lg">Novo Lançamento</h3>
          <div class="text-xs text-slate-500">Será gravado na Obra selecionada + Unidade selecionada</div>
        </div>

        <form id="lanc-form" class="mt-4 grid grid-cols-1 md:grid-cols-6 gap-2">
          <input id="lanc-dt" type="date" class="border rounded-lg p-2 md:col-span-1" required />
          <input id="lanc-desc" class="border rounded-lg p-2 md:col-span-2" placeholder="Descrição" required />
          <input id="lanc-valor" class="border rounded-lg p-2 md:col-span-1" placeholder="Valor" required />
          <select id="lanc-forn" class="border rounded-lg p-2 md:col-span-1"></select>
          <select id="lanc-catref" class="border rounded-lg p-2 md:col-span-1"></select>

          <select id="lanc-pagador" class="border rounded-lg p-2 md:col-span-1"></select>

          <div class="md:col-span-1">
            <label id="lab-pa" class="text-xs text-slate-500">Sócio A (%):</label>
            <input id="lanc-pa" type="number" step="0.01" min="0" max="1" value="0.5" class="border rounded-lg p-2 w-full" />
          </div>

          <div class="md:col-span-1">
            <label id="lab-pb" class="text-xs text-slate-500">Sócio B (%):</label>
            <input id="lanc-pb" type="number" step="0.01" min="0" max="1" value="0.5" class="border rounded-lg p-2 w-full" />
          </div>

          <input id="lanc-anexo" class="border rounded-lg p-2 md:col-span-2" placeholder="URL do comprovante (opcional)" />
          <button class="bg-slate-900 hover:bg-slate-700 text-white font-bold px-4 py-2 rounded-lg md:col-span-1">Salvar</button>
          <div class="md:col-span-1 flex items-center text-xs text-slate-500" id="lanc-hint"></div>
        </form>
      </div>

      <!-- Rateio -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <h3 class="font-bold text-lg">Rateio (um custo para várias casas)</h3>
        <p class="text-sm text-slate-500 mt-1">
          Use quando comprar "muro/cimento/areia" e quiser dividir. Você pode ratear do Transitório ou de qualquer casa.
        </p>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-2">
          <input id="rat-desc" class="border rounded-lg p-2 md:col-span-2" placeholder="Descrição (ex: Materiais do muro)" />
          <input id="rat-valor" class="border rounded-lg p-2" placeholder="Valor total" />
          <select id="rat-from" class="border rounded-lg p-2"></select>
        </div>

        <div class="mt-3 bg-slate-50 rounded-xl p-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Destinos</div>
            <button id="rat-add-dest" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-3 py-2 rounded-lg">+ Destino</button>
          </div>
          <div id="rat-dests" class="mt-3 space-y-2"></div>

          <div class="mt-3 flex justify-end gap-2">
            <div id="rat-status" class="text-sm text-slate-600 self-center"></div>
            <button id="rat-save" class="bg-slate-900 hover:bg-slate-700 text-white font-bold px-4 py-2 rounded-lg">Aplicar Rateio</button>
          </div>
        </div>
      </div>

      <!-- Acertos -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-lg">Acertos</h3>
          <button id="acerto-sugestao" class="text-sm bg-gray-600 hover:bg-gray-700 text-white font-bold px-3 py-2 rounded-lg">
            Sugestão
          </button>
        </div>

        <form id="acerto-form" class="mt-3 grid grid-cols-1 md:grid-cols-5 gap-2">
          <select id="acerto-de" class="border rounded-lg p-2 md:col-span-1"></select>
          <select id="acerto-para" class="border rounded-lg p-2 md:col-span-1"></select>
          <input id="acerto-valor" class="border rounded-lg p-2 md:col-span-1" placeholder="Valor" required />
          <input id="acerto-anexo" class="border rounded-lg p-2 md:col-span-2" placeholder="URL do comprovante (opcional)" />
          <button class="bg-teal-600 hover:bg-teal-700 text-white font-bold px-4 py-2 rounded-lg md:col-span-1">Registrar</button>
        </form>

        <div class="mt-3">
          <div id="balanca" class="bg-slate-100 rounded-xl p-3 text-sm"></div>
          <ul id="acertos-list" class="mt-3 space-y-2 text-sm"></ul>
        </div>
      </div>

      <!-- Tabela -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <h3 class="font-bold text-lg">Lançamentos</h3>
          <div class="text-sm text-slate-500">Filtrando por: <span id="view-label" class="font-semibold"></span></div>
        </div>

        <div class="overflow-x-auto mt-3">
          <table class="w-full text-sm">
            <thead class="bg-slate-100">
              <tr>
                <th class="p-2 text-left">Data</th>
                <th class="p-2 text-left">Unidade</th>
                <th class="p-2 text-left">Descrição</th>
                <th class="p-2 text-left">Fornecedor</th>
                <th class="p-2 text-left">Cat/Grp/Sub</th>
                <th class="p-2 text-left">Valor</th>
                <th class="p-2 text-left">Pagador</th>
                <th class="p-2 text-left">% A/B</th>
                <th class="p-2 text-left">Anexo</th>
                <th class="p-2 text-left">Ação</th>
              </tr>
            </thead>
            <tbody id="lanc-tbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot,
      query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    // ========= CONFIG =========
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_AUTH_DOMAIN",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_BUCKET",
      messagingSenderId: "SEU_SENDER",
      appId: "SEU_APP_ID"
    };

    const ALLOW_EMAILS = new Set(["viictor.castro@gmail.com", "gcm.conceicao@gmail.com"]);

    // ========= HELPERS =========
    const $ = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(n||0));
    const parseNum = (v) => parseFloat(String(v||"").replace(/\./g,"").replace(",", ".")) || 0;

    // ========= FIREBASE =========
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ========= STATE =========
    let currentUser = null;
    let OBRA_ID = localStorage.getItem("obraId") || "";
    let unidadeCurrent = localStorage.getItem("unidadeCurrent") || "";
    let unidadeView = localStorage.getItem("unidadeView") || "OBRA_TODA";
    let listeners = [];

    const state = {
      obras: [],
      obra: null,
      unidades: [],
      fornecedores: [],
      categorias: [],
      lancamentos: [],
      rateios: [],
      config: { socioA: "Sócio A", socioB: "Sócio B" },
      acertos: [],
      vendas: [],
      encargos: [],
      compromissos: [],
      previstos: []
    };

    function teardownRealtime() { listeners.forEach(u=>u()); listeners = []; }

    function refsFor(obraId) {
      return {
        obraDoc: doc(db, "obras", obraId),
        unidadesCol: collection(db, "obras", obraId, "unidades"),
        fornecedoresCol: collection(db, "obras", obraId, "fornecedores"),
        categoriasCol: collection(db, "obras", obraId, "categorias"),
        lancamentosCol: collection(db, "obras", obraId, "lancamentos"),
        rateiosCol: collection(db, "obras", obraId, "rateios"),
        configDoc: doc(db, "obras", obraId, "config", "main"),
        acertosCol: collection(db, "obras", obraId, "acertos"),
        vendasCol: collection(db, "obras", obraId, "vendas"),
        encargosCol: collection(db, "obras", obraId, "encargos"),
        compromissosCol: collection(db, "obras", obraId, "compromissos"),
        previstosCol: collection(db, "obras", obraId, "previstos"),
      };
    }

    // ========= OBRAS =========
    function setupObrasList() {
      const obrasCol = collection(db, "obras");
      listeners.push(onSnapshot(query(obrasCol, orderBy("createdAt","desc")), (snap) => {
        state.obras = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        const sel = $("obra-select");

        if (state.obras.length === 0) {
          sel.innerHTML = `<option value="">Nenhuma obra — crie uma</option>`;
          $("obra-status").textContent = "Crie uma obra para começar.";
          return;
        }

        sel.innerHTML = state.obras.map(o => `<option value="${o.id}">${o.nome || o.id}</option>`).join("");

        if (!OBRA_ID) OBRA_ID = state.obras[0].id;
        sel.value = OBRA_ID;

        $("obra-status").textContent = `Obra ativa: ${state.obras.find(o=>o.id===OBRA_ID)?.nome || OBRA_ID}`;
        switchObra(OBRA_ID);
      }));
    }

    async function createObra() {
      const nome = prompt("Nome da obra (ex: Obra Terreno X):")?.trim();
      if (!nome) return;

      const obrasCol = collection(db, "obras");
      const ref = await addDoc(obrasCol, {
        nome,
        createdAt: serverTimestamp(),
        createdBy: currentUser.email
      });

      // cria unidades padrão
      const r = refsFor(ref.id);
      await addDoc(r.unidadesCol, { nome:"Casa A", createdAt: serverTimestamp() });
      await addDoc(r.unidadesCol, { nome:"Casa B", createdAt: serverTimestamp() });
      await addDoc(r.unidadesCol, { nome:"Transitório", fixed:true, createdAt: serverTimestamp() });

      OBRA_ID = ref.id;
      localStorage.setItem("obraId", OBRA_ID);
    }

    function switchObra(newId) {
      if (!newId) return;
      if (newId === OBRA_ID && state.obra) return;

      OBRA_ID = newId;
      localStorage.setItem("obraId", OBRA_ID);

      teardownRealtime();
      setupRealtimeForObra(OBRA_ID);
    }

    // ========= REALTIME POR OBRA =========
    function setupRealtimeForObra(obraId) {
      const r = refsFor(obraId);

      listeners.push(onSnapshot(r.obraDoc, (d) => state.obra = d.exists() ? d.data() : null));

      listeners.push(onSnapshot(r.configDoc, (d) => {
        state.config = d.exists() ? d.data() : { socioA:"Sócio A", socioB:"Sócio B" };
        hydrateSocios();
        rerender();
      }));

      listeners.push(onSnapshot(query(r.unidadesCol, orderBy("createdAt","asc")), (snap) => {
        state.unidades = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hydrateUnidades();
        rerender();
      }));

      listeners.push(onSnapshot(query(r.fornecedoresCol, orderBy("nome","asc")), (snap) => {
        state.fornecedores = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hydrateFornecedores();
        rerender();
      }));

      listeners.push(onSnapshot(query(r.categoriasCol, orderBy("categoria","asc")), (snap) => {
        state.categorias = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hydrateCategorias();
        rerender();
      }));

      listeners.push(onSnapshot(query(r.lancamentosCol, orderBy("dt","desc")), (snap) => {
        state.lancamentos = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(query(r.rateiosCol, orderBy("dt","desc")), (snap) => {
        state.rateios = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(query(r.acertosCol, orderBy("createdAt","desc")), (snap) => {
        state.acertos = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(query(r.vendasCol, orderBy("createdAt","desc")), (snap) => {
        state.vendas = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hydrateVendasEncargos();
        rerender();
      }));

      listeners.push(onSnapshot(query(r.encargosCol, orderBy("nome","asc")), (snap) => {
        state.encargos = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hydrateVendasEncargos();
        rerender();
      }));

      listeners.push(onSnapshot(query(r.compromissosCol, orderBy("createdAt","desc")), (snap) => {
        state.compromissos = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(query(r.previstosCol, orderBy("createdAt","desc")), (snap) => {
        state.previstos = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        rerender();
      }));
    }

    // ========= VENDAS E ENCARGOS =========
    function hydrateVendasEncargos() {
      const units = state.unidades || [];
      const opts = units.map(u => `<option value="${u.id}">${u.nome}</option>`).join("");
      $("venda-unidade").innerHTML = opts;
      $("enc-unidade").innerHTML = opts;

      // vendas list
      const vendasList = $("vendas-list");
      if (!state.vendas.length) {
        vendasList.innerHTML = `<li class="text-slate-500">Nenhuma venda cadastrada.</li>`;
      } else {
        vendasList.innerHTML = state.vendas.map(v => {
          const un = units.find(u => u.id === v.unidadeId);
          return `
            <li class="bg-slate-100 rounded-lg p-2 flex justify-between items-center">
              <span><b>${un?.nome || "?"}</b> — ${v.tipo} — ${fmt(v.valor)} ${v.dtPrevista ? `(${v.dtPrevista})` : ""}</span>
              <button data-id="${v.id}" class="venda-del text-red-600 font-bold">X</button>
            </li>
          `;
        }).join("");
      }

      // encargos list
      const encargosList = $("encargos-list");
      if (!state.encargos.length) {
        encargosList.innerHTML = `<li class="text-slate-500">Nenhum encargo configurado.</li>`;
      } else {
        encargosList.innerHTML = state.encargos.map(e => {
          const un = units.find(u => u.id === e.unidadeId);
          const valorStr = e.tipo === "percent" ? `${(e.valor*100).toFixed(1)}%` : fmt(e.valor);
          const scopeStr = e.escopo === "obra" ? "Obra" : un?.nome || "Unidade";
          return `
            <li class="bg-slate-100 rounded-lg p-2 flex justify-between items-center">
              <span><b>${e.nome}</b> — ${valorStr} ${e.base} — ${scopeStr} ${!e.ativo ? "(inativo)" : ""}</span>
              <div class="flex gap-2">
                <button data-id="${e.id}" class="enc-toggle text-blue-600 font-bold">${e.ativo ? "Desativar" : "Ativar"}</button>
                <button data-id="${e.id}" class="enc-del text-red-600 font-bold">X</button>
              </div>
            </li>
          `;
        }).join("");
      }
    }

    // ========= SÓCIOS =========
    function hydrateSocios() {
      const a = state.config?.socioA || "Sócio A";
      const b = state.config?.socioB || "Sócio B";

      // inputs
      $("socio-a").value = a;
      $("socio-b").value = b;

      // labels % no lançamento
      $("lab-pa").textContent = `${a} (%):`;
      $("lab-pb").textContent = `${b} (%):`;

      // pagador
      const opts = [a,b].map(n => `<option value="${n}">${n}</option>`).join("");
      $("lanc-pagador").innerHTML = opts;

      // acerto selects
      $("acerto-de").innerHTML = opts;
      $("acerto-para").innerHTML = opts;
    }

    // ========= UNIDADES =========
    function hydrateUnidades() {
      const units = state.unidades || [];

      // default unidadeCurrent: Transitório se existir
      const trans = units.find(u => (u.nome||"").toLowerCase().includes("transit"));
      if (!unidadeCurrent || !units.some(u=>u.id===unidadeCurrent)) unidadeCurrent = trans?.id || units[0]?.id || "";

      // unidadeView
      if (unidadeView !== "OBRA_TODA" && !units.some(u=>u.id===unidadeView)) unidadeView = "OBRA_TODA";

      $("unidade-current").innerHTML = units.map(u => `<option value="${u.id}">${u.nome}</option>`).join("");
      $("unidade-current").value = unidadeCurrent;

      $("unidade-view").innerHTML = [
        `<option value="OBRA_TODA">Obra (Consolidado)</option>`,
        ...units.map(u => `<option value="${u.id}">${u.nome}</option>`)
      ].join("");
      $("unidade-view").value = unidadeView;

      hydrateRateioSelectors();
      localStorage.setItem("unidadeCurrent", unidadeCurrent);
      localStorage.setItem("unidadeView", unidadeView);
    }

    async function createUnidade() {
      if (!OBRA_ID) return alert("Selecione uma obra.");
      const nome = prompt("Nome da unidade (ex: Casa C / Edícula / Depósito):")?.trim();
      if (!nome) return;

      const r = refsFor(OBRA_ID);
      await addDoc(r.unidadesCol, { nome, createdAt: serverTimestamp() });
    }

    // ========= FORNECEDORES =========
    function hydrateFornecedores() {
      const sel = $("lanc-forn");
      sel.innerHTML = [`<option value="">Fornecedor (opcional)</option>`]
        .concat(state.fornecedores.map(f => `<option value="${f.id}">${f.nome}</option>`))
        .join("");

      // list
      $("forn-list").innerHTML = state.fornecedores.map(f => `
        <li class="flex items-center justify-between bg-slate-100 rounded-lg p-2">
          <span>${f.nome}</span>
          <button data-id="${f.id}" class="forn-del text-red-600 font-bold">X</button>
        </li>
      `).join("");
    }

    async function addFornecedor() {
      if (!OBRA_ID) return alert("Selecione uma obra.");
      const nome = $("forn-nome").value.trim();
      if (!nome) return;

      const r = refsFor(OBRA_ID);
      await addDoc(r.fornecedoresCol, { nome, createdAt: serverTimestamp() });
      $("forn-nome").value = "";
    }

    // ========= CATEGORIAS/GRUPO/SUB =========
    function hydrateCategorias() {
      const sel = $("lanc-catref");
      sel.innerHTML = [`<option value="">Cat/Grp/Sub (opcional)</option>`]
        .concat(state.categorias.map(c => {
          const label = `${c.categoria} / ${c.grupo} / ${c.subgrupo}`;
          return `<option value="${c.id}">${label}</option>`;
        }))
        .join("");

      $("cat-list").innerHTML = state.categorias.map(c => `
        <div class="bg-slate-100 rounded-lg p-2 flex items-center justify-between">
          <div class="text-xs">
            <div class="font-semibold">${c.categoria}</div>
            <div class="text-slate-600">${c.grupo} → ${c.subgrupo}</div>
          </div>
          <button data-id="${c.id}" class="cat-del text-red-600 font-bold">X</button>
        </div>
      `).join("");
    }

    async function addCategoria() {
      if (!OBRA_ID) return alert("Selecione uma obra.");
      const categoria = $("cat").value.trim();
      const grupo = $("grp").value.trim();
      const subgrupo = $("sub").value.trim();
      if (!categoria || !grupo || !subgrupo) return alert("Preencha categoria, grupo e subgrupo.");

      const r = refsFor(OBRA_ID);
      await addDoc(r.categoriasCol, { categoria, grupo, subgrupo, createdAt: serverTimestamp() });

      $("cat").value = ""; $("grp").value = ""; $("sub").value = "";
    }

    // ========= LANÇAMENTOS =========
    function computeTotais() {
      const totalPorUnidade = {};
      for (const u of state.unidades) totalPorUnidade[u.id] = 0;

      // soma lançamentos
      for (const l of state.lancamentos) {
        if (l.unidadeId) totalPorUnidade[l.unidadeId] = (totalPorUnidade[l.unidadeId] || 0) + (l.valor || 0);
      }

      // aplica rateios (modelo N destinos)
      for (const r of state.rateios) {
        const v = r.valor || 0;
        if (r.fromUnidadeId) totalPorUnidade[r.fromUnidadeId] = (totalPorUnidade[r.fromUnidadeId] || 0) - v;
        for (const d of (r.destinos || [])) {
          totalPorUnidade[d.unidadeId] = (totalPorUnidade[d.unidadeId] || 0) + v * (d.p || 0);
        }
      }

      const totalObra = Object.values(totalPorUnidade).reduce((s,n)=>s+n,0);
      const totalVisao = (unidadeView === "OBRA_TODA") ? totalObra : (totalPorUnidade[unidadeView] || 0);

      return { totalPorUnidade, totalObra, totalVisao };
    }

    async function addLancamento(e) {
      e.preventDefault();
      if (!OBRA_ID) return alert("Selecione uma obra.");
      if (!unidadeCurrent) return alert("Selecione uma unidade (casa).");

      const dt = $("lanc-dt").value;
      const desc = $("lanc-desc").value.trim();
      const valor = parseNum($("lanc-valor").value);
      const anexo = $("lanc-anexo").value.trim();

      if (!dt) return alert("Data obrigatória.");
      if (!desc) return alert("Descrição obrigatória.");
      if (valor <= 0) return alert("Valor deve ser positivo.");

      const pagador = $("lanc-pagador").value;
      const pA = Number($("lanc-pa").value);
      const pB = Number($("lanc-pb").value);

      if (Math.abs((pA + pB) - 1) > 0.001) return alert("pA + pB precisa dar 1.00 (100%).");

      const fornId = $("lanc-forn").value || "";
      const fornNome = state.fornecedores.find(f=>f.id===fornId)?.nome || "";

      const catId = $("lanc-catref").value || "";
      const catObj = state.categorias.find(c=>c.id===catId);

      const r = refsFor(OBRA_ID);
      await addDoc(r.lancamentosCol, {
        dt,
        desc,
        valor,
        unidadeId: unidadeCurrent,
        unidadeNome: state.unidades.find(u=>u.id===unidadeCurrent)?.nome || "",
        fornecedorId: fornId,
        fornecedorNome: fornNome,
        categoria: catObj?.categoria || "",
        grupo: catObj?.grupo || "",
        subgrupo: catObj?.subgrupo || "",
        anexo,
        pagador,
        pA,
        pB,
        createdBy: currentUser.email,
        createdAt: serverTimestamp()
      });

      $("lanc-desc").value = "";
      $("lanc-valor").value = "";
      $("lanc-anexo").value = "";
    }

    // ========= FORECAST - PREVISÃO DE LUCRO =========
    function sumByUnidade(items, keyUnidade, keyValor) {
      const map = {};
      for (const it of items || []) {
        const u = it[keyUnidade] || "SEM_UNIDADE";
        map[u] = (map[u] || 0) + (Number(it[keyValor]) || 0);
      }
      return map;
    }

    function computeForecast() {
      // receitas por unidade
      const receitaPorUn = sumByUnidade(state.vendas || [], "unidadeId", "valor");

      // custos por unidade (realizado)
      const custoRealPorUn = sumByUnidade(state.lancamentos || [], "unidadeId", "valor");

      // custos comprometidos
      const custoCompPorUn = sumByUnidade(state.compromissos || [], "unidadeId", "valor");

      // custo previsto (orçamento/premissas)
      const custoPrevPorUn = sumByUnidade(state.previstos || [], "unidadeId", "valor");

      // total custo previsto
      const custoTotalPorUn = {};
      const unidades = state.unidades || [];
      for (const u of unidades) {
        custoTotalPorUn[u.id] =
          (custoRealPorUn[u.id] || 0) +
          (custoCompPorUn[u.id] || 0) +
          (custoPrevPorUn[u.id] || 0);
      }

      // lucro bruto por unidade
      const lucroBrutoPorUn = {};
      for (const u of unidades) {
        lucroBrutoPorUn[u.id] = (receitaPorUn[u.id] || 0) - (custoTotalPorUn[u.id] || 0);
      }

      // encargos por unidade + obra
      const enc = state.encargos || [];
      const encargosPorUn = {};
      let encargosObra = 0;

      for (const e of enc) {
        if (!e.ativo) continue;

        const calc = (receita, custo, lucro) => {
          if (e.tipo === "fixed") return Number(e.valor) || 0;
          const pct = Number(e.valor) || 0;
          if (e.base === "receita") return receita * pct;
          if (e.base === "custo") return custo * pct;
          if (e.base === "lucro") return Math.max(0, lucro) * pct;
          return 0;
        };

        if (e.escopo === "obra") {
          const receitaObra = Object.values(receitaPorUn).reduce((s,n)=>s+n,0);
          const custoObra = Object.values(custoTotalPorUn).reduce((s,n)=>s+n,0);
          const lucroObra = receitaObra - custoObra;
          encargosObra += calc(receitaObra, custoObra, lucroObra);
        } else {
          const uid = e.unidadeId;
          if (!uid) continue;
          const receita = receitaPorUn[uid] || 0;
          const custo = custoTotalPorUn[uid] || 0;
          const lucro = lucroBrutoPorUn[uid] || 0;
          encargosPorUn[uid] = (encargosPorUn[uid] || 0) + calc(receita, custo, lucro);
        }
      }

      // lucro líquido
      const lucroLiquidoPorUn = {};
      for (const u of unidades) {
        lucroLiquidoPorUn[u.id] =
          (lucroBrutoPorUn[u.id] || 0) - (encargosPorUn[u.id] || 0);
      }

      const receitaObra = Object.values(receitaPorUn).reduce((s,n)=>s+n,0);
      const custoObra = Object.values(custoTotalPorUn).reduce((s,n)=>s+n,0);
      const lucroBrutoObra = receitaObra - custoObra;
      const encargosUn = Object.values(encargosPorUn).reduce((s,n)=>s+n,0);
      const encargosTotal = encargosUn + encargosObra;
      const lucroLiquidoObra = lucroBrutoObra - encargosTotal;

      return {
        receitaPorUn, custoTotalPorUn, lucroBrutoPorUn, encargosPorUn, lucroLiquidoPorUn,
        receitaObra, custoObra, lucroBrutoObra, encargosTotal, lucroLiquidoObra
      };
    }

    // ========= SÓCIOS - CÁLCULO =========
    function computeSocios() {
      const a = state.config?.socioA || "Sócio A";
      const b = state.config?.socioB || "Sócio B";

      // aplica visão (OBRA_TODA ou unidade específica)
      const lancs = (unidadeView === "OBRA_TODA")
        ? state.lancamentos
        : state.lancamentos.filter(l => l.unidadeId === unidadeView);

      const total = lancs.reduce((s,l)=>s+(l.valor||0),0);

      const pagoPorA = lancs.filter(l=>l.pagador===a).reduce((s,l)=>s+(l.valor||0),0);
      const pagoPorB = lancs.filter(l=>l.pagador===b).reduce((s,l)=>s+(l.valor||0),0);

      const devidoPorA = lancs.reduce((s,l)=>s+(l.valor||0)*(l.pA ?? 0.5),0);
      const devidoPorB = lancs.reduce((s,l)=>s+(l.valor||0)*(l.pB ?? 0.5),0);

      // acertos: por obra (normalmente acerto é "geral" da obra)
      const acertos = state.acertos || [];

      const recebA = acertos.filter(x=>x.para===a).reduce((s,x)=>s+(x.valor||0),0);
      const pagA   = acertos.filter(x=>x.de===a).reduce((s,x)=>s+(x.valor||0),0);
      const saldoA = (pagoPorA - devidoPorA) - recebA + pagA;

      const recebB = acertos.filter(x=>x.para===b).reduce((s,x)=>s+(x.valor||0),0);
      const pagB   = acertos.filter(x=>x.de===b).reduce((s,x)=>s+(x.valor||0),0);
      const saldoB = (pagoPorB - devidoPorB) - recebB + pagB;

      let equal = "Saldos zerados";
      if (saldoA > 0.01) equal = `${b} paga ${fmt(saldoA)} para ${a}`;
      else if (saldoB > 0.01) equal = `${a} paga ${fmt(saldoB)} para ${b}`;

      return { a,b,total,pagoPorA,pagoPorB,devidoPorA,devidoPorB,saldoA,saldoB,equal };
    }

    function renderAcertosUI() {
      const c = computeSocios();
      $("balanca").innerHTML = `
        <div class="font-semibold">Equalização (visão atual):</div>
        <div class="text-lg font-bold">${c.equal}</div>
        <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
          <div><b>${c.a}</b> saldo: ${fmt(c.saldoA)}</div>
          <div><b>${c.b}</b> saldo: ${fmt(c.saldoB)}</div>
        </div>
      `;

      const list = $("acertos-list");
      if (!state.acertos.length) {
        list.innerHTML = `<li class="text-slate-500">Nenhum acerto registrado.</li>`;
        return;
      }

      list.innerHTML = state.acertos.map(x => `
        <li class="bg-slate-100 rounded-lg p-2 flex justify-between items-center">
          <span><b>${x.de}</b> → <b>${x.para}</b> — ${fmt(x.valor)} ${x.anexo ? `<a class="text-blue-600 hover:underline" target="_blank" href="${x.anexo}">(anexo)</a>` : ""}</span>
          <button data-id="${x.id}" class="acerto-del text-red-600 font-bold">X</button>
        </li>
      `).join("");
    }

    // ========= RATEIO (N destinos) =========
    function hydrateRateioSelectors() {
      const opts = state.unidades.map(u => `<option value="${u.id}">${u.nome}</option>`).join("");
      $("rat-from").innerHTML = opts;
      // default from = Transitório se existir
      const trans = state.unidades.find(u => (u.nome||"").toLowerCase().includes("transit"));
      if (trans) $("rat-from").value = trans.id;
      renderRateioDests(); // garante 2 destinos por padrão
    }

    let rateioDests = []; // { unidadeId, p }

    function addRateioDestRow(defaultP=0.5) {
      const first = state.unidades[0]?.id || "";
      rateioDests.push({ unidadeId: first, p: defaultP });
      renderRateioDests();
    }

    function renderRateioDests() {
      if (!state.unidades.length) return;

      // se vazio, cria 2 destinos default
      if (rateioDests.length === 0 && state.unidades.length >= 2) {
        rateioDests = [
          { unidadeId: state.unidades[0].id, p: 0.5 },
          { unidadeId: state.unidades[1].id, p: 0.5 }
        ];
      }

      const unitOpts = (selectedId) =>
        state.unidades.map(u => `<option value="${u.id}" ${u.id===selectedId?"selected":""}>${u.nome}</option>`).join("");

      $("rat-dests").innerHTML = rateioDests.map((d, idx) => `
        <div class="grid grid-cols-1 md:grid-cols-12 gap-2 items-center">
          <select data-idx="${idx}" class="rat-u border rounded-lg p-2 md:col-span-7">
            ${unitOpts(d.unidadeId)}
          </select>
          <input data-idx="${idx}" class="rat-p border rounded-lg p-2 md:col-span-4" type="number" step="0.01" min="0" max="1" value="${d.p}">
          <button data-idx="${idx}" class="rat-del bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg p-2 md:col-span-1">X</button>
        </div>
      `).join("");

      updateRateioStatus();
    }

    function updateRateioStatus() {
      const sum = rateioDests.reduce((s,d)=>s+(Number(d.p)||0),0);
      $("rat-status").textContent = `Soma %: ${(sum*100).toFixed(1)}% (precisa dar 100%)`;
      $("rat-status").className = sum > 0.999 && sum < 1.001 ? "text-sm text-green-700" : "text-sm text-red-700";
    }

    async function saveRateio() {
      if (!OBRA_ID) return alert("Selecione uma obra.");
      const desc = $("rat-desc").value.trim();
      const valor = parseNum($("rat-valor").value);
      const fromUnidadeId = $("rat-from").value;

      if (!desc) return alert("Descrição do rateio obrigatória.");
      if (valor <= 0) return alert("Valor do rateio deve ser positivo.");
      if (!fromUnidadeId) return alert("Selecione a origem (de onde sai).");

      // valida soma e destinos
      const sum = rateioDests.reduce((s,d)=>s+(Number(d.p)||0),0);
      if (!(sum > 0.999 && sum < 1.001)) return alert("A soma dos percentuais precisa dar 100% (1.00).");

      // impede duplicar mesmo destino
      const ids = rateioDests.map(d=>d.unidadeId);
      const unique = new Set(ids);
      if (unique.size !== ids.length) return alert("Não repita a mesma unidade nos destinos.");

      const r = refsFor(OBRA_ID);
      await addDoc(r.rateiosCol, {
        dt: serverTimestamp(),
        desc,
        valor,
        fromUnidadeId,
        destinos: rateioDests.map(d => ({ unidadeId: d.unidadeId, p: Number(d.p)||0 })),
        createdBy: currentUser.email,
        createdAt: serverTimestamp()
      });

      $("rat-desc").value = "";
      $("rat-valor").value = "";
      // mantém destinos pro próximo rateio
    }

    // ========= RENDER =========
    function rerender() {
      const obraNome = state.obras.find(o=>o.id===OBRA_ID)?.nome || OBRA_ID;
      $("obra-status").textContent = OBRA_ID ? `Obra ativa: ${obraNome}` : "Selecione uma obra.";
      $("view-label").textContent = (unidadeView === "OBRA_TODA")
        ? "Obra (Consolidado)"
        : (state.unidades.find(u=>u.id===unidadeView)?.nome || "Unidade");

      // hint do lançamento
      const unidadeNome = state.unidades.find(u=>u.id===unidadeCurrent)?.nome || "";
      $("lanc-hint").textContent = OBRA_ID && unidadeNome ? `→ ${obraNome} / ${unidadeNome}` : "";

      // totals
      const { totalObra, totalVisao } = computeTotais();
      $("kpi-total-obra").textContent = fmt(totalObra);
      $("kpi-total").textContent = fmt(totalVisao);

      // dashboard forecast
      const fc = computeForecast();
      $("dash-receita").textContent = fmt(fc.receitaObra);
      $("dash-custo").textContent = fmt(fc.custoObra);
      $("dash-encargos").textContent = fmt(fc.encargosTotal);
      $("dash-lucro").textContent = fmt(fc.lucroLiquidoObra);
      const margem = fc.receitaObra > 0 ? (fc.lucroLiquidoObra / fc.receitaObra * 100) : 0;
      $("dash-margem").textContent = `${margem.toFixed(1)}% margem`;

      // ranking por unidade
      const unidades = state.unidades || [];
      const ranking = unidades.map(u => ({
        nome: u.nome,
        lucro: fc.lucroLiquidoPorUn[u.id] || 0,
        receita: fc.receitaPorUn[u.id] || 0,
        margem: (fc.receitaPorUn[u.id] || 0) > 0 ? ((fc.lucroLiquidoPorUn[u.id] || 0) / (fc.receitaPorUn[u.id] || 0) * 100) : 0
      })).sort((a,b) => b.margem - a.margem);

      $("dash-unidades").innerHTML = ranking.length > 0
        ? `<div class="font-semibold mb-1">Ranking por Margem:</div>` +
          ranking.map(r => `<span class="inline-block bg-slate-200 rounded px-2 py-1 mr-2 mb-1">${r.nome}: ${r.margem.toFixed(1)}%</span>`).join("")
        : "";

      // render acertos
      renderAcertosUI();

      // tabela com filtro de visão
      const list = (unidadeView === "OBRA_TODA")
        ? state.lancamentos
        : state.lancamentos.filter(l => l.unidadeId === unidadeView);

      if (list.length === 0) {
        $("lanc-tbody").innerHTML = `<tr><td colspan="10" class="p-4 text-center text-slate-500">Nenhum lançamento.</td></tr>`;
        return;
      }

      $("lanc-tbody").innerHTML = list.map(l => `
        <tr class="border-b">
          <td class="p-2">${l.dt || ""}</td>
          <td class="p-2">${l.unidadeNome || ""}</td>
          <td class="p-2">${l.desc || ""}</td>
          <td class="p-2">${l.fornecedorNome || ""}</td>
          <td class="p-2">${[l.categoria,l.grupo,l.subgrupo].filter(Boolean).join(" / ")}</td>
          <td class="p-2 font-semibold">${fmt(l.valor)}</td>
          <td class="p-2">${l.pagador || "—"}</td>
          <td class="p-2">${l.pA!==undefined ? `${(l.pA*100).toFixed(0)}/${(l.pB*100).toFixed(0)}` : "—"}</td>
          <td class="p-2">${l.anexo ? `<a class="text-blue-600 hover:underline" target="_blank" href="${l.anexo}">Ver</a>` : "—"}</td>
          <td class="p-2">
            <button data-id="${l.id}" class="lanc-del text-red-600 font-bold">X</button>
          </td>
        </tr>
      `).join("");
    }

    // ========= EVENTS =========
    $("login-btn").addEventListener("click", () => {
      signInWithPopup(auth, provider).catch(err => {
        $("login-msg").textContent = err.code === "auth/unauthorized-domain"
          ? "Domínio não autorizado no Firebase."
          : "Erro no login.";
      });
    });

    onAuthStateChanged(auth, (user) => {
      if (user && ALLOW_EMAILS.has(user.email)) {
        currentUser = user;
        $("login-screen").classList.add("hidden");
        $("app-wrapper").classList.remove("hidden");
        $("user-photo").src = user.photoURL || "";
        $("user-name").textContent = user.displayName || "";
        $("user-email").textContent = user.email || "";

        // default date
        $("lanc-dt").valueAsDate = new Date();

        setupObrasList();
      } else {
        if (user) signOut(auth);
        currentUser = null;
        teardownRealtime();
        $("app-wrapper").classList.add("hidden");
        $("login-screen").classList.remove("hidden");
      }
    });

    $("logout-btn").addEventListener("click", () => signOut(auth));

    $("obra-new-btn").addEventListener("click", createObra);
    $("obra-select").addEventListener("change", (e) => switchObra(e.target.value));

    $("unidade-new-btn").addEventListener("click", createUnidade);
    $("unidade-current").addEventListener("change", (e) => {
      unidadeCurrent = e.target.value;
      localStorage.setItem("unidadeCurrent", unidadeCurrent);
      rerender();
    });
    $("unidade-view").addEventListener("change", (e) => {
      unidadeView = e.target.value;
      localStorage.setItem("unidadeView", unidadeView);
      rerender();
    });

    $("socios-save").addEventListener("click", async () => {
      if (!OBRA_ID) return alert("Selecione uma obra.");
      const r = refsFor(OBRA_ID);
      await setDoc(r.configDoc, {
        socioA: $("socio-a").value.trim() || "Sócio A",
        socioB: $("socio-b").value.trim() || "Sócio B",
        updatedAt: serverTimestamp()
      }, { merge:true });
    });

    $("forn-add").addEventListener("click", addFornecedor);
    $("cat-add").addEventListener("click", addCategoria);
    $("lanc-form").addEventListener("submit", addLancamento);

    $("rat-add-dest").addEventListener("click", () => addRateioDestRow(0.25));
    $("rat-save").addEventListener("click", saveRateio);

    $("venda-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!OBRA_ID) return alert("Selecione uma obra.");

      const unidadeId = $("venda-unidade").value;
      const tipo = $("venda-tipo").value;
      const valor = parseNum($("venda-valor").value);
      const dtPrevista = $("venda-dt").value || null;

      if (!unidadeId) return alert("Selecione uma unidade.");
      if (valor <= 0) return alert("Valor deve ser positivo.");

      const r = refsFor(OBRA_ID);
      await addDoc(r.vendasCol, {
        unidadeId,
        tipo,
        valor,
        dtPrevista,
        dtVenda: null,
        obs: "",
        createdBy: currentUser.email,
        createdAt: serverTimestamp()
      });

      $("venda-valor").value = "";
      $("venda-dt").value = "";
    });

    $("encargo-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!OBRA_ID) return alert("Selecione uma obra.");

      const nome = $("enc-nome").value.trim();
      const tipo = $("enc-tipo").value;
      const valor = tipo === "percent" ? parseNum($("enc-valor").value) / 100 : parseNum($("enc-valor").value);
      const base = $("enc-base").value;
      const escopo = $("enc-escopo").value;
      const unidadeId = escopo === "unidade" ? $("enc-unidade").value : null;

      if (!nome) return alert("Nome do encargo obrigatório.");
      if (valor <= 0) return alert("Valor deve ser positivo.");
      if (escopo === "unidade" && !unidadeId) return alert("Selecione a unidade.");

      const r = refsFor(OBRA_ID);
      await addDoc(r.encargosCol, {
        nome,
        tipo,
        valor,
        base,
        escopo,
        unidadeId,
        ativo: true,
        createdBy: currentUser.email,
        createdAt: serverTimestamp()
      });

      $("enc-nome").value = "";
      $("enc-valor").value = "";
    });

    $("enc-escopo").addEventListener("change", (e) => {
      const isUnidade = e.target.value === "unidade";
      $("enc-unidade").classList.toggle("hidden", !isUnidade);
    });

    $("acerto-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!OBRA_ID) return alert("Selecione uma obra.");

      const de = $("acerto-de").value;
      const para = $("acerto-para").value;
      const valor = parseNum($("acerto-valor").value);
      const anexo = $("acerto-anexo").value.trim();

      if (de === para) return alert("De e Para devem ser diferentes.");
      if (valor <= 0) return alert("Valor do acerto deve ser positivo.");

      const r = refsFor(OBRA_ID);
      await addDoc(r.acertosCol, {
        de, para, valor, anexo,
        dt: serverTimestamp(),
        createdBy: currentUser.email,
        createdAt: serverTimestamp()
      });

      $("acerto-valor").value = "";
      $("acerto-anexo").value = "";
    });

    $("acerto-sugestao").addEventListener("click", () => {
      const c = computeSocios();
      if (c.saldoA > 0.01) {
        $("acerto-de").value = c.b;
        $("acerto-para").value = c.a;
        $("acerto-valor").value = c.saldoA.toFixed(2);
        alert(`Sugestão: ${c.b} paga ${fmt(c.saldoA)} para ${c.a}`);
      } else if (c.saldoB > 0.01) {
        $("acerto-de").value = c.a;
        $("acerto-para").value = c.b;
        $("acerto-valor").value = c.saldoB.toFixed(2);
        alert(`Sugestão: ${c.a} paga ${fmt(c.saldoB)} para ${c.b}`);
      } else {
        alert("Saldos já estão zerados!");
      }
    });

    // Delegation (delete)
    document.body.addEventListener("click", async (e) => {
      if (!OBRA_ID) return;
      const r = refsFor(OBRA_ID);

      if (e.target.classList.contains("forn-del")) {
        const id = e.target.dataset.id;
        await deleteDoc(doc(db, "obras", OBRA_ID, "fornecedores", id));
      }

      if (e.target.classList.contains("cat-del")) {
        const id = e.target.dataset.id;
        await deleteDoc(doc(db, "obras", OBRA_ID, "categorias", id));
      }

      if (e.target.classList.contains("lanc-del")) {
        const id = e.target.dataset.id;
        if (confirm("Excluir lançamento?")) {
          await deleteDoc(doc(db, "obras", OBRA_ID, "lancamentos", id));
        }
      }

      if (e.target.classList.contains("acerto-del")) {
        const id = e.target.dataset.id;
        if (confirm("Excluir acerto?")) {
          await deleteDoc(doc(db, "obras", OBRA_ID, "acertos", id));
        }
      }

      if (e.target.classList.contains("venda-del")) {
        const id = e.target.dataset.id;
        if (confirm("Excluir venda?")) {
          await deleteDoc(doc(db, "obras", OBRA_ID, "vendas", id));
        }
      }

      if (e.target.classList.contains("enc-del")) {
        const id = e.target.dataset.id;
        if (confirm("Excluir encargo?")) {
          await deleteDoc(doc(db, "obras", OBRA_ID, "encargos", id));
        }
      }

      if (e.target.classList.contains("enc-toggle")) {
        const id = e.target.dataset.id;
        const enc = state.encargos.find(e => e.id === id);
        if (enc) {
          await setDoc(doc(db, "obras", OBRA_ID, "encargos", id), {
            ...enc,
            ativo: !enc.ativo
          });
        }
      }

      // rateio dest updates
      if (e.target.classList.contains("rat-del")) {
        const idx = Number(e.target.dataset.idx);
        rateioDests.splice(idx, 1);
        renderRateioDests();
      }
    });

    // Inputs de rateio (delegation)
    document.body.addEventListener("input", (e) => {
      if (e.target.classList.contains("rat-p")) {
        const idx = Number(e.target.dataset.idx);
        rateioDests[idx].p = Number(e.target.value) || 0;
        updateRateioStatus();
      }
    });

    document.body.addEventListener("change", (e) => {
      if (e.target.classList.contains("rat-u")) {
        const idx = Number(e.target.dataset.idx);
        rateioDests[idx].unidadeId = e.target.value;
        updateRateioStatus();
      }
    });
  </script>
</body>
</html>
