<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>VG CONSTRUTORA ‚Äî Gestor de Obras</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { background:#f1f5f9; }
    .hidden { display:none !important; }
    .modal { background: rgba(0,0,0,.55); }
    .chip { font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#e2e8f0; }
    .btn { border-radius: 12px; font-weight: 700; padding: 10px 14px; }
    .btn-dark { background:#0f172a; color:white; }
    .btn-dark:hover { background:#334155; }
    .btn-danger { background:#dc2626; color:white; }
    .btn-danger:hover { background:#b91c1c; }
    .btn-soft { background:#e2e8f0; color:#0f172a; }
    .btn-soft:hover { background:#cbd5e1; }
    .btn-green { background:#059669; color:white; }
    .btn-green:hover { background:#047857; }
    .btn-indigo { background:#4f46e5; color:white; }
    .btn-indigo:hover { background:#4338ca; }
    .btn-purple { background:#7c3aed; color:white; }
    .btn-purple:hover { background:#6d28d9; }
    .muted { color:#64748b; }
    .card { background:white; border-radius: 18px; box-shadow: 0 10px 24px rgba(15,23,42,.08); }
    .table th { background:#f1f5f9; font-weight:800; }
    .table td,.table th { padding:10px; }
    .input { border:1px solid #cbd5e1; border-radius:12px; padding:10px; width:100%; }
    .select { border:1px solid #cbd5e1; border-radius:12px; padding:10px; width:100%; background:white; }
    .danger { color:#dc2626; font-weight: 800; }
    .ok { color:#059669; font-weight: 800; }
    
    /* Toast Notifications */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px; }
    .toast { padding: 16px 20px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,.3); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 12px; font-weight: 700; }
    .toast.success { background: #059669; color: white; }
    .toast.error { background: #dc2626; color: white; }
    .toast.warning { background: #f59e0b; color: white; }
    .toast.info { background: #3b82f6; color: white; }
    .toast.hiding { animation: slideOut 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
    
    /* Status Badges */
    .badge { padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 700; display: inline-block; }
    .badge-pendente { background: #fef3c7; color: #92400e; }
    .badge-pago { background: #d1fae5; color: #065f46; }
    .badge-atrasado { background: #fee2e2; color: #991b1b; }
    
    /* Alert Boxes */
    .alert { border-left: 4px solid; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    .alert-warning { border-color: #f59e0b; background: #fffbeb; }
    .alert-danger { border-color: #ef4444; background: #fef2f2; }
    .alert-success { border-color: #10b981; background: #ecfdf5; }
    
    /* Obra Select - Alto Contraste */
    #obra-select {
      background: #ffffff !important;
      color: #0f172a !important;
      border: 2px solid #cbd5e1 !important;
      font-weight: 600 !important;
      font-size: 14px !important;
    }
    #obra-select option {
      color: #0f172a !important;
      background: #ffffff !important;
      padding: 8px !important;
    }
    #obra-select:focus {
      outline: 2px solid #3b82f6 !important;
      outline-offset: 2px;
      border-color: #3b82f6 !important;
    }
    
    .empty-state { text-align:center; padding:60px 20px; color:#94a3b8; }
    .empty-state svg { width:80px; height:80px; margin:0 auto 20px; opacity:0.3; }
    
    /* Dark Mode Support */
    [data-theme="dark"] { background:#0f172a; color:#f1f5f9; }
    [data-theme="dark"] .card { background:#1e293b; box-shadow: 0 10px 24px rgba(0,0,0,.3); }
    [data-theme="dark"] .input, [data-theme="dark"] .select { background:#334155; border-color:#475569; color:#f1f5f9; }
    [data-theme="dark"] .table th { background:#1e293b; }
    [data-theme="dark"] .muted { color:#94a3b8; }
    
    /* Loading Skeleton */
    .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    /* Chart Containers */
    .chart-container { position: relative; height: 300px; width: 100%; }
    
    /* Hover Effects */
    .hover-card:hover { transform: translateY(-4px); transition: all 0.3s ease; box-shadow: 0 20px 40px rgba(15,23,42,.15); }
    
    /* Transitions */
    * { transition: background-color 0.2s ease, border-color 0.2s ease; }
  </style>
</head>

<body class="text-slate-800" data-theme="light">

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
    <div class="card p-8 max-w-md w-full text-center">
      <div class="text-4xl font-black mb-2">üèóÔ∏è VG CONSTRUTORA</div>
      <div class="text-slate-600 mb-8">Gestor de Obras - Sistema Completo</div>
      
      <button id="login-btn" class="btn btn-dark w-full mb-3 flex items-center justify-center gap-2">
        <svg width="20" height="20" viewBox="0 0 48 48">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
          <path fill="none" d="M0 0h48v48H0z"/>
        </svg>
        <span id="login-btn-text">Entrar com Google</span>
      </button>
      
      <div id="login-msg" class="text-xs text-slate-500 mt-4 min-h-[16px]"></div>
      
      <button id="login-redirect-btn" class="hidden text-sm text-blue-600 hover:underline mt-2">
        M√©todo alternativo (redirect)
      </button>
      
      <div id="debug-info" class="hidden mt-6 p-4 bg-slate-100 rounded text-left text-xs">
        <div class="font-bold mb-2">Debug Info:</div>
        <div id="debug-content" class="space-y-1"></div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden min-h-screen pb-20">
    
    <!-- Header -->
    <div class="bg-slate-900 text-white py-4 px-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="text-2xl font-black">üèóÔ∏è VG CONSTRUTORA</div>
        <select id="obra-select" class="select text-sm" onchange="switchObra()">
          <option value="">Carregando...</option>
        </select>
      </div>
      <div class="flex items-center gap-4">
        <button id="menu-obras" class="btn btn-soft text-sm">Obras</button>
        <button id="menu-unidades" class="btn btn-soft text-sm">Unidades</button>
        <button id="menu-fornecedores" class="btn btn-soft text-sm">Fornecedores</button>
        <button id="menu-categorias" class="btn btn-soft text-sm">Categorias</button>
        <button id="theme-toggle" class="btn btn-soft text-sm" title="Alternar tema">üåô</button>
        <button id="export-excel-btn" class="btn btn-green text-sm" title="Exportar Excel">üìä Excel</button>
        <div id="user-email" class="text-sm muted"></div>
        <button id="logout-btn" class="btn btn-danger text-sm">Sair</button>
      </div>
    </div>

    <!-- Content -->
    <div class="max-w-7xl mx-auto p-6">
      
      <!-- Alertas de Vencimento -->
      <div id="alertas-vencimento"></div>
      
      <!-- View Selector -->
      <div class="flex gap-3 mb-6 flex-wrap">
        <button class="btn btn-dark view-btn" data-view="DASHBOARD">üìä Dashboard</button>
        <button class="btn btn-soft view-btn" data-view="LANCAMENTOS">üí∞ Lan√ßamentos</button>
        <button class="btn btn-soft view-btn" data-view="RATEIOS">‚öñÔ∏è Rateios</button>
        <button class="btn btn-soft view-btn" data-view="RECEBIMENTOS">üíµ Recebimentos</button>
        <button class="btn btn-soft view-btn" data-view="ACERTOS">ü§ù Acertos S√≥cios</button>
        <button class="btn btn-soft view-btn" data-view="CONFIG">‚öôÔ∏è Config</button>
      </div>

      <!-- DASHBOARD VIEW -->
      <div id="view-DASHBOARD" class="view-content">
        
        <!-- Filtros Avan√ßados -->
        <div class="card p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
              <div class="text-xs muted mb-1">Per√≠odo</div>
              <select id="filter-periodo" class="select text-sm" onchange="rerender()">
                <option value="TODOS">Todos</option>
                <option value="MES_ATUAL">M√™s Atual</option>
                <option value="MES_ANTERIOR">M√™s Anterior</option>
                <option value="TRIMESTRE">√öltimo Trimestre</option>
                <option value="ANO">Ano Atual</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Status</div>
              <select id="filter-status" class="select text-sm" onchange="rerender()">
                <option value="TODOS">Todos</option>
                <option value="pendente">‚è≥ Pendente</option>
                <option value="pago">‚úÖ Pago</option>
                <option value="atrasado">üö® Atrasado</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Categoria</div>
              <select id="filter-categoria" class="select text-sm" onchange="rerender()">
                <option value="TODAS">Todas</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Fornecedor</div>
              <select id="filter-fornecedor" class="select text-sm" onchange="rerender()">
                <option value="TODOS">Todos</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Buscar</div>
              <input id="filter-text" type="text" class="input text-sm" placeholder="Descri√ß√£o..." oninput="rerender()" />
            </div>
          </div>
          <button id="filters-clear" class="btn btn-soft text-sm mt-3">Limpar Filtros</button>
        </div>

        <!-- KPIs -->
        <div id="kpis-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6"></div>
        
        <!-- M√©tricas de Rentabilidade -->
        <div id="roi-section" class="mb-6"></div>
        
        <!-- Gr√°ficos Interativos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üìà Evolu√ß√£o de Custos</div>
            <div class="chart-container">
              <canvas id="chart-custos-tempo"></canvas>
            </div>
          </div>
          <div class="card p-6">
            <div class="font-black text-lg mb-4">ü•ß Distribui√ß√£o por Categoria</div>
            <div class="chart-container">
              <canvas id="chart-categorias-pie"></canvas>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üí∞ Fluxo de Caixa Projetado</div>
            <div class="chart-container">
              <canvas id="chart-fluxo-caixa"></canvas>
            </div>
          </div>
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üìä ROI Comparativo</div>
            <div class="chart-container">
              <canvas id="chart-roi-bar"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Custo por m¬≤ -->
        <div id="custo-m2-section"></div>
        
        <!-- Analytics -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üèÜ Top 5 Categorias</div>
            <div id="top-categorias"></div>
          </div>
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üõí Top 5 Fornecedores</div>
            <div id="top-fornecedores"></div>
          </div>
        </div>
        
        <!-- Lucro Previsto -->
        <div class="card p-6 mt-6">
          <div class="font-black text-lg mb-4">üíé Lucro Previsto por S√≥cio</div>
          <div id="lucro-section"></div>
        </div>

        <!-- Equaliza√ß√£o -->
        <div class="card p-6 mt-6">
          <div class="font-black text-lg mb-4">‚öñÔ∏è Equaliza√ß√£o entre S√≥cios</div>
          <div id="equalizacao-section"></div>
        </div>

        <!-- Export -->
        <div class="mt-6 text-center">
          <button id="export-pdf-btn" class="btn btn-danger">üìÑ Exportar Dashboard PDF</button>
        </div>
      </div>

      <!-- LAN√áAMENTOS VIEW -->
      <div id="view-LANCAMENTOS" class="view-content hidden">
        <div class="card p-6 mb-6">
          <div class="font-black text-lg mb-4">üí∞ Novo Lan√ßamento</div>
          <form id="lanc-form">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Data *</div>
                <input id="lanc-data" type="date" class="input" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">Data Vencimento</div>
                <input id="lanc-vencimento" type="date" class="input" />
              </div>
              <div>
                <div class="text-xs muted mb-1">Data Compet√™ncia</div>
                <input id="lanc-competencia" type="date" class="input" />
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Unidade *</div>
                <select id="lanc-unidade" class="select" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div>
                <div class="text-xs muted mb-1">Categoria *</div>
                <select id="lanc-categoria" class="select" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Fornecedor *</div>
                <select id="lanc-fornecedor" class="select" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div>
                <div class="text-xs muted mb-1">Pagador (S√≥cio) *</div>
                <select id="lanc-pagador" class="select" required>
                  <option value="A">S√≥cio A</option>
                  <option value="B">S√≥cio B</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Valor * (R$)</div>
                <input id="lanc-valor" type="number" step="0.01" class="input" placeholder="1000.00" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">Status de Pagamento</div>
                <select id="lanc-status" class="select">
                  <option value="pendente">‚è≥ Pendente</option>
                  <option value="pago">‚úÖ Pago</option>
                  <option value="atrasado">üö® Atrasado</option>
                </select>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="text-xs muted mb-1">Descri√ß√£o *</div>
              <input id="lanc-descricao" type="text" class="input" placeholder="Ex: Material el√©trico..." required />
            </div>
            
            <div class="mb-4">
              <div class="text-xs muted mb-1">Link Comprovante (Google Drive)</div>
              <input id="lanc-comprovante" type="url" class="input" placeholder="https://drive.google.com/file/d/..." />
            </div>
            
            <div class="flex gap-3">
              <button type="submit" class="btn btn-green">üíæ Salvar Lan√ßamento</button>
              <button type="button" id="lanc-quick" class="btn btn-soft">‚ö° Atalho: Transit√≥rio</button>
            </div>
          </form>
        </div>

        <div class="card p-6">
          <div class="font-black text-lg mb-4">üìã Lista de Lan√ßamentos</div>
          <div id="lanc-list" class="overflow-x-auto"></div>
        </div>
      </div>

      <!-- RATEIOS VIEW -->
      <div id="view-RATEIOS" class="view-content hidden">
        <div class="card p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="font-black text-lg">‚öñÔ∏è Novo Rateio</div>
              <div class="text-xs muted mt-1">Distribua custos entre m√∫ltiplas obras/unidades</div>
            </div>
            <button id="rat-igual-btn" class="btn btn-purple text-sm">‚ö° Ratear Igualmente</button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <div class="text-xs muted mb-1">Data *</div>
              <input id="rat-data" type="date" class="input" required />
            </div>
            <div>
              <div class="text-xs muted mb-1">Data Vencimento</div>
              <input id="rat-vencimento" type="date" class="input" />
            </div>
            <div>
              <div class="text-xs muted mb-1">Status</div>
              <select id="rat-status" class="select">
                <option value="pendente">‚è≥ Pendente</option>
                <option value="pago">‚úÖ Pago</option>
                <option value="atrasado">üö® Atrasado</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <div class="text-xs muted mb-1">Fornecedor *</div>
              <select id="rat-fornecedor" class="select" required>
                <option value="">Selecione...</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Categoria *</div>
              <select id="rat-categoria" class="select" required>
                <option value="">Selecione...</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <div class="text-xs muted mb-1">Descri√ß√£o *</div>
              <input id="rat-descricao" type="text" class="input" placeholder="Ex: Conta de luz" required />
            </div>
            <div>
              <div class="text-xs muted mb-1">Valor Total * (R$)</div>
              <input id="rat-valor-total" type="number" step="0.01" class="input" placeholder="1000.00" required />
            </div>
          </div>
          
          <div class="mb-4">
            <div class="font-bold mb-2">Distribui√ß√£o por Unidade:</div>
            <div id="rat-dests" class="space-y-2"></div>
            <button id="rat-add-dest" class="btn btn-soft text-sm mt-2">+ Adicionar Destino</button>
          </div>
          
          <button id="rat-save" class="btn btn-green">üíæ Salvar Rateio</button>
        </div>

        <div class="card p-6">
          <div class="font-black text-lg mb-4">üìã Lista de Rateios</div>
          <div id="rat-list"></div>
        </div>
      </div>

      <!-- RECEBIMENTOS VIEW -->
      <div id="view-RECEBIMENTOS" class="view-content hidden">
        <div class="card p-6 mb-6">
          <div class="font-black text-lg mb-4">üíµ Novo Recebimento</div>
          <form id="receb-form">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Data *</div>
                <input id="receb-data" type="date" class="input" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">Unidade *</div>
                <select id="receb-unidade" class="select" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div>
                <div class="text-xs muted mb-1">Tipo *</div>
                <select id="receb-tipo" class="select" required>
                  <option value="sinal">Sinal</option>
                  <option value="parcela">Parcela</option>
                  <option value="quitacao">Quita√ß√£o</option>
                  <option value="outro">Outro</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Valor (R$) *</div>
                <input id="receb-valor" type="number" step="0.01" class="input" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">Forma de Pagamento *</div>
                <select id="receb-forma" class="select" required>
                  <option value="dinheiro">Dinheiro</option>
                  <option value="pix">PIX</option>
                  <option value="transferencia">Transfer√™ncia</option>
                  <option value="cheque">Cheque</option>
                  <option value="financiamento">Financiamento</option>
                </select>
              </div>
              <div>
                <div class="text-xs muted mb-1">üë§ Recebido por *</div>
                <select id="receb-recebido-por" class="select" required>
                  <option value="A">S√≥cio A</option>
                  <option value="B">S√≥cio B</option>
                  <option value="ambos">Ambos (50/50)</option>
                </select>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="text-xs muted mb-1">Observa√ß√µes</div>
              <textarea id="receb-obs" class="input" rows="2" placeholder="Ex: Sinal da venda, abater d√≠vida do Gustavo..."></textarea>
            </div>
            
            <button type="submit" class="btn btn-dark w-full">Adicionar Recebimento</button>
          </form>
        </div>

        <div class="card p-6">
          <div class="font-black text-lg mb-4">üìã Lista de Recebimentos</div>
          <div id="receb-list"></div>
        </div>
      </div>

      <!-- ACERTOS VIEW -->
      <div id="view-ACERTOS" class="view-content hidden">
        <div class="card p-6 mb-6">
          <div class="font-black text-lg mb-4">ü§ù Novo Acerto entre S√≥cios</div>
          <form id="acerto-form">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Data *</div>
                <input id="ac-data" type="date" class="input" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">De (S√≥cio) *</div>
                <select id="ac-de" class="select" required>
                  <option value="A">S√≥cio A</option>
                  <option value="B">S√≥cio B</option>
                </select>
              </div>
              <div>
                <div class="text-xs muted mb-1">Para (S√≥cio) *</div>
                <select id="ac-para" class="select" required>
                  <option value="A">S√≥cio A</option>
                  <option value="B">S√≥cio B</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Valor * (R$)</div>
                <input id="ac-valor" type="number" step="0.01" class="input" placeholder="1000.00" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">Descri√ß√£o *</div>
                <input id="ac-descricao" type="text" class="input" placeholder="Ex: Acerto m√™s 01/2026" required />
              </div>
            </div>
            
            <div class="flex gap-3">
              <button type="submit" class="btn btn-green">üíæ Salvar Acerto</button>
              <button type="button" id="acerto-sugerir" class="btn btn-indigo">üí° Sugerir Equaliza√ß√£o</button>
            </div>
          </form>
        </div>

        <div class="card p-6">
          <div class="font-black text-lg mb-4">üìã Hist√≥rico de Acertos</div>
          <div id="acerto-list"></div>
        </div>
      </div>

      <!-- CONFIG VIEW -->
      <div id="view-CONFIG" class="view-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üë• Configurar S√≥cios</div>
            <div class="mb-3">
              <div class="text-xs muted mb-1">Nome S√≥cio A</div>
              <input id="socio-a" type="text" class="input" placeholder="Ex: Jo√£o" />
            </div>
            <div class="mb-3">
              <div class="text-xs muted mb-1">Nome S√≥cio B</div>
              <input id="socio-b" type="text" class="input" placeholder="Ex: Maria" />
            </div>
            <button id="socios-save" class="btn btn-green">üíæ Salvar</button>
          </div>

          <div class="card p-6">
            <div class="font-black text-lg mb-4">üí∏ Dedu√ß√µes de Lucro</div>
            <div class="text-xs muted mb-3">Impostos, taxas e outras dedu√ß√µes que reduzem o lucro</div>
            
            <div class="space-y-2 mb-3">
              <input id="ded-nome" type="text" class="input text-sm" placeholder="Ex: IR, INSS, Corretagem" />
              
              <div class="grid grid-cols-2 gap-2">
                <select id="ded-tipo" class="input text-sm" onchange="toggleDeducaoBase()">
                  <option value="percentual">Percentual (%)</option>
                  <option value="fixo">Valor Fixo (R$)</option>
                </select>
                <select id="ded-base" class="input text-sm">
                  <option value="lucro">Sobre Lucro Bruto</option>
                  <option value="venda">Sobre Valor de Venda</option>
                </select>
              </div>
              
              <div class="grid grid-cols-12 gap-2">
                <div class="col-span-10">
                  <input id="ded-valor" type="number" step="0.01" class="input text-sm" placeholder="Ex: 15.00" />
                </div>
                <div class="col-span-2">
                  <button id="ded-create" class="btn btn-dark w-full text-sm">+</button>
                </div>
              </div>
            </div>
            
            <div id="ded-list" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODALS -->
  <div id="modal-obras" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="card p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-xl">üèóÔ∏è Obras</div>
        <button data-close="modal-obras" class="btn btn-soft">Fechar</button>
      </div>

      <div class="space-y-3 mb-4">
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-12">
            <div class="text-xs muted mb-1">Nome da Obra</div>
            <input id="obra-new-nome" class="input" placeholder="Ex: Obra Residencial X" />
          </div>
        </div>
        
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-6">
            <div class="text-xs muted mb-1">üìÖ Data de In√≠cio</div>
            <input id="obra-new-inicio" type="date" class="input" />
            <div class="text-xs muted mt-1">Quando come√ßou a constru√ß√£o</div>
          </div>
          <div class="col-span-6">
            <div class="text-xs muted mb-1">üìÖ Data de Recebimento</div>
            <input id="obra-new-recebimento" type="date" class="input" />
            <div class="text-xs muted mt-1">Quando espera receber/vendeu</div>
          </div>
        </div>
        
        <div class="flex items-end">
          <button id="obra-create" class="btn btn-dark w-full">Criar Obra</button>
        </div>
      </div>

      <div>
        <div class="font-bold mb-2">Lista de Obras:</div>
        <div id="obras-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <div id="modal-unidades" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="card p-6 w-full max-w-3xl">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-xl">üè† Unidades (Casas)</div>
        <button data-close="modal-unidades" class="btn btn-soft">Fechar</button>
      </div>

      <div class="space-y-3 mb-4">
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-4">
            <div class="text-xs muted mb-1">Nome</div>
            <input id="unid-new-nome" class="input" placeholder="Ex: Casa A" />
          </div>
          <div class="col-span-2">
            <div class="text-xs muted mb-1">√Årea (m¬≤)</div>
            <input id="unid-new-area" type="number" step="0.01" class="input" placeholder="120.00" />
          </div>
          <div class="col-span-3">
            <div class="text-xs muted mb-1">Status</div>
            <select id="unid-new-status" class="input">
              <option value="disponivel">Dispon√≠vel</option>
              <option value="reservada">Reservada</option>
              <option value="vendida">Vendida</option>
            </select>
          </div>
          <div class="col-span-3">
            <div class="text-xs muted mb-1">üìã Propriet√°rio</div>
            <select id="unid-new-proprietario" class="input">
              <option value="ambos">Ambos (50/50)</option>
              <option value="A">S√≥cio A</option>
              <option value="B">S√≥cio B</option>
            </select>
          </div>
        </div>
        
        <div class="mb-3">
          <div class="text-xs font-bold text-gray-700 mb-2">üí∞ Valores Financeiros</div>
          <div class="grid grid-cols-12 gap-3">
            <div class="col-span-6">
              <div class="text-xs muted mb-1">VGV Previsto (R$) *</div>
              <input id="unid-new-vgv" type="number" step="0.01" class="input" placeholder="450000.00" />
              <div class="text-xs muted mt-1">Expectativa inicial de venda</div>
            </div>
            <div class="col-span-6">
              <div class="text-xs muted mb-1">Valor Real de Venda (R$)</div>
              <input id="unid-new-venda" type="number" step="0.01" class="input" placeholder="Preencha ap√≥s vender" />
              <div class="text-xs muted mt-1">Valor confirmado da negocia√ß√£o</div>
            </div>
          </div>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded p-3 text-xs text-blue-800">
          üí° <strong>Propriet√°rio:</strong> Indica em nome de quem a casa est√° registrada. Isso afeta a equaliza√ß√£o:
          custos e recebimentos seguem o propriet√°rio.
        </div>
        
        <button id="unid-create" class="btn btn-dark w-full">Criar Unidade</button>
      </div>

      <div>
        <div class="font-bold mb-2">Lista de Unidades:</div>
        <div id="unidades-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <div id="modal-fornecedores" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="card p-6 w-full max-w-3xl">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-xl">üõí Fornecedores</div>
        <button data-close="modal-fornecedores" class="btn btn-soft">Fechar</button>
      </div>

      <div class="grid grid-cols-12 gap-3 mb-4">
        <div class="col-span-4">
          <div class="text-xs muted mb-1">Nome</div>
          <input id="forn-nome" class="input" placeholder="Ex: Dep√≥sito X" />
        </div>
        <div class="col-span-3">
          <div class="text-xs muted mb-1">Contato</div>
          <input id="forn-contato" class="input" placeholder="(11) 99999-9999" />
        </div>
        <div class="col-span-3">
          <div class="text-xs muted mb-1">CNPJ/CPF</div>
          <input id="forn-doc" class="input" placeholder="Opcional" />
        </div>
        <div class="col-span-2 flex items-end">
          <button id="forn-create" class="btn btn-dark w-full">+</button>
        </div>
      </div>

      <div>
        <div class="font-bold mb-2">Lista de Fornecedores:</div>
        <div id="fornecedores-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <div id="modal-categorias" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="card p-6 w-full max-w-3xl">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-xl">üìÇ Categorias</div>
        <button data-close="modal-categorias" class="btn btn-soft">Fechar</button>
      </div>

      <div class="grid grid-cols-12 gap-3 mb-4">
        <div class="col-span-5">
          <div class="text-xs muted mb-1">Nome</div>
          <input id="cat-nome" class="input" placeholder="Ex: Material El√©trico" />
        </div>
        <div class="col-span-3">
          <div class="text-xs muted mb-1">Grupo</div>
          <input id="cat-grupo" class="input" placeholder="Ex: Materiais" />
        </div>
        <div class="col-span-2">
          <div class="text-xs muted mb-1">Cor</div>
          <input id="cat-cor" type="color" class="input" value="#3b82f6" />
        </div>
        <div class="col-span-2 flex items-end">
          <button id="cat-create" class="btn btn-dark w-full">+</button>
        </div>
      </div>

      <div>
        <div class="font-bold mb-2">Lista de Categorias:</div>
        <div id="categorias-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase imports
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js");
    const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js");
    const { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, getDocs, onSnapshot, query, where, orderBy, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCOrMx8Hv2qRkoIBwBBVq4V2DONUa7T0lU",
      authDomain: "qd20-lt2-a-b.firebaseapp.com",
      projectId: "qd20-lt2-a-b",
      storageBucket: "qd20-lt2-a-b.firebasestorage.app",
      messagingSenderId: "648174167866",
      appId: "1:648174167866:web:98fb10be18b73fcc7a9203"
    };

    // Initialize
    console.log("üî• Inicializando Firebase...");
    console.log("Project ID:", firebaseConfig.projectId);
    console.log("Auth Domain:", firebaseConfig.authDomain);
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    
    console.log("‚úì Firebase inicializado");
    console.log("‚úì Auth configurado");
    console.log("‚úì Firestore configurado");

    // Whitelist
    const ALLOWED_EMAILS = ["viictor.castro@gmail.com", "gcm.conceicao@gmail.com"];

    // Utils
    const $ = (id) => document.getElementById(id);
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'info') {
      const container = $('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úì',
        error: '‚úó',
        warning: '‚ö†',
        info: '‚Ñπ'
      };
      
      toast.innerHTML = `<span style="font-size: 20px;">${icons[type]}</span><span>${escapeHtml(message)}</span>`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, 3500);
    }

    // Helper para desabilitar base quando valor √© fixo
    function toggleDeducaoBase() {
      const tipo = $("ded-tipo").value;
      const baseSelect = $("ded-base");
      
      if (tipo === "fixo") {
        baseSelect.disabled = true;
        baseSelect.classList.add("opacity-50", "cursor-not-allowed");
      } else {
        baseSelect.disabled = false;
        baseSelect.classList.remove("opacity-50", "cursor-not-allowed");
      }
    }

    // Theme Toggle
    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const btn = $("theme-toggle");
      btn.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      
      // Recriar gr√°ficos com tema novo
      if (VIEW === "DASHBOARD") {
        renderCharts();
      }
    }

    // Export to Excel
    async function exportToExcel() {
      if (typeof XLSX === 'undefined') {
        showToast('Biblioteca Excel n√£o carregada', 'error');
        return;
      }

      const wb = XLSX.utils.book_new();
      
      // Lan√ßamentos
      const lancData = state.lancamentos.map(l => ({
        'Data': l.data,
        'Descri√ß√£o': l.descricao,
        'Categoria': state.categorias.find(c => c.id === l.categoriaId)?.nome || '',
        'Fornecedor': state.fornecedores.find(f => f.id === l.fornecedorId)?.nome || '',
        'Unidade': state.unidades.find(u => u.id === l.unidadeId)?.nome || '',
        'Valor': l.valor,
        'Status': l.status || 'pendente'
      }));
      const wsLanc = XLSX.utils.json_to_sheet(lancData);
      XLSX.utils.book_append_sheet(wb, wsLanc, 'Lan√ßamentos');
      
      // Rateios
      const ratData = state.rateios.map(r => ({
        'Data': r.data,
        'Descri√ß√£o': r.descricao,
        'Categoria': state.categorias.find(c => c.id === r.categoriaId)?.nome || '',
        'Fornecedor': state.fornecedores.find(f => f.id === r.fornecedorId)?.nome || '',
        'Valor Total': r.valorTotal,
        'Status': r.status || 'pendente'
      }));
      const wsRat = XLSX.utils.json_to_sheet(ratData);
      XLSX.utils.book_append_sheet(wb, wsRat, 'Rateios');
      
      // Recebimentos
      const recData = state.recebimentos.map(r => ({
        'Data': r.data,
        'Unidade': state.unidades.find(u => u.id === r.unidadeId)?.nome || '',
        'Tipo': r.tipo,
        'Forma Pagamento': r.formaPagamento,
        'Valor': r.valor,
        'Observa√ß√£o': r.observacao || ''
      }));
      const wsRec = XLSX.utils.json_to_sheet(recData);
      XLSX.utils.book_append_sheet(wb, wsRec, 'Recebimentos');
      
      // Dashboard Summary
      const lucroData = computeLucro();
      const summary = [{
        'Indicador': 'Custo Total',
        'Valor': lucroData.custoTotal
      }, {
        'Indicador': 'VGV',
        'Valor': lucroData.vgvTotal
      }, {
        'Indicador': 'Lucro Bruto',
        'Valor': lucroData.lucroBruto
      }, {
        'Indicador': 'Lucro L√≠quido',
        'Valor': lucroData.lucroLiquido
      }];
      const wsSummary = XLSX.utils.json_to_sheet(summary);
      XLSX.utils.book_append_sheet(wb, wsSummary, 'Dashboard');
      
      const obra = state.obras.find(o => o.id === OBRA_ID);
      const filename = `VG_${obra?.nome || 'Obra'}_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, filename);
      showToast('Excel exportado com sucesso!', 'success');
    }

    // Global state
    let VIEW = "DASHBOARD";
    let OBRA_ID = null;
    let filterText = "";
    let filterCategoria = "TODAS";
    let filterFornecedor = "TODOS";
    let filterPeriodo = "TODOS";
    let filterStatus = "TODOS";
    let rateioDestCount = 0;

    const state = {
      user: null,
      obras: [],
      unidades: [],
      categorias: [],
      fornecedores: [],
      deducoes: [],
      lancamentos: [],
      rateios: [],
      recebimentos: [],
      acertos: [],
      config: {}
    };

    const listeners = [];

    // Firestore refs
    function refs(obraId) {
      return {
        obrasCol: collection(db, "obras"),
        obraDoc: doc(db, "obras", obraId),
        unidadesCol: collection(db, "obras", obraId, "unidades"),
        categoriasCol: collection(db, "obras", obraId, "categorias"),
        fornecedoresCol: collection(db, "obras", obraId, "fornecedores"),
        deducoesCol: collection(db, "obras", obraId, "deducoes"),
        lancamentosCol: collection(db, "obras", obraId, "lancamentos"),
        rateiosCol: collection(db, "obras", obraId, "rateios"),
        recebimentosCol: collection(db, "obras", obraId, "recebimentos"),
        acertosCol: collection(db, "obras", obraId, "acertos"),
        configDoc: doc(db, "obras", obraId, "config", "main")
      };
    }

    // AUTH
    onAuthStateChanged(auth, async (user) => {
      console.log("‚Üí Auth state:", user?.email || "deslogado");
      
      if (user) {
        if (!ALLOWED_EMAILS.includes(user.email)) {
          alert("‚õî Acesso negado. E-mail n√£o autorizado.");
          await signOut(auth);
          return;
        }
        
        state.user = user;
        $("user-email").textContent = user.email;
        $("login-screen").classList.add("hidden");
        $("app").classList.remove("hidden");
        
        subscribeObrasList();
        setupEventListeners();
        
        // Inicializar estado do formul√°rio de dedu√ß√µes
        toggleDeducaoBase();
        
        // Restaurar tema salvo
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        $("theme-toggle").textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        
        showToast(`Bem-vindo, ${user.email}!`, 'success');
      } else {
        state.user = null;
        $("login-screen").classList.remove("hidden");
        $("app").classList.add("hidden");
        listeners.forEach(unsub => unsub());
        listeners.length = 0;
      }
    });

    // Check redirect result
    getRedirectResult(auth).then((result) => {
      if (result?.user) {
        console.log("‚úì Login via redirect:", result.user.email);
      }
    }).catch((error) => {
      console.error("‚úó Erro redirect result:", error);
    });

    // Setup login buttons (needs to be before auth state changes)
    $("login-btn").onclick = handleLogin;
    $("login-redirect-btn").onclick = async () => {
      console.log("üîê Login via redirect");
      $("login-msg").textContent = "Redirecionando...";
      try {
        await signInWithRedirect(auth, provider);
      } catch (err) {
        console.error("‚úó Erro redirect:", err);
        showLoginError(err);
      }
    };

    function setupEventListeners() {
      // Modal triggers
      $("menu-obras").onclick = () => openModal("modal-obras");
      $("menu-unidades").onclick = () => openModal("modal-unidades");
      $("menu-fornecedores").onclick = () => openModal("modal-fornecedores");
      $("menu-categorias").onclick = () => openModal("modal-categorias");

      // View switching
      document.querySelectorAll(".view-btn").forEach(btn => {
        btn.onclick = () => {
          VIEW = btn.dataset.view;
          localStorage.setItem("view", VIEW);
          rerender();
        };
      });

      // Filters
      $("filters-clear").onclick = () => {
        $("filter-text").value = "";
        $("filter-categoria").value = "TODAS";
        $("filter-fornecedor").value = "TODOS";
        $("filter-periodo").value = "TODOS";
        $("filter-status").value = "TODOS";
        filterText = "";
        filterCategoria = "TODAS";
        filterFornecedor = "TODOS";
        filterPeriodo = "TODOS";
        filterStatus = "TODOS";
        rerender();
      };

      // CRUD buttons
      $("obra-create").onclick = createObra;
      $("unid-create").onclick = createUnidade;
      $("forn-create").onclick = createFornecedor;
      $("cat-create").onclick = createCategoria;
      $("ded-create").onclick = createDeducao;

      // Dedu√ß√µes: controlar estado da base quando tipo mudar
      $("ded-tipo").onchange = toggleDeducaoBase;

      $("socios-save").onclick = saveSocios;
      $("logout-btn").onclick = () => signOut(auth);

      // Forms
      $("lanc-form").onsubmit = addLancamento;
      $("lanc-quick").onclick = () => {
        const trans = state.unidades.find(u => (u.nome||"").toLowerCase().includes("transit"));
        if (trans) $("lanc-unidade").value = trans.id;
      };

      $("rat-add-dest").onclick = rateioAddDest;
      $("rat-save").onclick = addRateio;
      $("rat-igual-btn").onclick = ratearIgualmente;

      $("receb-form").onsubmit = addRecebimento;

      $("acerto-form").onsubmit = addAcerto;
      $("acerto-sugerir").onclick = () => {
        const eq = computeEqualizacao();
        if (eq && eq.mensagem) {
          showToast(eq.mensagem, 'info');
        } else {
          showToast('‚úÖ Saldos equalizados! N√£o h√° acertos pendentes.', 'success');
        }
      };

      $("export-pdf-btn").onclick = exportPDF;

      // Theme toggle
      $("theme-toggle").onclick = toggleTheme;
      
      // Excel export
      $("export-excel-btn").onclick = exportToExcel;

      // Modal close
      document.querySelectorAll("[data-close]").forEach(btn => {
        btn.onclick = () => closeModal(btn.dataset.close);
      });
    }

    async function handleLogin() {
      console.log("üîê Tentando login...");
      $("login-btn-text").textContent = "Conectando...";
      $("login-msg").textContent = "";
      
      try {
        console.log("‚Üí Tentando popup...");
        const result = await signInWithPopup(auth, provider);
        console.log("‚úì Login OK:", result.user.email);
        $("login-msg").textContent = "‚úì Login realizado!";
      } catch (err) {
        console.error("‚úó Erro popup:", err.code);
        $("login-btn-text").textContent = "Entrar com Google";
        
        if (err.code === "auth/popup-blocked" || err.code === "auth/popup-closed-by-user" || err.code === "auth/cancelled-popup-request") {
          console.log("‚Üí Popup falhou, tentando redirect...");
          $("login-redirect-btn").classList.remove("hidden");
          try {
            await signInWithRedirect(auth, provider);
            return;
          } catch (err2) {
            showLoginError(err2);
            return;
          }
        }
        
        showLoginError(err);
      }
    }

    function showLoginError(err) {
      let msg = "";
      let debugInfo = "";
      
      if (err.code === "auth/api-key-not-valid.-please-pass-a-valid-api-key.") {
        msg = "‚ö†Ô∏è API Key inv√°lida. Problema de configura√ß√£o do Firebase.";
        debugInfo = "A API key precisa ser verificada no Firebase Console > Project Settings > General";
      } else if (err.code === "auth/unauthorized-domain") {
        msg = "‚ö†Ô∏è Dom√≠nio n√£o autorizado no Firebase.";
        debugInfo = `Adicione "${window.location.hostname}" em Authentication > Settings`;
      } else if (err.code === "auth/operation-not-allowed") {
        msg = "‚ö†Ô∏è Google Sign-In n√£o habilitado.";
      } else if (err.code === "auth/popup-blocked") {
        msg = "‚ö†Ô∏è Popup bloqueado. Use o bot√£o alternativo.";
      } else if (err.code === "auth/popup-closed-by-user") {
        msg = "Login cancelado.";
      } else {
        msg = `Erro: ${err.code || "desconhecido"}`;
        debugInfo = err.message;
      }
      
      $("login-msg").textContent = msg;
      $("login-msg").className = "text-xs text-red-600 mt-4 min-h-[16px]";
      
      $("debug-content").innerHTML = `
        <div>‚Ä¢ Code: ${err.code || 'N/A'}</div>
        <div>‚Ä¢ Message: ${err.message || 'N/A'}</div>
        ${debugInfo ? `<div class="mt-2 font-bold">‚Üí ${debugInfo}</div>` : ''}
      `;
      $("debug-info").classList.remove("hidden");
    }

    // SUBSCRIPTIONS
    function subscribeObrasList() {
      const r = refs("dummy").obrasCol;
      listeners.push(onSnapshot(r, (snap) => {
        console.log("üìä Obras carregadas:", snap.size);
        state.obras = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        hydrateObrasSelect();
      }, (err) => {
        console.error("‚ùå Erro ao carregar obras:", err);
        showToast("Erro ao carregar obras", "error");
        $("obra-select").innerHTML = `<option value="">Erro ao carregar</option>`;
      }));
    }

    function hydrateObrasSelect() {
      const sel = $("obra-select");
      if (!state.obras.length) {
        sel.innerHTML = `<option value="">Nenhuma obra</option>`;
        return;
      }
      sel.innerHTML = state.obras.map(o => `<option value="${o.id}">${escapeHtml(o.nome || o.id)}</option>`).join("");
      if (!OBRA_ID) OBRA_ID = state.obras[0].id;
      sel.value = OBRA_ID;
      subscribeObra();
    }

    function subscribeObra() {
      if (!OBRA_ID) return;
      
      // Clear previous listeners
      while (listeners.length > 1) {
        const unsub = listeners.pop();
        unsub();
      }

      const r = refs(OBRA_ID);

      listeners.push(onSnapshot(r.unidadesCol, (snap) => {
        state.unidades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.categoriasCol, (snap) => {
        state.categorias = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.fornecedoresCol, (snap) => {
        state.fornecedores = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.deducoesCol, (snap) => {
        state.deducoes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.lancamentosCol, (snap) => {
        state.lancamentos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.rateiosCol, (snap) => {
        state.rateios = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.recebimentosCol, (snap) => {
        state.recebimentos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.acertosCol, (snap) => {
        state.acertos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.configDoc, (snap) => {
        state.config = snap.exists() ? snap.data() : {};
        rerender();
      }));

      rerender();
    }

    function switchObra() {
      OBRA_ID = $("obra-select").value;
      if (OBRA_ID) {
        localStorage.setItem("obraId", OBRA_ID);
        subscribeObra();
      }
    }

    // RENDER
    function rerender() {
      if (!OBRA_ID || !state.user) return;

      // Update view buttons
      document.querySelectorAll(".view-btn").forEach(btn => {
        if (btn.dataset.view === VIEW) {
          btn.classList.remove("btn-soft");
          btn.classList.add("btn-dark");
        } else {
          btn.classList.remove("btn-dark");
          btn.classList.add("btn-soft");
        }
      });

      // Show/hide views
      document.querySelectorAll(".view-content").forEach(el => {
        el.classList.add("hidden");
      });
      $(`view-${VIEW}`)?.classList.remove("hidden");

      // Read filters
      filterText = $("filter-text")?.value?.trim().toLowerCase() || "";
      filterCategoria = $("filter-categoria")?.value || "TODAS";
      filterFornecedor = $("filter-fornecedor")?.value || "TODOS";
      filterPeriodo = $("filter-periodo")?.value || "TODOS";
      filterStatus = $("filter-status")?.value || "TODOS";

      // Render specific view
      if (VIEW === "DASHBOARD") {
        renderDashboard();
      } else if (VIEW === "LANCAMENTOS") {
        renderLancamentosView();
      } else if (VIEW === "RATEIOS") {
        renderRateiosView();
      } else if (VIEW === "RECEBIMENTOS") {
        renderRecebimentosView();
      } else if (VIEW === "ACERTOS") {
        renderAcertosView();
      } else if (VIEW === "CONFIG") {
        renderConfigView();
      }

      // Render modals
      renderObrasModal();
      renderUnidadesModal();
      renderFornecedoresModal();
      renderCategoriasModal();
    }

    // FILTER FUNCTIONS
    function getLancamentosFiltrados() {
      let lancs = [...state.lancamentos];

      // Per√≠odo
      if (filterPeriodo !== "TODOS") {
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const inicioMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
        const inicioTrimestre = new Date(hoje.getFullYear(), hoje.getMonth() - 3, 1);
        const inicioAno = new Date(hoje.getFullYear(), 0, 1);

        lancs = lancs.filter(l => {
          const dataLanc = new Date(l.dataCompetencia || l.data);
          switch(filterPeriodo) {
            case "MES_ATUAL": return dataLanc >= inicioMes;
            case "MES_ANTERIOR": return dataLanc >= inicioMesAnterior && dataLanc < inicioMes;
            case "TRIMESTRE": return dataLanc >= inicioTrimestre;
            case "ANO": return dataLanc >= inicioAno;
            default: return true;
          }
        });
      }

      // Status
      if (filterStatus !== "TODOS") {
        lancs = lancs.filter(l => (l.status || "pendente") === filterStatus);
      }

      // Categoria
      if (filterCategoria !== "TODAS") {
        lancs = lancs.filter(l => l.categoriaId === filterCategoria);
      }

      // Fornecedor
      if (filterFornecedor !== "TODOS") {
        lancs = lancs.filter(l => l.fornecedorId === filterFornecedor);
      }

      // Busca textual
      if (filterText) {
        lancs = lancs.filter(l => {
          const forn = state.fornecedores.find(f => f.id === l.fornecedorId)?.nome || "";
          const cat = state.categorias.find(c => c.id === l.categoriaId)?.nome || "";
          return forn.toLowerCase().includes(filterText) ||
                 cat.toLowerCase().includes(filterText) ||
                 (l.descricao || "").toLowerCase().includes(filterText);
        });
      }

      return lancs;
    }

    function getRateiosFiltrados() {
      let rats = [...state.rateios];

      // Per√≠odo
      if (filterPeriodo !== "TODOS") {
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const inicioMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
        const inicioTrimestre = new Date(hoje.getFullYear(), hoje.getMonth() - 3, 1);
        const inicioAno = new Date(hoje.getFullYear(), 0, 1);

        rats = rats.filter(r => {
          const dataRat = new Date(r.dataCompetencia || r.data);
          switch(filterPeriodo) {
            case "MES_ATUAL": return dataRat >= inicioMes;
            case "MES_ANTERIOR": return dataRat >= inicioMesAnterior && dataRat < inicioMes;
            case "TRIMESTRE": return dataRat >= inicioTrimestre;
            case "ANO": return dataRat >= inicioAno;
            default: return true;
          }
        });
      }

      // Status
      if (filterStatus !== "TODOS") {
        rats = rats.filter(r => (r.status || "pendente") === filterStatus);
      }

      return rats;
    }

    // DASHBOARD
    function renderDashboard() {
      renderAlertasVencimento();
      
      const lancs = getLancamentosFiltrados();
      const rats = getRateiosFiltrados();
      
      const custoTotal = computeCustoTotal(lancs, rats);
      const lucroData = computeLucro(lancs, rats);
      const equalizacao = computeEqualizacao();
      
      // Calcular recebimentos
      const totalRecebido = state.recebimentos.reduce((sum, r) => sum + (r.valor || 0), 0);
      const aReceber = lucroData.vgvTotal - totalRecebido;
      const fluxoCaixa = totalRecebido - custoTotal;

      // KPIs
      const kpisHTML = `
        <div class="card p-6">
          <div class="text-xs muted mb-2">üí∞ CUSTO TOTAL</div>
          <div class="text-3xl font-black">R$ ${custoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
        <div class="card p-6">
          <div class="text-xs muted mb-2">üíé VGV PREVISTO</div>
          <div class="text-3xl font-black">R$ ${lucroData.vgvTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
        <div class="card p-6">
          <div class="text-xs muted mb-2">üíµ RECEBIDO</div>
          <div class="text-3xl font-black ok">R$ ${totalRecebido.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
          <div class="text-xs muted mt-2">A receber: R$ ${aReceber.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
        <div class="card p-6">
          <div class="text-xs muted mb-2">üè¶ FLUXO DE CAIXA</div>
          <div class="text-3xl font-black ${fluxoCaixa >= 0 ? 'ok' : 'danger'}">R$ ${fluxoCaixa.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
          <div class="text-xs muted mt-2">${fluxoCaixa >= 0 ? 'Positivo' : 'Negativo'}</div>
        </div>
        <div class="card p-6">
          <div class="text-xs muted mb-2">üìä LUCRO BRUTO</div>
          <div class="text-3xl font-black ${lucroData.lucroBruto >= 0 ? 'ok' : 'danger'}">R$ ${lucroData.lucroBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
        <div class="card p-6">
          <div class="text-xs muted mb-2">üíµ LUCRO L√çQUIDO</div>
          <div class="text-3xl font-black ${lucroData.lucroLiquido >= 0 ? 'ok' : 'danger'}">R$ ${lucroData.lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
      `;
      $("kpis-grid").innerHTML = kpisHTML;

      // M√©tricas de Rentabilidade
      renderROISection(custoTotal, lucroData, totalRecebido);

      // Gr√°ficos Interativos
      renderCharts();

      // Custo por m¬≤
      renderCustoM2(lancs, rats);

      // Top categorias
      renderTopCategorias(lancs, rats);

      // Top fornecedores
      renderTopFornecedores(lancs, rats);

      // Lucro por s√≥cio
      renderLucroSection(lucroData);

      // Equaliza√ß√£o
      renderEqualizacaoSection();

      // Hydrate filter selects
      hydrateFilterSelects();
    }

    function renderAlertasVencimento() {
      const hoje = new Date();
      const em7Dias = new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000);

      const lancamentosPendentes = state.lancamentos.filter(l => {
        if ((l.status || "pendente") === "pago" || !l.dataVencimento) return false;
        const venc = new Date(l.dataVencimento);
        return venc <= em7Dias;
      });

      const rateiosPendentes = state.rateios.filter(r => {
        if ((r.status || "pendente") === "pago" || !r.dataVencimento) return false;
        const venc = new Date(r.dataVencimento);
        return venc <= em7Dias;
      });

      const vencidos = [...lancamentosPendentes, ...rateiosPendentes].filter(item => {
        return new Date(item.dataVencimento) < hoje;
      });

      const vencendoEmBreve = [...lancamentosPendentes, ...rateiosPendentes].filter(item => {
        const venc = new Date(item.dataVencimento);
        return venc >= hoje && venc <= em7Dias;
      });

      const container = $("alertas-vencimento");
      if (vencidos.length === 0 && vencendoEmBreve.length === 0) {
        container.innerHTML = "";
        return;
      }

      let html = "";

      if (vencidos.length > 0) {
        const valorTotal = vencidos.reduce((sum, item) => sum + (item.valor || item.valorTotal), 0);
        html += `
          <div class="alert alert-danger">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-bold text-red-800 text-lg">üö® ${vencidos.length} Pagamento(s) Vencido(s)</h4>
                <p class="text-sm text-red-700 mt-1">Total: R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
              </div>
            </div>
          </div>
        `;
      }

      if (vencendoEmBreve.length > 0) {
        const valorTotal = vencendoEmBreve.reduce((sum, item) => sum + (item.valor || item.valorTotal), 0);
        html += `
          <div class="alert alert-warning">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-bold text-yellow-800 text-lg">‚ö†Ô∏è ${vencendoEmBreve.length} Pagamento(s) Vencendo em 7 Dias</h4>
                <p class="text-sm text-yellow-700 mt-1">Total: R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
              </div>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function renderROISection(custoTotal, lucroData, totalRecebido) {
      const obra = state.obras.find(o => o.id === OBRA_ID);
      if (!obra) {
        $("roi-section").innerHTML = "";
        return;
      }

      // Calcular valores reais vs previstos
      const vgvPrevisto = state.unidades.reduce((sum, u) => sum + (u.vgvPrevisto || 0), 0);
      const vgvReal = state.unidades.reduce((sum, u) => sum + (u.valorVenda || u.vgvPrevisto || 0), 0);
      const diferencaVGV = vgvReal - vgvPrevisto;
      const percentualVGV = vgvPrevisto > 0 ? ((vgvReal / vgvPrevisto - 1) * 100) : 0;

      // Calcular tempo de opera√ß√£o
      let diasOperacao = null;
      let mesesOperacao = null;
      let dataInicioFormatada = null;
      let dataRecebimentoFormatada = null;

      if (obra.dataInicio) {
        const inicio = new Date(obra.dataInicio);
        const fim = obra.dataRecebimento ? new Date(obra.dataRecebimento) : new Date();
        diasOperacao = Math.floor((fim - inicio) / (1000 * 60 * 60 * 24));
        mesesOperacao = diasOperacao / 30;
        
        dataInicioFormatada = inicio.toLocaleDateString('pt-BR');
        dataRecebimentoFormatada = obra.dataRecebimento 
          ? new Date(obra.dataRecebimento).toLocaleDateString('pt-BR')
          : "Em andamento";
      }

      // Calcular ROI
      const lucroLiquidoReal = vgvReal - custoTotal - lucroData.valorDeducoes;
      const roiPercentual = custoTotal > 0 ? ((lucroLiquidoReal / custoTotal) * 100) : 0;
      const roiMensal = mesesOperacao > 0 ? (roiPercentual / mesesOperacao) : 0;

      // An√°lise por s√≥cio (assumindo 50/50)
      const investimentoPorSocio = custoTotal / 2;
      const lucroPorSocio = lucroLiquidoReal / 2;
      const roiPorSocio = investimentoPorSocio > 0 ? ((lucroPorSocio / investimentoPorSocio) * 100) : 0;

      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      const html = `
        <div class="card p-6">
          <div class="font-black text-lg mb-4">üìà An√°lise de Rentabilidade da Opera√ß√£o</div>
          
          <!-- VGV Previsto vs Real -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4">
              <div class="text-xs font-bold text-blue-800 mb-1">üíé VGV PREVISTO</div>
              <div class="text-2xl font-black text-blue-600">R$ ${vgvPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
              <div class="text-xs text-blue-700 mt-1">Estimativa inicial</div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-4">
              <div class="text-xs font-bold text-green-800 mb-1">üí∞ VALOR REAL DE VENDA</div>
              <div class="text-2xl font-black text-green-600">R$ ${vgvReal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
              <div class="text-xs text-green-700 mt-1">Valores negociados</div>
            </div>
            <div class="bg-gradient-to-br from-${diferencaVGV >= 0 ? 'green' : 'red'}-50 to-${diferencaVGV >= 0 ? 'green' : 'red'}-100 border border-${diferencaVGV >= 0 ? 'green' : 'red'}-200 rounded-lg p-4">
              <div class="text-xs font-bold text-${diferencaVGV >= 0 ? 'green' : 'red'}-800 mb-1">${diferencaVGV >= 0 ? 'üìä' : 'üìâ'} VARIA√á√ÉO</div>
              <div class="text-2xl font-black text-${diferencaVGV >= 0 ? 'green' : 'red'}-600">${diferencaVGV >= 0 ? '+' : ''}${percentualVGV.toFixed(2)}%</div>
              <div class="text-xs text-${diferencaVGV >= 0 ? 'green' : 'red'}-700 mt-1">R$ ${diferencaVGV >= 0 ? '+' : ''}${diferencaVGV.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
            </div>
          </div>

          <!-- Tempo de Opera√ß√£o -->
          ${diasOperacao !== null ? `
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <div class="text-xs font-bold text-purple-800 mb-1">üìÖ IN√çCIO DA CONSTRU√á√ÉO</div>
                  <div class="text-xl font-black text-purple-600">${dataInicioFormatada}</div>
                </div>
                <div>
                  <div class="text-xs font-bold text-purple-800 mb-1">üìÖ RECEBIMENTO</div>
                  <div class="text-xl font-black text-purple-600">${dataRecebimentoFormatada}</div>
                </div>
                <div>
                  <div class="text-xs font-bold text-purple-800 mb-1">‚è±Ô∏è TEMPO DE OPERA√á√ÉO</div>
                  <div class="text-xl font-black text-purple-600">${diasOperacao} dias</div>
                  <div class="text-xs text-purple-700 mt-1">(${mesesOperacao.toFixed(1)} meses)</div>
                </div>
              </div>
            </div>
          ` : `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 text-center">
              <p class="text-sm text-yellow-800">‚ö†Ô∏è Configure as datas de in√≠cio e recebimento em <b>üèóÔ∏è Obras</b> para ver m√©tricas de tempo</p>
            </div>
          `}

          <!-- ROI Geral -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-lg p-4">
              <div class="text-xs font-bold text-orange-800 mb-1">üí∞ INVESTIMENTO TOTAL</div>
              <div class="text-xl font-black text-orange-600">R$ ${custoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
              <div class="text-xs text-orange-700 mt-1">Custo da obra</div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-4">
              <div class="text-xs font-bold text-green-800 mb-1">üíµ LUCRO L√çQUIDO</div>
              <div class="text-xl font-black text-green-600">R$ ${lucroLiquidoReal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
              <div class="text-xs text-green-700 mt-1">Ap√≥s dedu√ß√µes</div>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4">
              <div class="text-xs font-bold text-blue-800 mb-1">üìä ROI TOTAL</div>
              <div class="text-3xl font-black text-blue-600">${roiPercentual.toFixed(2)}%</div>
              <div class="text-xs text-blue-700 mt-1">Retorno sobre investimento</div>
            </div>
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-lg p-4">
              <div class="text-xs font-bold text-indigo-800 mb-1">üìà ROI MENSAL</div>
              <div class="text-3xl font-black text-indigo-600">${mesesOperacao > 0 ? roiMensal.toFixed(2) + '%' : '-'}</div>
              <div class="text-xs text-indigo-700 mt-1">${mesesOperacao > 0 ? 'Rentabilidade ao m√™s' : 'Configure datas'}</div>
            </div>
          </div>

          <!-- An√°lise por S√≥cio -->
          <div class="border-t pt-4">
            <div class="font-bold text-gray-800 mb-3">üë• An√°lise Individual por S√≥cio (50/50)</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- S√≥cio A -->
              <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <h4 class="font-bold text-gray-800 mb-3 text-lg">üë§ ${escapeHtml(socioA)}</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">üí∞ Investimento:</span>
                    <span class="font-bold">R$ ${investimentoPorSocio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">üíµ Lucro L√≠quido:</span>
                    <span class="font-bold text-green-600">R$ ${lucroPorSocio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                  </div>
                  <div class="flex justify-between border-t pt-2">
                    <span class="text-gray-600">üìä ROI Individual:</span>
                    <span class="font-bold text-blue-600 text-xl">${roiPorSocio.toFixed(2)}%</span>
                  </div>
                  ${mesesOperacao > 0 ? `
                    <div class="flex justify-between">
                      <span class="text-gray-600">üìà ROI Mensal:</span>
                      <span class="font-bold text-indigo-600">${roiMensal.toFixed(2)}%/m√™s</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">üí∞ Lucro/M√™s:</span>
                      <span class="font-bold text-green-600">R$ ${(lucroPorSocio / mesesOperacao).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    </div>
                  ` : ''}
                </div>
              </div>

              <!-- S√≥cio B -->
              <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <h4 class="font-bold text-gray-800 mb-3 text-lg">üë§ ${escapeHtml(socioB)}</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">üí∞ Investimento:</span>
                    <span class="font-bold">R$ ${investimentoPorSocio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">üíµ Lucro L√≠quido:</span>
                    <span class="font-bold text-green-600">R$ ${lucroPorSocio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                  </div>
                  <div class="flex justify-between border-t pt-2">
                    <span class="text-gray-600">üìä ROI Individual:</span>
                    <span class="font-bold text-blue-600 text-xl">${roiPorSocio.toFixed(2)}%</span>
                  </div>
                  ${mesesOperacao > 0 ? `
                    <div class="flex justify-between">
                      <span class="text-gray-600">üìà ROI Mensal:</span>
                      <span class="font-bold text-indigo-600">${roiMensal.toFixed(2)}%/m√™s</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">üí∞ Lucro/M√™s:</span>
                      <span class="font-bold text-green-600">R$ ${(lucroPorSocio / mesesOperacao).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>

          ${mesesOperacao > 0 ? `
            <div class="mt-6 bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-lg p-4">
              <div class="text-center">
                <div class="text-sm font-bold text-gray-700 mb-2">üí° Resumo da Opera√ß√£o</div>
                <div class="text-lg text-gray-800">
                  Investimento de <span class="font-black text-orange-600">R$ ${custoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span> 
                  gerou lucro l√≠quido de <span class="font-black text-green-600">R$ ${lucroLiquidoReal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span> 
                  em <span class="font-black text-purple-600">${mesesOperacao.toFixed(1)} meses</span>, 
                  representando <span class="font-black text-blue-600">${roiPercentual.toFixed(2)}%</span> de retorno total 
                  (<span class="font-black text-indigo-600">${roiMensal.toFixed(2)}%/m√™s</span>)
                </div>
              </div>
            </div>
          ` : ''}
        </div>
      `;

      $("roi-section").innerHTML = html;
    }

    // Gr√°ficos Interativos com Chart.js
    let chartInstances = {};

    function renderCharts() {
      if (typeof Chart === 'undefined') return;

      // Destruir gr√°ficos existentes
      Object.values(chartInstances).forEach(chart => chart?.destroy());
      chartInstances = {};

      const theme = document.body.getAttribute('data-theme') || 'light';
      const isDark = theme === 'dark';
      const textColor = isDark ? '#f1f5f9' : '#0f172a';
      const gridColor = isDark ? '#475569' : '#e2e8f0';

      // 1. Evolu√ß√£o de Custos no Tempo
      renderCustosTempoChart(textColor, gridColor);
      
      // 2. Distribui√ß√£o por Categoria (Pie)
      renderCategoriasPieChart(textColor);
      
      // 3. Fluxo de Caixa Projetado
      renderFluxoCaixaChart(textColor, gridColor);
      
      // 4. ROI Comparativo (Bar)
      renderROIBarChart(textColor, gridColor);
    }

    function renderCustosTempoChart(textColor, gridColor) {
      const canvas = document.getElementById('chart-custos-tempo');
      if (!canvas) return;

      // Agrupar lan√ßamentos por m√™s
      const custosPorMes = {};
      state.lancamentos.forEach(l => {
        const mes = l.data.substring(0, 7); // YYYY-MM
        custosPorMes[mes] = (custosPorMes[mes] || 0) + l.valor;
      });
      
      state.rateios.forEach(r => {
        const mes = r.data.substring(0, 7);
        custosPorMes[mes] = (custosPorMes[mes] || 0) + r.valorTotal;
      });

      const meses = Object.keys(custosPorMes).sort();
      const valores = meses.map(m => custosPorMes[m]);
      
      // Acumulado
      const acumulado = [];
      let soma = 0;
      valores.forEach(v => {
        soma += v;
        acumulado.push(soma);
      });

      chartInstances.custosTempo = new Chart(canvas, {
        type: 'line',
        data: {
          labels: meses.map(m => {
            const [y, mo] = m.split('-');
            return `${mo}/${y}`;
          }),
          datasets: [{
            label: 'Custos Mensais',
            data: valores,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }, {
            label: 'Acumulado',
            data: acumulado,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: textColor } }
          },
          scales: {
            y: {
              ticks: { color: textColor },
              grid: { color: gridColor }
            },
            x: {
              ticks: { color: textColor },
              grid: { color: gridColor }
            }
          }
        }
      });
    }

    function renderCategoriasPieChart(textColor) {
      const canvas = document.getElementById('chart-categorias-pie');
      if (!canvas) return;

      const custoPorCategoria = {};
      state.lancamentos.forEach(l => {
        const cat = state.categorias.find(c => c.id === l.categoriaId);
        const nome = cat?.nome || 'Sem categoria';
        custoPorCategoria[nome] = (custoPorCategoria[nome] || 0) + l.valor;
      });

      state.rateios.forEach(r => {
        const cat = state.categorias.find(c => c.id === r.categoriaId);
        const nome = cat?.nome || 'Sem categoria';
        custoPorCategoria[nome] = (custoPorCategoria[nome] || 0) + r.valorTotal;
      });

      const sorted = Object.entries(custoPorCategoria)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

      const labels = sorted.map(([nome]) => nome);
      const data = sorted.map(([, valor]) => valor);
      const colors = [
        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', 
        '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
      ];

      chartInstances.categoriasPie = new Chart(canvas, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: textColor }
            }
          }
        }
      });
    }

    function renderFluxoCaixaChart(textColor, gridColor) {
      const canvas = document.getElementById('chart-fluxo-caixa');
      if (!canvas) return;

      // Projetar pr√≥ximos 6 meses
      const hoje = new Date();
      const meses = [];
      const entradas = [];
      const saidas = [];
      const saldo = [];

      const totalRecebido = state.recebimentos.reduce((sum, r) => sum + r.valor, 0);
      const custoTotal = computeCustoTotal(state.lancamentos, state.rateios);
      const lucroData = computeLucro();
      const aReceber = lucroData.vgvTotal - totalRecebido;

      let saldoAcumulado = totalRecebido - custoTotal;

      for (let i = 0; i < 6; i++) {
        const mes = new Date(hoje.getFullYear(), hoje.getMonth() + i, 1);
        const mesStr = `${String(mes.getMonth() + 1).padStart(2, '0')}/${mes.getFullYear()}`;
        meses.push(mesStr);

        // Simular entrada gradual do valor a receber
        const entradaMes = i === 0 ? totalRecebido : (aReceber / 6);
        entradas.push(entradaMes);

        // Custos projetados (m√©dia hist√≥rica)
        const custoMedio = custoTotal / Math.max(1, state.lancamentos.length / 10);
        saidas.push(i === 0 ? custoTotal : custoMedio);

        saldoAcumulado += (i === 0 ? 0 : (entradaMes - custoMedio));
        saldo.push(saldoAcumulado);
      }

      chartInstances.fluxoCaixa = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: meses,
          datasets: [{
            label: 'Entradas',
            data: entradas,
            backgroundColor: 'rgba(16, 185, 129, 0.7)',
            borderColor: '#10b981',
            borderWidth: 2
          }, {
            label: 'Sa√≠das',
            data: saidas,
            backgroundColor: 'rgba(239, 68, 68, 0.7)',
            borderColor: '#ef4444',
            borderWidth: 2
          }, {
            label: 'Saldo Acumulado',
            data: saldo,
            type: 'line',
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: textColor } }
          },
          scales: {
            y: {
              type: 'linear',
              position: 'left',
              ticks: { color: textColor },
              grid: { color: gridColor }
            },
            y1: {
              type: 'linear',
              position: 'right',
              ticks: { color: textColor },
              grid: { display: false }
            },
            x: {
              ticks: { color: textColor },
              grid: { color: gridColor }
            }
          }
        }
      });
    }

    function renderROIBarChart(textColor, gridColor) {
      const canvas = document.getElementById('chart-roi-bar');
      if (!canvas) return;

      const lucroData = computeLucro();
      const custoTotal = computeCustoTotal(state.lancamentos, state.rateios);
      const totalRecebido = state.recebimentos.reduce((sum, r) => sum + r.valor, 0);

      const roi = custoTotal > 0 ? ((lucroData.lucroLiquido / custoTotal) * 100) : 0;
      const margemBruta = lucroData.vgvTotal > 0 ? ((lucroData.lucroBruto / lucroData.vgvTotal) * 100) : 0;
      const margemLiquida = lucroData.vgvTotal > 0 ? ((lucroData.lucroLiquido / lucroData.vgvTotal) * 100) : 0;
      const percRecebido = lucroData.vgvTotal > 0 ? ((totalRecebido / lucroData.vgvTotal) * 100) : 0;

      chartInstances.roiBar = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: ['ROI (%)', 'Margem Bruta (%)', 'Margem L√≠quida (%)', '% Recebido'],
          datasets: [{
            label: 'Indicadores (%)',
            data: [roi, margemBruta, margemLiquida, percRecebido],
            backgroundColor: [
              'rgba(59, 130, 246, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(245, 158, 11, 0.7)'
            ],
            borderColor: [
              '#3b82f6',
              '#10b981',
              '#8b5cf6',
              '#f59e0b'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                color: textColor,
                callback: (value) => value + '%'
              },
              grid: { color: gridColor }
            },
            x: {
              ticks: { color: textColor },
              grid: { color: gridColor }
            }
          }
        }
      });
    }

    function renderCustoM2(lancs, rats) {
      const custoPorUnidade = {};

      lancs.forEach(l => {
        if (!custoPorUnidade[l.unidadeId]) custoPorUnidade[l.unidadeId] = 0;
        custoPorUnidade[l.unidadeId] += l.valor;
      });

      rats.forEach(r => {
        r.distribuicao?.forEach(d => {
          if (!custoPorUnidade[d.unidadeId]) custoPorUnidade[d.unidadeId] = 0;
          custoPorUnidade[d.unidadeId] += d.valor;
        });
      });

      const unidadesComCusto = Object.entries(custoPorUnidade)
        .map(([unidadeId, custo]) => {
          const unidade = state.unidades.find(u => u.id === unidadeId);
          if (!unidade) return null;

          const areaTotal = unidade.areaConstruida || 0;
          const custoM2 = areaTotal > 0 ? custo / areaTotal : 0;

          return { unidade, custo, areaTotal, custoM2 };
        })
        .filter(Boolean)
        .sort((a, b) => b.custoM2 - a.custoM2);

      if (unidadesComCusto.length === 0) {
        $("custo-m2-section").innerHTML = '<div class="card p-6 mb-6"><p class="text-sm muted">Configure a √°rea (m¬≤) das unidades em <b>üè† Unidades</b></p></div>';
        return;
      }

      const totalCusto = unidadesComCusto.reduce((sum, item) => sum + item.custo, 0);
      const totalArea = unidadesComCusto.reduce((sum, item) => sum + item.areaTotal, 0);
      const custoM2Medio = totalArea > 0 ? totalCusto / totalArea : 0;

      const html = `
        <div class="card p-6 mb-6">
          <div class="font-black text-lg mb-4">üìê Custo por m¬≤ / Unidade</div>
          
          ${totalArea > 0 ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
              <div class="text-sm muted mb-1">üí∞ Custo Total da Obra</div>
              <div class="text-2xl font-black text-blue-600">R$ ${totalCusto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              <div class="text-sm muted mt-2">
                üìè √Årea Total: ${totalArea.toFixed(2)} m¬≤ | 
                üìä Custo M√©dio: R$ ${custoM2Medio.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}/m¬≤
              </div>
            </div>
          ` : ''}
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${unidadesComCusto.map(item => `
              <div class="border rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">${escapeHtml(item.unidade.nome)}</h4>
                <div class="space-y-1 text-sm">
                  <p><span class="muted">Custo Total:</span> <span class="font-bold">R$ ${item.custo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></p>
                  <p><span class="muted">√Årea:</span> ${item.areaTotal > 0 ? item.areaTotal.toFixed(2) + ' m¬≤' : '<span class="text-red-600">N√£o configurada</span>'}</p>
                  <p><span class="muted">Custo/m¬≤:</span> ${item.areaTotal > 0 ? `<span class="font-bold text-blue-600">R$ ${item.custoM2.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>` : '<span class="muted">-</span>'}</p>
                </div>
              </div>
            `).join('')}
          </div>
          
          ${totalArea === 0 ? '<p class="text-xs muted mt-4 text-center">üí° Dica: Configure a √°rea (m¬≤) de cada unidade em <b>üè† Unidades</b> para ver o custo por m¬≤</p>' : ''}
        </div>
      `;

      $("custo-m2-section").innerHTML = html;
    }

    function renderTopCategorias(lancs, rats) {
      const custoPorCategoria = {};

      lancs.forEach(l => {
        if (!custoPorCategoria[l.categoriaId]) custoPorCategoria[l.categoriaId] = 0;
        custoPorCategoria[l.categoriaId] += l.valor;
      });

      rats.forEach(r => {
        if (!custoPorCategoria[r.categoriaId]) custoPorCategoria[r.categoriaId] = 0;
        custoPorCategoria[r.categoriaId] += r.valorTotal;
      });

      const sorted = Object.entries(custoPorCategoria)
        .map(([catId, valor]) => {
          const cat = state.categorias.find(c => c.id === catId);
          return { nome: cat?.nome || "Sem categoria", valor };
        })
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 5);

      if (sorted.length === 0) {
        $("top-categorias").innerHTML = '<p class="text-sm muted">Nenhum dado</p>';
        return;
      }

      const html = sorted.map((item, i) => `
        <div class="flex justify-between items-center py-2 border-b">
          <div class="flex items-center gap-2">
            <span class="font-bold text-slate-400">${i + 1}.</span>
            <span class="text-sm">${escapeHtml(item.nome)}</span>
          </div>
          <span class="font-bold text-sm">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
      `).join('');

      $("top-categorias").innerHTML = html;
    }

    function renderTopFornecedores(lancs, rats) {
      const custoPorFornecedor = {};

      lancs.forEach(l => {
        if (!custoPorFornecedor[l.fornecedorId]) custoPorFornecedor[l.fornecedorId] = 0;
        custoPorFornecedor[l.fornecedorId] += l.valor;
      });

      rats.forEach(r => {
        if (!custoPorFornecedor[r.fornecedorId]) custoPorFornecedor[r.fornecedorId] = 0;
        custoPorFornecedor[r.fornecedorId] += r.valorTotal;
      });

      const sorted = Object.entries(custoPorFornecedor)
        .map(([fornId, valor]) => {
          const forn = state.fornecedores.find(f => f.id === fornId);
          return { nome: forn?.nome || "Sem fornecedor", valor };
        })
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 5);

      if (sorted.length === 0) {
        $("top-fornecedores").innerHTML = '<p class="text-sm muted">Nenhum dado</p>';
        return;
      }

      const html = sorted.map((item, i) => `
        <div class="flex justify-between items-center py-2 border-b">
          <div class="flex items-center gap-2">
            <span class="font-bold text-slate-400">${i + 1}.</span>
            <span class="text-sm">${escapeHtml(item.nome)}</span>
          </div>
          <span class="font-bold text-sm">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
      `).join('');

      $("top-fornecedores").innerHTML = html;
    }

    function renderLucroSection(lucroData) {
      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      let html = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="border rounded-lg p-4">
            <div class="text-sm muted mb-1">üë§ ${escapeHtml(socioA)}</div>
            <div class="text-2xl font-black ${lucroData.lucroLiquidoA >= 0 ? 'ok' : 'danger'}">
              R$ ${lucroData.lucroLiquidoA.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </div>
          </div>
          <div class="border rounded-lg p-4">
            <div class="text-sm muted mb-1">üë§ ${escapeHtml(socioB)}</div>
            <div class="text-2xl font-black ${lucroData.lucroLiquidoB >= 0 ? 'ok' : 'danger'}">
              R$ ${lucroData.lucroLiquidoB.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </div>
          </div>
        </div>
      `;

      if (lucroData.deducoes.length > 0) {
        html += `
          <div class="text-xs muted mt-4">
            <div class="font-bold mb-2">Dedu√ß√µes aplicadas:</div>
            ${lucroData.deducoes.map(d => `
              <div>‚Ä¢ ${escapeHtml(d.nome)}: ${d.displayTipo} sobre ${d.displayBase} = R$ ${d.valorDeducao.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            `).join('')}
          </div>
        `;
      }

      $("lucro-section").innerHTML = html;
    }

    function renderEqualizacaoSection() {
      const eq = computeEqualizacao();
      if (!eq) {
        $("equalizacao-section").innerHTML = '<p class="text-sm muted">Erro ao calcular equaliza√ß√£o</p>';
        return;
      }

      const html = `
        <!-- An√°lise Detalhada de Fluxo de Caixa por S√≥cio -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- S√≥cio A -->
          <div class="border border-gray-200 rounded-lg p-6 bg-gradient-to-br from-blue-50 to-white">
            <h4 class="font-bold text-gray-800 mb-4 text-xl flex items-center gap-2">
              üë§ ${escapeHtml(eq.socioA)}
            </h4>
            
            <div class="space-y-3">
              <div class="bg-white rounded-lg p-3 border border-blue-200">
                <div class="text-xs font-bold text-blue-800 mb-1">üí∞ RECEBEU FISICAMENTE</div>
                <div class="text-2xl font-black text-blue-600">R$ ${eq.recebeuA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-600 mt-1">Dinheiro que voc√™ recebeu na m√£o</div>
              </div>

              <div class="bg-white rounded-lg p-3 border border-green-200">
                <div class="text-xs font-bold text-green-800 mb-1">‚úÖ TEM DIREITO</div>
                <div class="text-2xl font-black text-green-600">R$ ${eq.temDireitoA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-600 mt-1">Sua parte baseado no propriet√°rio das unidades</div>
              </div>

              <div class="bg-gradient-to-r from-${eq.deveRepassarA > 0 ? 'orange' : 'cyan'}-50 to-white rounded-lg p-3 border-2 border-${eq.deveRepassarA > 0 ? 'orange' : 'cyan'}-300">
                <div class="text-xs font-bold text-${eq.deveRepassarA > 0 ? 'orange' : 'cyan'}-800 mb-1">üí∏ ${eq.deveRepassarA > 0 ? 'DEVE REPASSAR' : 'DEVE RECEBER'}</div>
                <div class="text-2xl font-black text-${eq.deveRepassarA > 0 ? 'orange' : 'cyan'}-700">R$ ${Math.abs(eq.deveRepassarA).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-700 mt-1">${eq.deveRepassarA > 0 ? 'Recebeu mais do que tem direito' : 'Recebeu menos do que tem direito'}</div>
              </div>

              <div class="bg-white rounded-lg p-3 border border-red-200">
                <div class="text-xs font-bold text-red-800 mb-1">üí≥ PAGOU EM CUSTOS</div>
                <div class="text-2xl font-black text-red-600">R$ ${eq.pagouA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-600 mt-1">Custos que voc√™ efetivamente pagou</div>
              </div>

              <div class="bg-white rounded-lg p-3 border border-orange-200">
                <div class="text-xs font-bold text-orange-800 mb-1">üìä DEVERIA PAGAR (50%)</div>
                <div class="text-2xl font-black text-orange-600">R$ ${eq.deveGastarA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-600 mt-1">Sua parte dos custos totais (50% de R$ ${eq.totalGasto.toLocaleString('pt-BR', {minimumFractionDigits: 2})})</div>
              </div>              <div class="bg-gradient-to-r from-${eq.saldoCaixaA >= 0 ? 'green' : 'red'}-50 to-${eq.saldoCaixaA >= 0 ? 'green' : 'red'}-100 rounded-lg p-3 border-2 border-${eq.saldoCaixaA >= 0 ? 'green' : 'red'}-300">
                <div class="text-xs font-bold text-${eq.saldoCaixaA >= 0 ? 'green' : 'red'}-900 mb-1">üè¶ SALDO DE CAIXA</div>
                <div class="text-2xl font-black text-${eq.saldoCaixaA >= 0 ? 'green' : 'red'}-700">R$ ${eq.saldoCaixaA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-${eq.saldoCaixaA >= 0 ? 'green' : 'red'}-800 mt-1">Recebeu - Pagou = ${eq.saldoCaixaA >= 0 ? 'Positivo' : 'Negativo'}</div>
              </div>

              <div class="bg-gradient-to-r from-${eq.diferencaGastosA >= 0 ? 'purple' : 'yellow'}-50 to-white rounded-lg p-3 border-2 border-${eq.diferencaGastosA >= 0 ? 'purple' : 'yellow'}-300">
                <div class="text-xs font-bold text-${eq.diferencaGastosA >= 0 ? 'purple' : 'yellow'}-900 mb-1">‚öñÔ∏è DIFEREN√áA NOS GASTOS</div>
                <div class="text-2xl font-black text-${eq.diferencaGastosA >= 0 ? 'purple' : 'yellow'}-700">${eq.diferencaGastosA >= 0 ? '+' : ''}R$ ${eq.diferencaGastosA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-700 mt-1">${eq.diferencaGastosA >= 0 ? 'Voc√™ pagou MAIS que sua parte' : 'Voc√™ pagou MENOS que sua parte'}</div>
              </div>

              <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 rounded-lg p-3 border-2 border-indigo-400">
                <div class="text-xs font-bold text-indigo-900 mb-1">üéØ SALDO FINAL (ap√≥s acertos)</div>
                <div class="text-3xl font-black text-indigo-700">${eq.saldoFinalA >= 0 ? '+' : ''}R$ ${eq.saldoFinalA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-indigo-800 mt-1">${eq.saldoFinalA >= 0 ? 'Tem a receber' : 'Tem a pagar'}</div>
              </div>
            </div>
          </div>

          <!-- S√≥cio B -->
          <div class="border border-gray-200 rounded-lg p-6 bg-gradient-to-br from-green-50 to-white">
            <h4 class="font-bold text-gray-800 mb-4 text-xl flex items-center gap-2">
              üë§ ${escapeHtml(eq.socioB)}
            </h4>
            
            <div class="space-y-3">
              <div class="bg-white rounded-lg p-3 border border-blue-200">
                <div class="text-xs font-bold text-blue-800 mb-1">üí∞ RECEBEU FISICAMENTE</div>
                <div class="text-2xl font-black text-blue-600">R$ ${eq.recebeuB.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-600 mt-1">Dinheiro que voc√™ recebeu na m√£o</div>
              </div>

              <div class="bg-white rounded-lg p-3 border border-green-200">
                <div class="text-xs font-bold text-green-800 mb-1">‚úÖ TEM DIREITO</div>
                <div class="text-2xl font-black text-green-600">R$ ${eq.temDireitoB.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-600 mt-1">Sua parte baseado no propriet√°rio das unidades</div>
              </div>

              <div class="bg-gradient-to-r from-${eq.deveRepassarB > 0 ? 'orange' : 'cyan'}-50 to-white rounded-lg p-3 border-2 border-${eq.deveRepassarB > 0 ? 'orange' : 'cyan'}-300">
                <div class="text-xs font-bold text-${eq.deveRepassarB > 0 ? 'orange' : 'cyan'}-800 mb-1">üí∏ ${eq.deveRepassarB > 0 ? 'DEVE REPASSAR' : 'DEVE RECEBER'}</div>
                <div class="text-2xl font-black text-${eq.deveRepassarB > 0 ? 'orange' : 'cyan'}-700">R$ ${Math.abs(eq.deveRepassarB).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-700 mt-1">${eq.deveRepassarB > 0 ? 'Recebeu mais do que tem direito' : 'Recebeu menos do que tem direito'}</div>
              </div>

              <div class="bg-white rounded-lg p-3 border border-red-200">
                <div class="text-xs font-bold text-red-800 mb-1">üí≥ PAGOU EM CUSTOS</div>
                <div class="text-2xl font-black text-red-600">R$ ${eq.pagouB.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-600 mt-1">Custos que voc√™ efetivamente pagou</div>
              </div>

              <div class="bg-white rounded-lg p-3 border border-orange-200">
                <div class="text-xs font-bold text-orange-800 mb-1">üìä DEVERIA PAGAR (50%)</div>
                <div class="text-2xl font-black text-orange-600">R$ ${eq.deveGastarB.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-600 mt-1">Sua parte dos custos totais (50% de R$ ${eq.totalGasto.toLocaleString('pt-BR', {minimumFractionDigits: 2})})</div>
              </div>              <div class="bg-gradient-to-r from-${eq.saldoCaixaB >= 0 ? 'green' : 'red'}-50 to-${eq.saldoCaixaB >= 0 ? 'green' : 'red'}-100 rounded-lg p-3 border-2 border-${eq.saldoCaixaB >= 0 ? 'green' : 'red'}-300">
                <div class="text-xs font-bold text-${eq.saldoCaixaB >= 0 ? 'green' : 'red'}-900 mb-1">üè¶ SALDO DE CAIXA</div>
                <div class="text-2xl font-black text-${eq.saldoCaixaB >= 0 ? 'green' : 'red'}-700">R$ ${eq.saldoCaixaB.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-${eq.saldoCaixaB >= 0 ? 'green' : 'red'}-800 mt-1">Recebeu - Pagou = ${eq.saldoCaixaB >= 0 ? 'Positivo' : 'Negativo'}</div>
              </div>

              <div class="bg-gradient-to-r from-${eq.diferencaGastosB >= 0 ? 'purple' : 'yellow'}-50 to-white rounded-lg p-3 border-2 border-${eq.diferencaGastosB >= 0 ? 'purple' : 'yellow'}-300">
                <div class="text-xs font-bold text-${eq.diferencaGastosB >= 0 ? 'purple' : 'yellow'}-900 mb-1">‚öñÔ∏è DIFEREN√áA NOS GASTOS</div>
                <div class="text-2xl font-black text-${eq.diferencaGastosB >= 0 ? 'purple' : 'yellow'}-700">${eq.diferencaGastosB >= 0 ? '+' : ''}R$ ${eq.diferencaGastosB.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-gray-700 mt-1">${eq.diferencaGastosB >= 0 ? 'Voc√™ pagou MAIS que sua parte' : 'Voc√™ pagou MENOS que sua parte'}</div>
              </div>

              <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 rounded-lg p-3 border-2 border-indigo-400">
                <div class="text-xs font-bold text-indigo-900 mb-1">üéØ SALDO FINAL (ap√≥s acertos)</div>
                <div class="text-3xl font-black text-indigo-700">${eq.saldoFinalB >= 0 ? '+' : ''}R$ ${eq.saldoFinalB.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                <div class="text-xs text-indigo-800 mt-1">${eq.saldoFinalB >= 0 ? 'Tem a receber' : 'Tem a pagar'}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sugest√£o de Acerto -->
        ${eq.mensagem ? `
          <div class="bg-gradient-to-r from-yellow-50 via-orange-50 to-red-50 border-2 border-orange-400 rounded-lg p-6">
            <div class="text-center mb-4">
              <div class="text-2xl mb-2">üí°</div>
              <div class="text-lg font-bold text-gray-800 mb-2">Sugest√£o de Equaliza√ß√£o</div>
              <div class="text-2xl font-black text-orange-600">${eq.mensagem}</div>
            </div>
            <div class="flex gap-3 justify-center">
              <button onclick="window.sugerirAcerto()" class="btn btn-green">
                ‚ú® Criar Acerto Automaticamente
              </button>
              <button onclick="window.navigateTo('ACERTOS')" class="btn btn-dark">
                üìù Criar Manualmente
              </button>
            </div>
            <div class="text-sm text-gray-600 mt-3 text-center">
              Clique para criar o acerto e zerar os saldos entre os s√≥cios
            </div>
          </div>
        ` : `
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-lg p-6 text-center">
            <div class="text-4xl mb-2">‚úÖ</div>
            <div class="text-lg font-bold text-green-800">Saldos Equalizados!</div>
            <div class="text-sm text-gray-600 mt-2">N√£o h√° acertos pendentes entre os s√≥cios</div>
          </div>
        `}

        <!-- Explica√ß√£o do C√°lculo -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="font-bold text-blue-900 mb-2">üìö Como funciona a equaliza√ß√£o:</div>
          <div class="text-sm text-blue-800 space-y-1">
            <p>1Ô∏è‚É£ <strong>Recebeu Fisicamente:</strong> Quem pegou o dinheiro na m√£o (selecionado ao registrar recebimento)</p>
            <p>2Ô∏è‚É£ <strong>Tem Direito:</strong> Quanto cada um tem direito baseado no propriet√°rio da unidade (50/50, 100% A, ou 100% B)</p>
            <p>3Ô∏è‚É£ <strong>Deve Repassar/Receber:</strong> Diferen√ßa entre o que recebeu fisicamente e o que tem direito</p>
            <p>4Ô∏è‚É£ <strong>Pagou em Custos:</strong> O que cada um efetivamente desembolsou para pagar despesas</p>
            <p>5Ô∏è‚É£ <strong>Deveria Pagar:</strong> Cada s√≥cio deve arcar com 50% dos custos totais</p>
            <p>6Ô∏è‚É£ <strong>Diferen√ßa de Gastos:</strong> Pagou - Deveria Pagar (quem pagou mais ou menos que sua parte)</p>
            <p>7Ô∏è‚É£ <strong>Saldo Final:</strong> Combina repasses + gastos - acertos j√° realizados</p>
          </div>
          <div class="mt-3 p-3 bg-white rounded border border-blue-300">
            <div class="font-bold text-blue-900 text-sm mb-1">üí° Exemplo do usu√°rio:</div>
            <div class="text-xs text-gray-700">
              <strong>Victor recebeu:</strong> R$ 10.000 fisicamente (marcado como "Recebido por: S√≥cio A")<br>
              <strong>Tem direito:</strong> R$ 5.000 (casa √© 50/50)<br>
              <strong>Deve repassar:</strong> R$ 5.000 (recebeu 5k a mais)<br>
              <strong>Gustavo deve em custos:</strong> R$ 3.000<br>
              <strong>Resultado final:</strong> Victor passa apenas R$ 2.000 para Gustavo (5.000 - 3.000)
            </div>
          </div>
        </div>
      `;

      $("equalizacao-section").innerHTML = html;
    }

    function hydrateFilterSelects() {
      // Categorias
      const catSel = $("filter-categoria");
      catSel.innerHTML = '<option value="TODAS">Todas</option>' +
        state.categorias.map(c => `<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join('');
      catSel.value = filterCategoria;

      // Fornecedores
      const fornSel = $("filter-fornecedor");
      fornSel.innerHTML = '<option value="TODOS">Todos</option>' +
        state.fornecedores.map(f => `<option value="${f.id}">${escapeHtml(f.nome)}</option>`).join('');
      fornSel.value = filterFornecedor;
    }

    // LANCAMENTOS VIEW
    function renderLancamentosView() {
      // Hydrate selects
      const unidSel = $("lanc-unidade");
      unidSel.innerHTML = '<option value="">Selecione...</option>' +
        state.unidades.map(u => `<option value="${u.id}">${escapeHtml(u.nome)}</option>`).join('');

      const catSel = $("lanc-categoria");
      catSel.innerHTML = '<option value="">Selecione...</option>' +
        state.categorias.map(c => `<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join('');

      const fornSel = $("lanc-fornecedor");
      fornSel.innerHTML = '<option value="">Selecione...</option>' +
        state.fornecedores.map(f => `<option value="${f.id}">${escapeHtml(f.nome)}</option>`).join('');

      // Render list
      renderLancamentosList();
    }

    function renderLancamentosList() {
      const container = $("lanc-list");
      if (state.lancamentos.length === 0) {
        container.innerHTML = '<p class="text-center muted py-8">Nenhum lan√ßamento cadastrado</p>';
        return;
      }

      const html = `
        <table class="table w-full">
          <thead>
            <tr>
              <th class="text-left">Data</th>
              <th class="text-left">Status</th>
              <th class="text-left">Unidade</th>
              <th class="text-left">Categoria</th>
              <th class="text-left">Fornecedor</th>
              <th class="text-left">Descri√ß√£o</th>
              <th class="text-left">Valor</th>
              <th class="text-left">Vencimento</th>
              <th class="text-left">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${state.lancamentos.map(l => {
              const unid = state.unidades.find(u => u.id === l.unidadeId);
              const cat = state.categorias.find(c => c.id === l.categoriaId);
              const forn = state.fornecedores.find(f => f.id === l.fornecedorId);
              const statusClass = (l.status || "pendente") === "pago" ? "badge-pago" : (l.status === "atrasado" ? "badge-atrasado" : "badge-pendente");
              const statusIcon = (l.status || "pendente") === "pago" ? "‚úÖ" : (l.status === "atrasado" ? "üö®" : "‚è≥");
              
              return `
                <tr>
                  <td>${new Date(l.data).toLocaleDateString('pt-BR')}</td>
                  <td><span class="badge ${statusClass}">${statusIcon} ${(l.status || "pendente").toUpperCase()}</span></td>
                  <td>${escapeHtml(unid?.nome || '-')}</td>
                  <td>${escapeHtml(cat?.nome || '-')}</td>
                  <td>${escapeHtml(forn?.nome || '-')}</td>
                  <td>${escapeHtml(l.descricao)}</td>
                  <td class="font-bold">R$ ${l.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                  <td>${l.dataVencimento ? new Date(l.dataVencimento).toLocaleDateString('pt-BR') : '-'}</td>
                  <td>
                    ${l.comprovante ? `<a href="${l.comprovante}" target="_blank" class="text-blue-600 hover:underline mr-2">üìé</a>` : ''}
                    <button onclick="window.mudarStatusLancamento('${l.id}')" class="text-green-600 hover:underline mr-2" title="Mudar status">üí≥</button>
                    <button onclick="window.deleteLancamento('${l.id}')" class="text-red-600 hover:underline" title="Deletar">üóëÔ∏è</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // RATEIOS VIEW
    function renderRateiosView() {
      // Hydrate selects
      const catSel = $("rat-categoria");
      catSel.innerHTML = '<option value="">Selecione...</option>' +
        state.categorias.map(c => `<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join('');

      const fornSel = $("rat-fornecedor");
      fornSel.innerHTML = '<option value="">Selecione...</option>' +
        state.fornecedores.map(f => `<option value="${f.id}">${escapeHtml(f.nome)}</option>`).join('');

      // Init destinations
      rateioDestCount = 0;
      $("rat-dests").innerHTML = "";
      rateioAddDest();

      // Render list
      renderRateiosList();
    }

    function rateioAddDest() {
      const container = $("rat-dests");
      const id = rateioDestCount++;
      const div = document.createElement('div');
      div.className = "grid grid-cols-12 gap-2";
      div.id = `rat-dest-${id}`;
      div.innerHTML = `
        <div class="col-span-6">
          <select class="select text-sm rat-dest-unidade" required>
            <option value="">Selecione unidade...</option>
            ${state.unidades.map(u => `<option value="${u.id}">${escapeHtml(u.nome)}</option>`).join('')}
          </select>
        </div>
        <div class="col-span-4">
          <input type="number" step="0.01" class="input text-sm rat-dest-valor" placeholder="Valor (R$)" required />
        </div>
        <div class="col-span-2">
          <button type="button" onclick="window.rateioRemoveDest('${id}')" class="btn btn-danger w-full text-sm">üóëÔ∏è</button>
        </div>
      `;
      container.appendChild(div);
    }

    window.rateioRemoveDest = (id) => {
      $(`rat-dest-${id}`)?.remove();
    };

    function renderRateiosList() {
      const container = $("rat-list");
      if (state.rateios.length === 0) {
        container.innerHTML = '<p class="text-center muted py-8">Nenhum rateio cadastrado</p>';
        return;
      }

      const html = `
        <table class="table w-full">
          <thead>
            <tr>
              <th class="text-left">Data</th>
              <th class="text-left">Status</th>
              <th class="text-left">Descri√ß√£o</th>
              <th class="text-left">Fornecedor</th>
              <th class="text-left">Categoria</th>
              <th class="text-left">Valor Total</th>
              <th class="text-left">Destinos</th>
              <th class="text-left">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${state.rateios.map(r => {
              const forn = state.fornecedores.find(f => f.id === r.fornecedorId);
              const cat = state.categorias.find(c => c.id === r.categoriaId);
              const statusClass = (r.status || "pendente") === "pago" ? "badge-pago" : (r.status === "atrasado" ? "badge-atrasado" : "badge-pendente");
              const statusIcon = (r.status || "pendente") === "pago" ? "‚úÖ" : (r.status === "atrasado" ? "üö®" : "‚è≥");
              
              return `
                <tr>
                  <td>${new Date(r.data).toLocaleDateString('pt-BR')}</td>
                  <td><span class="badge ${statusClass}">${statusIcon} ${(r.status || "pendente").toUpperCase()}</span></td>
                  <td>${escapeHtml(r.descricao)}</td>
                  <td>${escapeHtml(forn?.nome || '-')}</td>
                  <td>${escapeHtml(cat?.nome || '-')}</td>
                  <td class="font-bold">R$ ${r.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                  <td class="text-sm">${r.distribuicao?.length || 0} unidades</td>
                  <td>
                    <button onclick="window.mudarStatusRateio('${r.id}')" class="text-green-600 hover:underline mr-2" title="Mudar status">üí≥</button>
                    <button onclick="window.deleteRateio('${r.id}')" class="text-red-600 hover:underline" title="Deletar">üóëÔ∏è</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // RECEBIMENTOS VIEW
    function renderRecebimentosView() {
      // Hydrate unidade select
      const unidSel = $("receb-unidade");
      unidSel.innerHTML = '<option value="">Selecione...</option>' +
        state.unidades.map(u => `<option value="${u.id}">${escapeHtml(u.nome)}</option>`).join('');

      renderRecebimentosList();
    }

    function renderRecebimentosList() {
      const container = $("receb-list");
      if (state.recebimentos.length === 0) {
        container.innerHTML = '<p class="text-center muted py-8">Nenhum recebimento cadastrado</p>';
        return;
      }

      const sorted = [...state.recebimentos].sort((a, b) => 
        new Date(b.data || 0) - new Date(a.data || 0)
      );

      const html = `
        <table class="table w-full">
          <thead>
            <tr>
              <th>Data</th>
              <th>Unidade</th>
              <th>Tipo</th>
              <th>Valor</th>
              <th>Forma</th>
              <th>Recebido por</th>
              <th>Obs</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${sorted.map(r => {
              const unid = state.unidades.find(u => u.id === r.unidadeId);
              const tipoLabels = {
                sinal: 'ü§ù Sinal',
                parcela: 'üìÖ Parcela',
                quitacao: '‚úÖ Quita√ß√£o',
                outro: 'üìù Outro'
              };
              const recebidoLabels = {
                A: 'üë§ S√≥cio A',
                B: 'üë§ S√≥cio B',
                ambos: 'üë• 50/50'
              };
              return `
                <tr>
                  <td>${new Date(r.data).toLocaleDateString('pt-BR')}</td>
                  <td><span class="badge">${escapeHtml(unid?.nome || 'N/A')}</span></td>
                  <td>${tipoLabels[r.tipo] || r.tipo}</td>
                  <td class="font-bold ok">R$ ${r.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                  <td>${escapeHtml(r.formaPagamento || 'N/A')}</td>
                  <td><span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${recebidoLabels[r.recebidoPor || 'ambos']}</span></td>
                  <td class="text-xs muted">${escapeHtml(r.observacoes || '-')}</td>
                  <td>
                    <button onclick="window.deleteRecebimento('${r.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded">
          <div class="font-bold text-green-800">Total Recebido:</div>
          <div class="text-2xl font-black text-green-600">
            R$ ${state.recebimentos.reduce((sum, r) => sum + (r.valor || 0), 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // ACERTOS VIEW
    function renderAcertosView() {
      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      $("ac-de").innerHTML = `
        <option value="A">${escapeHtml(socioA)}</option>
        <option value="B">${escapeHtml(socioB)}</option>
      `;

      $("ac-para").innerHTML = `
        <option value="A">${escapeHtml(socioA)}</option>
        <option value="B">${escapeHtml(socioB)}</option>
      `;

      renderAcertosList();
    }

    function renderAcertosList() {
      const container = $("acerto-list");
      if (state.acertos.length === 0) {
        container.innerHTML = '<p class="text-center muted py-8">Nenhum acerto cadastrado</p>';
        return;
      }

      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      const html = `
        <table class="table w-full">
          <thead>
            <tr>
              <th class="text-left">Data</th>
              <th class="text-left">De</th>
              <th class="text-left">Para</th>
              <th class="text-left">Valor</th>
              <th class="text-left">Descri√ß√£o</th>
              <th class="text-left">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${state.acertos.map(a => `
              <tr>
                <td>${new Date(a.data).toLocaleDateString('pt-BR')}</td>
                <td>${escapeHtml(a.de === 'A' ? socioA : socioB)}</td>
                <td>${escapeHtml(a.para === 'A' ? socioA : socioB)}</td>
                <td class="font-bold">R$ ${a.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${escapeHtml(a.descricao)}</td>
                <td>
                  <button onclick="window.deleteAcerto('${a.id}')" class="text-red-600 hover:underline">üóëÔ∏è</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // CONFIG VIEW
    function renderConfigView() {
      $("socio-a").value = state.config.socioA || "";
      $("socio-b").value = state.config.socioB || "";

      renderDeducoesList();
    }

    function renderDeducoesList() {
      const container = $("ded-list");
      if (state.deducoes.length === 0) {
        container.innerHTML = '<p class="muted">Nenhuma dedu√ß√£o cadastrada</p>';
        return;
      }

      const html = state.deducoes.map(d => {
        const tipo = d.tipo || 'percentual';
        const base = d.base || 'lucro';
        const valor = d.valor || d.percentual || 0;
        
        let displayValor = tipo === 'percentual' ? `${valor.toFixed(2)}%` : `R$ ${valor.toFixed(2)}`;
        let displayBase = base === 'lucro' ? 'Lucro Bruto' : 'VGV';
        
        return `
          <div class="flex justify-between items-center p-2 border rounded">
            <div class="flex-1">
              <div class="font-bold text-sm">${escapeHtml(d.nome)}</div>
              <div class="text-xs muted">${displayValor} sobre ${displayBase}</div>
            </div>
            <button onclick="window.deleteDeducao('${d.id}')" class="text-red-600 hover:underline text-sm ml-2">üóëÔ∏è</button>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    // MODALS
    function openModal(id) {
      $(id).classList.remove("hidden");
      $(id).classList.add("flex");
    }

    function closeModal(id) {
      $(id).classList.add("hidden");
      $(id).classList.remove("flex");
    }

    function renderObrasModal() {
      const container = $("obras-list");
      if (state.obras.length === 0) {
        container.innerHTML = '<p class="muted">Nenhuma obra cadastrada</p>';
        return;
      }

      const html = state.obras.map(o => `
        <div class="flex justify-between items-center p-3 border rounded">
          <span class="font-bold">${escapeHtml(o.nome)}</span>
          <button onclick="window.deleteObra('${o.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è Deletar</button>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function renderUnidadesModal() {
      const container = $("unidades-list");
      if (state.unidades.length === 0) {
        container.innerHTML = '<p class="muted">Nenhuma unidade cadastrada</p>';
        return;
      }

      const statusLabels = {
        disponivel: 'üü¢ Dispon√≠vel',
        reservada: 'üü° Reservada',
        vendida: 'üî¥ Vendida'
      };

      const proprietarioLabels = {
        A: 'üë§ S√≥cio A',
        B: 'üë§ S√≥cio B',
        ambos: 'üë• Ambos (50/50)'
      };

      const html = state.unidades.map(u => `
        <div class="flex justify-between items-center p-3 border rounded">
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <div class="font-bold">${escapeHtml(u.nome)}</div>
              <span class="text-xs badge">${statusLabels[u.status || 'disponivel'] || u.status}</span>
              <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${proprietarioLabels[u.proprietario || 'ambos'] || 'üë• Ambos'}</span>
            </div>
            <div class="text-xs muted">
              VGV: R$ ${(u.vgvPrevisto || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
              ${u.valorVenda ? ` | Vendida por: R$ ${u.valorVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : ''}
              ${u.areaConstruida ? ` | ${u.areaConstruida}m¬≤` : ''}
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="window.editUnidade('${u.id}')" class="text-blue-600 hover:underline text-sm">‚úèÔ∏è Editar</button>
            <button onclick="window.deleteUnidade('${u.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function renderFornecedoresModal() {
      const container = $("fornecedores-list");
      if (state.fornecedores.length === 0) {
        container.innerHTML = '<p class="muted">Nenhum fornecedor cadastrado</p>';
        return;
      }

      const html = state.fornecedores.map(f => `
        <div class="flex justify-between items-center p-3 border rounded">
          <div>
            <div class="font-bold">${escapeHtml(f.nome)}</div>
            <div class="text-xs muted">${escapeHtml(f.contato || '-')} ${f.documento ? '‚Ä¢ ' + f.documento : ''}</div>
          </div>
          <button onclick="window.deleteFornecedor('${f.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è</button>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function renderCategoriasModal() {
      const container = $("categorias-list");
      if (state.categorias.length === 0) {
        container.innerHTML = '<p class="muted">Nenhuma categoria cadastrada</p>';
        return;
      }

      const html = state.categorias.map(c => `
        <div class="flex justify-between items-center p-3 border rounded">
          <div class="flex items-center gap-2">
            <div style="width: 16px; height: 16px; border-radius: 4px; background: ${c.cor || '#ccc'};"></div>
            <div>
              <div class="font-bold">${escapeHtml(c.nome)}</div>
              ${c.grupo ? `<div class="text-xs muted">Grupo: ${escapeHtml(c.grupo)}</div>` : ''}
            </div>
          </div>
          <button onclick="window.deleteCategoria('${c.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è</button>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // CRUD FUNCTIONS
    async function createObra() {
      const nome = $("obra-new-nome").value.trim();
      const dataInicio = $("obra-new-inicio").value || null;
      const dataRecebimento = $("obra-new-recebimento").value || null;
      
      if (!nome) {
        showToast('Digite o nome da obra', 'warning');
        return;
      }

      try {
        await addDoc(refs("dummy").obrasCol, {
          nome,
          dataInicio,
          dataRecebimento,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("obra-new-nome").value = "";
        $("obra-new-inicio").value = "";
        $("obra-new-recebimento").value = "";
        showToast('Obra criada com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar obra', 'error');
      }
    }

    async function createUnidade() {
      const nome = $("unid-new-nome").value.trim();
      const area = parseFloat($("unid-new-area").value) || 0;
      const status = $("unid-new-status").value;
      const proprietario = $("unid-new-proprietario").value;
      const vgv = parseFloat($("unid-new-vgv").value) || 0;
      const valorVenda = parseFloat($("unid-new-venda").value) || null;

      if (!nome) {
        showToast('Digite o nome da unidade', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).unidadesCol, {
          nome,
          areaConstruida: area,
          status,
          proprietario,
          vgvPrevisto: vgv,
          valorVenda,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("unid-new-nome").value = "";
        $("unid-new-area").value = "";
        $("unid-new-proprietario").value = "ambos";
        $("unid-new-vgv").value = "";
        $("unid-new-venda").value = "";
        showToast('Unidade criada com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar unidade', 'error');
      }
    }

    async function createFornecedor() {
      const nome = $("forn-nome").value.trim();
      const contato = $("forn-contato").value.trim();
      const doc = $("forn-doc").value.trim();

      if (!nome) {
        showToast('Digite o nome do fornecedor', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).fornecedoresCol, {
          nome,
          contato: contato || null,
          documento: doc || null,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("forn-nome").value = "";
        $("forn-contato").value = "";
        $("forn-doc").value = "";
        showToast('Fornecedor criado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar fornecedor', 'error');
      }
    }

    async function createCategoria() {
      const nome = $("cat-nome").value.trim();
      const grupo = $("cat-grupo").value.trim();
      const cor = $("cat-cor").value;

      if (!nome) {
        showToast('Digite o nome da categoria', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).categoriasCol, {
          nome,
          grupo: grupo || null,
          cor: cor || "#3b82f6",
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("cat-nome").value = "";
        $("cat-grupo").value = "";
        showToast('Categoria criada com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar categoria', 'error');
      }
    }

    async function createDeducao() {
      const nome = $("ded-nome").value.trim();
      const tipo = $("ded-tipo").value;
      const base = $("ded-base").value;
      const valor = parseFloat($("ded-valor").value);

      if (!nome || !valor || valor <= 0) {
        showToast('Preencha todos os campos corretamente', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).deducoesCol, {
          nome,
          tipo,
          base,
          valor,
          // Manter compatibilidade com dados antigos
          percentual: tipo === 'percentual' ? valor : 0,
          createdAt: serverTimestamp()
        });
        $("ded-nome").value = "";
        $("ded-valor").value = "";
        showToast('Dedu√ß√£o criada com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar dedu√ß√£o', 'error');
      }
    }

    async function saveSocios() {
      const socioA = $("socio-a").value.trim() || "S√≥cio A";
      const socioB = $("socio-b").value.trim() || "S√≥cio B";

      try {
        await setDoc(refs(OBRA_ID).configDoc, {
          socioA,
          socioB,
          updatedAt: serverTimestamp()
        }, { merge: true });
        showToast('S√≥cios salvos com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao salvar s√≥cios', 'error');
      }
    }

    async function addLancamento(e) {
      e.preventDefault();

      const data = $("lanc-data").value;
      const vencimento = $("lanc-vencimento").value || null;
      const competencia = $("lanc-competencia").value || data;
      const unidadeId = $("lanc-unidade").value;
      const categoriaId = $("lanc-categoria").value;
      const fornecedorId = $("lanc-fornecedor").value;
      const pagador = $("lanc-pagador").value;
      const valor = parseFloat($("lanc-valor").value);
      const status = $("lanc-status").value;
      const descricao = $("lanc-descricao").value.trim();
      const comprovante = $("lanc-comprovante").value.trim();

      if (!data || !unidadeId || !categoriaId || !fornecedorId || !valor || !descricao) {
        showToast('Preencha todos os campos obrigat√≥rios', 'error');
        return;
      }

      // Valida√ß√£o de duplicatas
      const possiveisDuplicatas = state.lancamentos.filter(l =>
        l.fornecedorId === fornecedorId &&
        Math.abs(l.valor - valor) < 0.01 &&
        Math.abs(new Date(l.data) - new Date(data)) < 7 * 24 * 60 * 60 * 1000
      );

      if (possiveisDuplicatas.length > 0) {
        const fornecedorNome = state.fornecedores.find(f => f.id === fornecedorId)?.nome;
        if (!confirm(`‚ö†Ô∏è POSS√çVEL DUPLICATA!\n\nJ√° existe ${possiveisDuplicatas.length} lan√ßamento(s) similar(es):\n- Fornecedor: ${fornecedorNome}\n- Valor: R$ ${valor.toFixed(2)}\n- Data pr√≥xima\n\nDeseja continuar mesmo assim?`)) {
          return;
        }
      }

      try {
        await addDoc(refs(OBRA_ID).lancamentosCol, {
          data,
          dataVencimento: vencimento,
          dataCompetencia: competencia,
          unidadeId,
          categoriaId,
          fornecedorId,
          pagador,
          valor,
          status,
          descricao,
          comprovante: comprovante || null,
          createdAt: serverTimestamp(),
          createdBy: state.user.email,
          historico: [{
            acao: 'created',
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        $("lanc-form").reset();
        showToast('Lan√ßamento criado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar lan√ßamento', 'error');
      }
    }

    async function ratearIgualmente() {
      const fornecedorId = $("rat-fornecedor").value;
      const categoriaId = $("rat-categoria").value;
      const descricao = $("rat-descricao").value.trim();
      const valorTotal = parseFloat($("rat-valor-total").value);
      const data = $("rat-data").value;

      if (!fornecedorId || !categoriaId || !descricao || !valorTotal || !data) {
        showToast('Preencha os campos principais antes de ratear', 'warning');
        return;
      }

      if (state.unidades.length === 0) {
        showToast('Nenhuma unidade cadastrada', 'error');
        return;
      }

      if (!confirm(`Ratear R$ ${valorTotal.toFixed(2)} igualmente entre ${state.unidades.length} unidades?`)) {
        return;
      }

      const valorPorUnidade = valorTotal / state.unidades.length;
      const vencimento = $("rat-vencimento").value || null;
      const status = $("rat-status").value;

      try {
        await addDoc(refs(OBRA_ID).rateiosCol, {
          data,
          dataVencimento: vencimento,
          dataCompetencia: data,
          fornecedorId,
          categoriaId,
          descricao,
          valorTotal,
          status,
          distribuicao: state.unidades.map(u => ({
            unidadeId: u.id,
            valor: parseFloat(valorPorUnidade.toFixed(2))
          })),
          createdAt: serverTimestamp(),
          createdBy: state.user.email,
          historico: [{
            acao: 'created',
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        $("rat-form")?.reset();
        rateioDestCount = 0;
        $("rat-dests").innerHTML = "";
        rateioAddDest();
        showToast(`Rateio criado! R$ ${valorPorUnidade.toFixed(2)} por unidade`, 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar rateio', 'error');
      }
    }

    async function addRateio() {
      const data = $("rat-data").value;
      const vencimento = $("rat-vencimento").value || null;
      const status = $("rat-status").value;
      const fornecedorId = $("rat-fornecedor").value;
      const categoriaId = $("rat-categoria").value;
      const descricao = $("rat-descricao").value.trim();
      const valorTotal = parseFloat($("rat-valor-total").value);

      if (!data || !fornecedorId || !categoriaId || !descricao || !valorTotal) {
        showToast('Preencha todos os campos obrigat√≥rios', 'error');
        return;
      }

      // Collect destinations
      const distribuicao = [];
      const destEls = document.querySelectorAll(".rat-dest-unidade");
      for (let i = 0; i < destEls.length; i++) {
        const unidadeId = destEls[i].value;
        const valorInput = destEls[i].parentElement.parentElement.querySelector(".rat-dest-valor");
        const valor = parseFloat(valorInput.value);
        if (unidadeId && valor) {
          distribuicao.push({ unidadeId, valor });
        }
      }

      if (distribuicao.length === 0) {
        showToast('Adicione pelo menos um destino', 'warning');
        return;
      }

      const somaDistribuicao = distribuicao.reduce((sum, d) => sum + d.valor, 0);
      if (Math.abs(somaDistribuicao - valorTotal) > 0.01) {
        showToast(`A soma da distribui√ß√£o (R$ ${somaDistribuicao.toFixed(2)}) n√£o bate com o valor total (R$ ${valorTotal.toFixed(2)})`, 'error');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).rateiosCol, {
          data,
          dataVencimento: vencimento,
          dataCompetencia: data,
          fornecedorId,
          categoriaId,
          descricao,
          valorTotal,
          status,
          distribuicao,
          createdAt: serverTimestamp(),
          createdBy: state.user.email,
          historico: [{
            acao: 'created',
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        $("rat-data").value = "";
        $("rat-vencimento").value = "";
        $("rat-fornecedor").value = "";
        $("rat-categoria").value = "";
        $("rat-descricao").value = "";
        $("rat-valor-total").value = "";
        rateioDestCount = 0;
        $("rat-dests").innerHTML = "";
        rateioAddDest();
        showToast('Rateio criado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar rateio', 'error');
      }
    }

    async function addRecebimento(e) {
      e.preventDefault();

      const data = $("receb-data").value;
      const unidadeId = $("receb-unidade").value;
      const tipo = $("receb-tipo").value;
      const valor = parseFloat($("receb-valor").value);
      const formaPagamento = $("receb-forma").value;
      const recebidoPor = $("receb-recebido-por").value;
      const observacoes = $("receb-obs").value.trim();

      if (!data || !unidadeId || !valor || !recebidoPor) {
        showToast('Preencha todos os campos obrigat√≥rios', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).recebimentosCol, {
          data,
          unidadeId,
          tipo,
          valor,
          formaPagamento,
          recebidoPor,
          observacoes,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("receb-form").reset();
        showToast('Recebimento registrado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao registrar recebimento', 'error');
      }
    }

    async function addAcerto(e) {
      e.preventDefault();

      const data = $("ac-data").value;
      const de = $("ac-de").value;
      const para = $("ac-para").value;
      const valor = parseFloat($("ac-valor").value);
      const descricao = $("ac-descricao").value.trim();

      if (!data || !valor || !descricao || de === para) {
        showToast('Preencha corretamente (De ‚â† Para)', 'error');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).acertosCol, {
          data,
          de,
          para,
          valor,
          descricao,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("acerto-form").reset();
        showToast('Acerto registrado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao registrar acerto', 'error');
      }
    }

    // DELETE FUNCTIONS
    window.deleteObra = async (id) => {
      if (!confirm('Deletar obra? ATEN√á√ÉO: Todos os dados da obra ser√£o perdidos!')) return;
      try {
        await deleteDoc(doc(db, "obras", id));
        showToast('Obra deletada', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar obra', 'error');
      }
    };

    window.deleteUnidade = async (id) => {
      if (!confirm('Deletar unidade?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "unidades", id));
        showToast('Unidade deletada', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar unidade', 'error');
      }
    };

    window.editUnidade = async (id) => {
      const unidade = state.unidades.find(u => u.id === id);
      if (!unidade) return;

      // Preencher formul√°rio com dados atuais
      $("unid-new-nome").value = unidade.nome || "";
      $("unid-new-area").value = unidade.areaConstruida || "";
      $("unid-new-status").value = unidade.status || "disponivel";
      $("unid-new-proprietario").value = unidade.proprietario || "ambos";
      $("unid-new-vgv").value = unidade.vgvPrevisto || "";
      $("unid-new-venda").value = unidade.valorVenda || "";

      // Mudar bot√£o para modo edi√ß√£o
      const btn = $("unid-create");
      btn.textContent = "üíæ Salvar Altera√ß√µes";
      btn.onclick = async () => {
        const nome = $("unid-new-nome").value.trim();
        const area = parseFloat($("unid-new-area").value) || 0;
        const status = $("unid-new-status").value;
        const proprietario = $("unid-new-proprietario").value;
        const vgv = parseFloat($("unid-new-vgv").value) || 0;
        const valorVenda = parseFloat($("unid-new-venda").value) || null;

        if (!nome) {
          showToast('Digite o nome da unidade', 'warning');
          return;
        }

        try {
          await updateDoc(doc(db, "obras", OBRA_ID, "unidades", id), {
            nome,
            areaConstruida: area,
            status,
            proprietario,
            vgvPrevisto: vgv,
            valorVenda,
            updatedAt: serverTimestamp()
          });
          
          // Resetar formul√°rio e bot√£o
          $("unid-new-nome").value = "";
          $("unid-new-area").value = "";
          $("unid-new-vgv").value = "";
          $("unid-new-venda").value = "";
          btn.textContent = "Criar Unidade";
          btn.onclick = createUnidade;
          
          showToast('Unidade atualizada com sucesso!', 'success');
        } catch (err) {
          console.error(err);
          showToast('Erro ao atualizar unidade', 'error');
        }
      };

      // Scroll para o formul√°rio
      $("unid-new-nome").scrollIntoView({ behavior: 'smooth', block: 'center' });
      $("unid-new-nome").focus();
    };

    window.sugerirAcerto = async () => {
      const eq = computeEqualizacao();
      if (!eq || !eq.mensagem) {
        showToast('N√£o h√° acerto pendente', 'info');
        return;
      }

      // Determinar quem deve pagar para quem
      let de, para, valor;
      if (eq.saldoFinalA > 0) {
        // A tem a receber, B deve pagar para A
        de = "B";
        para = "A";
        valor = Math.abs(eq.saldoFinalA);
      } else {
        // B tem a receber, A deve pagar para B
        de = "A";
        para = "B";
        valor = Math.abs(eq.saldoFinalB);
      }

      // Navegar para a view de acertos
      navigateTo('ACERTOS');

      // Aguardar um pouco para garantir que a view foi carregada
      await new Promise(resolve => setTimeout(resolve, 100));

      // Preencher formul√°rio
      const hoje = new Date().toISOString().split('T')[0];
      $("ac-data").value = hoje;
      $("ac-de").value = de;
      $("ac-para").value = para;
      $("ac-valor").value = valor.toFixed(2);
      $("ac-descricao").value = `Equaliza√ß√£o autom√°tica - ${new Date().toLocaleDateString('pt-BR')}`;

      // Focar no campo de descri√ß√£o
      $("ac-descricao").focus();
      $("ac-descricao").select();

      showToast('‚ú® Formul√°rio preenchido! Revise e salve o acerto.', 'success');
    };

    window.deleteFornecedor = async (id) => {
      if (!confirm('Deletar fornecedor?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "fornecedores", id));
        showToast('Fornecedor deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar fornecedor', 'error');
      }
    };

    window.deleteCategoria = async (id) => {
      if (!confirm('Deletar categoria?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "categorias", id));
        showToast('Categoria deletada', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar categoria', 'error');
      }
    };

    window.deleteDeducao = async (id) => {
      if (!confirm('Deletar dedu√ß√£o?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "deducoes", id));
        showToast('Dedu√ß√£o deletada', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar dedu√ß√£o', 'error');
      }
    };

    window.deleteLancamento = async (id) => {
      if (!confirm('Deletar lan√ßamento?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "lancamentos", id));
        showToast('Lan√ßamento deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar lan√ßamento', 'error');
      }
    };

    window.deleteRateio = async (id) => {
      if (!confirm('Deletar rateio?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "rateios", id));
        showToast('Rateio deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar rateio', 'error');
      }
    };

    window.deleteAcerto = async (id) => {
      if (!confirm('Deletar acerto?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "acertos", id));
        showToast('Acerto deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar acerto', 'error');
      }
    };

    window.deleteRecebimento = async (id) => {
      if (!confirm('Deletar recebimento?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "recebimentos", id));
        showToast('Recebimento deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar recebimento', 'error');
      }
    };

    // STATUS CHANGE
    window.mudarStatusLancamento = async (id) => {
      const lancamento = state.lancamentos.find(l => l.id === id);
      if (!lancamento) return;

      const statusAtual = lancamento.status || "pendente";
      const proximoStatus = {
        "pendente": "pago",
        "pago": "pendente",
        "atrasado": "pago"
      };

      const novoStatus = proximoStatus[statusAtual];

      try {
        await updateDoc(doc(db, "obras", OBRA_ID, "lancamentos", id), {
          status: novoStatus,
          historico: [...(lancamento.historico || []), {
            acao: 'status_changed',
            de: statusAtual,
            para: novoStatus,
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        showToast(`Status alterado para: ${novoStatus}`, 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao alterar status', 'error');
      }
    };

    window.mudarStatusRateio = async (id) => {
      const rateio = state.rateios.find(r => r.id === id);
      if (!rateio) return;

      const statusAtual = rateio.status || "pendente";
      const proximoStatus = {
        "pendente": "pago",
        "pago": "pendente",
        "atrasado": "pago"
      };

      const novoStatus = proximoStatus[statusAtual];

      try {
        await updateDoc(doc(db, "obras", OBRA_ID, "rateios", id), {
          status: novoStatus,
          historico: [...(rateio.historico || []), {
            acao: 'status_changed',
            de: statusAtual,
            para: novoStatus,
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        showToast(`Status alterado para: ${novoStatus}`, 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao alterar status', 'error');
      }
    };

    // COMPUTE FUNCTIONS
    function computeCustoTotal(lancs = null, rats = null) {
      if (!lancs) lancs = getLancamentosFiltrados();
      if (!rats) rats = getRateiosFiltrados();

      const custoLanc = lancs.reduce((sum, l) => sum + l.valor, 0);
      const custoRat = rats.reduce((sum, r) => sum + r.valorTotal, 0);
      return custoLanc + custoRat;
    }

    function computeLucro(lancs = null, rats = null) {
      if (!lancs) lancs = getLancamentosFiltrados();
      if (!rats) rats = getRateiosFiltrados();

      // Usa valor real de venda quando dispon√≠vel, sen√£o usa VGV previsto
      const vgvTotal = state.unidades.reduce((sum, u) => sum + (u.valorVenda || u.vgvPrevisto || 0), 0);
      const custoTotal = computeCustoTotal(lancs, rats);
      const lucroBruto = vgvTotal - custoTotal;

      let valorDeducoes = 0;
      const deducoesAplicadas = [];
      
      state.deducoes.forEach(d => {
        let valorDeducao = 0;
        const tipo = d.tipo || 'percentual';
        const base = d.base || 'lucro';
        const valor = d.valor || d.percentual || 0;
        
        if (tipo === 'percentual') {
          // Aplica percentual sobre a base escolhida
          const baseCalculo = base === 'venda' || base === 'vgv' ? vgvTotal : lucroBruto;
          valorDeducao = (valor / 100) * baseCalculo;
        } else {
          // Valor fixo n√£o precisa de c√°lculo
          valorDeducao = valor;
        }
        
        valorDeducoes += valorDeducao;
        deducoesAplicadas.push({ 
          ...d, 
          valorDeducao,
          displayTipo: tipo === 'percentual' ? `${valor.toFixed(2)}%` : `R$ ${valor.toFixed(2)}`,
          displayBase: base === 'lucro' ? 'Lucro Bruto' : 'Valor de Venda'
        });
      });

      const lucroLiquido = lucroBruto - valorDeducoes;

      const lucroLiquidoA = lucroLiquido / 2;
      const lucroLiquidoB = lucroLiquido / 2;

      return {
        vgvTotal,
        custoTotal,
        lucroBruto,
        valorDeducoes,
        deducoes: deducoesAplicadas,
        lucroLiquido,
        lucroLiquidoA,
        lucroLiquidoB
      };
    }

    function computeEqualizacao() {
      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      // 1. RECEBIMENTOS
      let recebeuFisicamenteA = 0; // Quanto A recebeu fisicamente
      let recebeuFisicamenteB = 0; // Quanto B recebeu fisicamente
      let temDireitoA = 0; // Quanto A tem direito (baseado no propriet√°rio)
      let temDireitoB = 0; // Quanto B tem direito (baseado no propriet√°rio)

      state.recebimentos.forEach(r => {
        const recebidoPor = r.recebidoPor || "ambos";
        const unidade = state.unidades.find(u => u.id === r.unidadeId);
        const proprietario = unidade?.proprietario || "ambos";

        // Quem recebeu fisicamente
        if (recebidoPor === "A") {
          recebeuFisicamenteA += r.valor;
        } else if (recebidoPor === "B") {
          recebeuFisicamenteB += r.valor;
        } else {
          recebeuFisicamenteA += r.valor / 2;
          recebeuFisicamenteB += r.valor / 2;
        }

        // Quem tem direito (baseado no propriet√°rio da unidade)
        if (proprietario === "A") {
          temDireitoA += r.valor;
        } else if (proprietario === "B") {
          temDireitoB += r.valor;
        } else {
          temDireitoA += r.valor / 2;
          temDireitoB += r.valor / 2;
        }
      });

      const totalRecebido = recebeuFisicamenteA + recebeuFisicamenteB;

      // Diferen√ßa entre o que recebeu fisicamente e o que tem direito
      // Se A recebeu mais do que tem direito, deve passar para B
      const deveRepassarA = recebeuFisicamenteA - temDireitoA; // Positivo = deve passar, Negativo = deve receber
      const deveRepassarB = recebeuFisicamenteB - temDireitoB;

      // 2. GASTOS (Dinheiro que saiu - quem efetivamente pagou)
      let pagouA = 0;
      let pagouB = 0;

      state.lancamentos.forEach(l => {
        if (l.pagador === "A") {
          pagouA += l.valor;
        } else {
          pagouB += l.valor;
        }
      });

      state.rateios.forEach(r => {
        const totalRateio = r.distribuicao?.reduce((sum, d) => sum + d.valor, 0) || 0;
        if (r.pagador === "A") {
          pagouA += totalRateio;
        } else {
          pagouB += totalRateio;
        }
      });

      // Total de gastos
      const totalGasto = pagouA + pagouB;

      // 3. CADA UM DEVERIA PAGAR METADE DOS GASTOS
      const deveGastarA = totalGasto / 2;
      const deveGastarB = totalGasto / 2;

      // 4. DIFEREN√áA DE GASTOS
      // Se A pagou mais que devia, B deve para A
      const diferencaGastosA = pagouA - deveGastarA;
      const diferencaGastosB = pagouB - deveGastarB;

      // 5. SALDO BRUTO (antes de acertos)
      // Combina: (quanto deve repassar de recebimentos) + (quanto deve receber de gastos)
      // Se deveRepassarA √© positivo (recebeu mais), diminui o saldo
      // Se diferencaGastosA √© positivo (pagou mais), aumenta o saldo
      let saldoBrutoA = diferencaGastosA - deveRepassarA;
      let saldoBrutoB = diferencaGastosB - deveRepassarB;

      // 6. APLICAR ACERTOS (transfer√™ncias entre s√≥cios)
      let saldoFinalA = saldoBrutoA;
      let saldoFinalB = saldoBrutoB;

      state.acertos.forEach(a => {
        if (a.de === "A" && a.para === "B") {
          // A transferiu dinheiro para B
          saldoFinalA -= a.valor;  // A diminui saldo (deu dinheiro)
          saldoFinalB += a.valor;  // B aumenta saldo (recebeu dinheiro)
        } else if (a.de === "B" && a.para === "A") {
          // B transferiu dinheiro para A
          saldoFinalB -= a.valor;
          saldoFinalA += a.valor;
        }
      });

      // 7. SALDO DE CAIXA (informativo)
      const saldoCaixaA = recebeuFisicamenteA - pagouA;
      const saldoCaixaB = recebeuFisicamenteB - pagouB;

      // Retornar dados completos para exibi√ß√£o
      return {
        socioA,
        socioB,
        recebeuA: recebeuFisicamenteA,
        recebeuB: recebeuFisicamenteB,
        temDireitoA,
        temDireitoB,
        deveRepassarA,
        deveRepassarB,
        pagouA,
        pagouB,
        deveGastarA,
        deveGastarB,
        saldoCaixaA,
        saldoCaixaB,
        diferencaGastosA,
        diferencaGastosB,
        saldoBrutoA,
        saldoBrutoB,
        saldoFinalA,
        saldoFinalB,
        totalRecebido,
        totalGasto,
        mensagem: getSugestaoEqualizacao(saldoFinalA, saldoFinalB, socioA, socioB)
      };
    }

    function getSugestaoEqualizacao(saldoA, saldoB, nomeA, nomeB) {
      if (Math.abs(saldoA) < 1 && Math.abs(saldoB) < 1) {
        return null;
      }

      if (saldoA > 0) {
        // A pagou a mais, ent√£o B deve para A
        return `${nomeB} deve transferir R$ ${Math.abs(saldoA).toFixed(2)} para ${nomeA}`;
      } else {
        // A pagou a menos, ent√£o A deve para B
        return `${nomeA} deve transferir R$ ${Math.abs(saldoA).toFixed(2)} para ${nomeB}`;
      }
    }

    // PDF EXPORT
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');

      // Header com logo e t√≠tulo
      pdf.setFillColor(15, 23, 42);
      pdf.rect(0, 0, 210, 35, 'F');
      pdf.setTextColor(255, 255, 255);
      pdf.setFontSize(24);
      pdf.setFont(undefined, 'bold');
      pdf.text("üèóÔ∏è VG CONSTRUTORA", 105, 15, { align: 'center' });
      pdf.setFontSize(14);
      pdf.text("RELAT√ìRIO GERENCIAL COMPLETO", 105, 25, { align: 'center' });

      const obra = state.obras.find(o => o.id === OBRA_ID);
      pdf.setTextColor(0, 0, 0);
      pdf.setFontSize(11);
      pdf.text(`Obra: ${obra?.nome || "N/A"}`, 14, 45);
      pdf.text(`Data de Emiss√£o: ${new Date().toLocaleDateString('pt-BR')}`, 14, 50);
      pdf.text(`Gerado por: ${state.user.email}`, 14, 55);

      // Linha separadora
      pdf.setDrawColor(203, 213, 225);
      pdf.line(14, 60, 196, 60);

      const lancs = getLancamentosFiltrados();
      const rats = getRateiosFiltrados();
      const custoTotal = computeCustoTotal(lancs, rats);
      const lucroData = computeLucro(lancs, rats);
      const totalRecebido = state.recebimentos.reduce((sum, r) => sum + r.valor, 0);
      const aReceber = lucroData.vgvTotal - totalRecebido;
      const fluxoCaixa = totalRecebido - custoTotal;

      // KPIs Principais
      let y = 70;
      pdf.setFillColor(241, 245, 249);
      pdf.rect(14, y, 182, 8, 'F');
      pdf.setFontSize(13);
      pdf.setFont(undefined, 'bold');
      pdf.text("üìä INDICADORES FINANCEIROS", 105, y + 6, { align: 'center' });

      y += 15;
      pdf.setFontSize(10);
      pdf.setFont(undefined, 'normal');
      
      const kpis = [
        { label: 'üí∞ Custo Total', value: custoTotal },
        { label: 'üíé VGV Previsto', value: lucroData.vgvTotal },
        { label: 'üíµ Recebido', value: totalRecebido },
        { label: 'üìä A Receber', value: aReceber },
        { label: 'üè¶ Fluxo de Caixa', value: fluxoCaixa },
        { label: 'üìà Lucro Bruto', value: lucroData.lucroBruto },
        { label: 'üíµ Lucro L√≠quido', value: lucroData.lucroLiquido }
      ];

      kpis.forEach((kpi, i) => {
        const col = i % 2;
        const row = Math.floor(i / 2);
        const x = 14 + (col * 95);
        const yPos = y + (row * 8);
        
        pdf.text(kpi.label, x, yPos);
        pdf.setFont(undefined, 'bold');
        const color = kpi.value >= 0 ? [5, 150, 105] : [220, 38, 38];
        pdf.setTextColor(...color);
        pdf.text(`R$ ${kpi.value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, x + 85, yPos, { align: 'right' });
        pdf.setTextColor(0, 0, 0);
        pdf.setFont(undefined, 'normal');
      });

      y += 40;

      // ROI e M√©tricas Avan√ßadas
      if (obra?.dataInicio) {
        const inicio = new Date(obra.dataInicio);
        const fim = obra.dataRecebimento ? new Date(obra.dataRecebimento) : new Date();
        const diasOperacao = Math.floor((fim - inicio) / (1000 * 60 * 60 * 24));
        const mesesOperacao = diasOperacao / 30;
        const roi = custoTotal > 0 ? ((lucroData.lucroLiquido / custoTotal) * 100) : 0;
        const roiMensal = mesesOperacao > 0 ? (roi / mesesOperacao) : 0;

        pdf.setFillColor(241, 245, 249);
        pdf.rect(14, y, 182, 8, 'F');
        pdf.setFont(undefined, 'bold');
        pdf.setFontSize(13);
        pdf.text("üìà AN√ÅLISE DE RENTABILIDADE", 105, y + 6, { align: 'center' });

        y += 15;
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');

        pdf.text(`üìÖ In√≠cio da Constru√ß√£o: ${inicio.toLocaleDateString('pt-BR')}`, 14, y);
        y += 6;
        pdf.text(`‚è±Ô∏è Tempo de Opera√ß√£o: ${diasOperacao} dias (${mesesOperacao.toFixed(1)} meses)`, 14, y);
        y += 6;
        pdf.setFont(undefined, 'bold');
        pdf.setTextColor(59, 130, 246);
        pdf.text(`üìä ROI Total: ${roi.toFixed(2)}%`, 14, y);
        pdf.setTextColor(99, 102, 241);
        pdf.text(`üìà ROI Mensal: ${roiMensal.toFixed(2)}%/m√™s`, 110, y);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont(undefined, 'normal');
        y += 10;
      }

      // Lucro por S√≥cio
      pdf.setFillColor(241, 245, 249);
      pdf.rect(14, y, 182, 8, 'F');
      pdf.setFont(undefined, 'bold');
      pdf.setFontSize(13);
      pdf.text("üë• DISTRIBUI√á√ÉO POR S√ìCIO (50/50)", 105, y + 6, { align: 'center' });

      y += 15;
      pdf.setFontSize(10);
      pdf.setFont(undefined, 'normal');

      const investimentoPorSocio = custoTotal / 2;
      const lucroPorSocio = lucroData.lucroLiquido / 2;

      pdf.text(`üë§ ${state.config.socioA || 'S√≥cio A'}`, 14, y);
      pdf.text(`Investimento: R$ ${investimentoPorSocio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 24, y + 6);
      pdf.setFont(undefined, 'bold');
      pdf.setTextColor(5, 150, 105);
      pdf.text(`Lucro: R$ ${lucroPorSocio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 24, y + 12);
      pdf.setTextColor(0, 0, 0);
      pdf.setFont(undefined, 'normal');

      y += 22;
      pdf.text(`üë§ ${state.config.socioB || 'S√≥cio B'}`, 14, y);
      pdf.text(`Investimento: R$ ${investimentoPorSocio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 24, y + 6);
      pdf.setFont(undefined, 'bold');
      pdf.setTextColor(5, 150, 105);
      pdf.text(`Lucro: R$ ${lucroPorSocio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`, 24, y + 12);
      pdf.setTextColor(0, 0, 0);
      pdf.setFont(undefined, 'normal');

      y += 20;

      // Top 5 Categorias
      if (y > 240) {
        pdf.addPage();
        y = 20;
      }

      pdf.setFillColor(241, 245, 249);
      pdf.rect(14, y, 182, 8, 'F');
      pdf.setFont(undefined, 'bold');
      pdf.setFontSize(13);
      pdf.text("üèÜ TOP 5 CATEGORIAS", 105, y + 6, { align: 'center' });

      y += 15;
      pdf.setFontSize(9);
      pdf.setFont(undefined, 'normal');

      const custoPorCategoria = {};
      lancs.forEach(l => {
        const cat = state.categorias.find(c => c.id === l.categoriaId);
        const nome = cat?.nome || 'Sem categoria';
        custoPorCategoria[nome] = (custoPorCategoria[nome] || 0) + l.valor;
      });
      rats.forEach(r => {
        const cat = state.categorias.find(c => c.id === r.categoriaId);
        const nome = cat?.nome || 'Sem categoria';
        custoPorCategoria[nome] = (custoPorCategoria[nome] || 0) + r.valorTotal;
      });

      const topCategorias = Object.entries(custoPorCategoria)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      topCategorias.forEach(([nome, valor], i) => {
        const perc = custoTotal > 0 ? (valor / custoTotal * 100) : 0;
        pdf.text(`${i + 1}. ${nome}`, 14, y);
        pdf.text(`R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${perc.toFixed(1)}%)`, 160, y, { align: 'right' });
        y += 6;
      });

      // Footer
      const pageCount = pdf.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        pdf.setPage(i);
        pdf.setFillColor(241, 245, 249);
        pdf.rect(0, 287, 210, 10, 'F');
        pdf.setFontSize(8);
        pdf.setTextColor(100, 116, 139);
        pdf.text(`VG CONSTRUTORA - Sistema de Gest√£o de Obras`, 105, 293, { align: 'center' });
        pdf.text(`P√°gina ${i} de ${pageCount}`, 196, 293, { align: 'right' });
      }

      const filename = `VG_${obra?.nome || 'Obra'}_${new Date().toISOString().split('T')[0]}.pdf`;
      pdf.save(filename);
      showToast('Relat√≥rio PDF gerado com sucesso!', 'success');
    }

  </script>
</body>
</html>
