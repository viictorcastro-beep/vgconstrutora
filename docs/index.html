<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>VG CONSTRUTORA ‚Äî Gestor de Obras</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { background:#f1f5f9; }
    .hidden { display:none !important; }
    .modal { background: rgba(0,0,0,.55); }
    .chip { font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#e2e8f0; }
    .btn { border-radius: 12px; font-weight: 700; padding: 10px 14px; }
    .btn-dark { background:#0f172a; color:white; }
    .btn-dark:hover { background:#334155; }
    .btn-danger { background:#dc2626; color:white; }
    .btn-danger:hover { background:#b91c1c; }
    .btn-soft { background:#e2e8f0; color:#0f172a; }
    .btn-soft:hover { background:#cbd5e1; }
    .btn-green { background:#059669; color:white; }
    .btn-green:hover { background:#047857; }
    .btn-indigo { background:#4f46e5; color:white; }
    .btn-indigo:hover { background:#4338ca; }
    .btn-purple { background:#7c3aed; color:white; }
    .btn-purple:hover { background:#6d28d9; }
    .muted { color:#64748b; }
    .card { background:white; border-radius: 18px; box-shadow: 0 10px 24px rgba(15,23,42,.08); }
    .table th { background:#f1f5f9; font-weight:800; }
    .table td,.table th { padding:10px; }
    .input { border:1px solid #cbd5e1; border-radius:12px; padding:10px; width:100%; }
    .select { border:1px solid #cbd5e1; border-radius:12px; padding:10px; width:100%; background:white; }
    .danger { color:#dc2626; font-weight: 800; }
    .ok { color:#059669; font-weight: 800; }
    
    /* Toast Notifications */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px; }
    .toast { padding: 16px 20px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,.3); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 12px; font-weight: 700; }
    .toast.success { background: #059669; color: white; }
    .toast.error { background: #dc2626; color: white; }
    .toast.warning { background: #f59e0b; color: white; }
    .toast.info { background: #3b82f6; color: white; }
    .toast.hiding { animation: slideOut 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
    
    /* Status Badges */
    .badge { padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 700; display: inline-block; }
    .badge-pendente { background: #fef3c7; color: #92400e; }
    .badge-pago { background: #d1fae5; color: #065f46; }
    .badge-atrasado { background: #fee2e2; color: #991b1b; }
    
    /* Alert Boxes */
    .alert { border-left: 4px solid; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    .alert-warning { border-color: #f59e0b; background: #fffbeb; }
    .alert-danger { border-color: #ef4444; background: #fef2f2; }
    .alert-success { border-color: #10b981; background: #ecfdf5; }
    
    .empty-state { text-align:center; padding:60px 20px; color:#94a3b8; }
    .empty-state svg { width:80px; height:80px; margin:0 auto 20px; opacity:0.3; }
  </style>
</head>

<body class="text-slate-800">

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-6">
    <div class="card p-8 max-w-md w-full text-center">
      <div class="text-4xl font-black mb-2">üèóÔ∏è VG CONSTRUTORA</div>
      <div class="text-slate-600 mb-8">Gestor de Obras - Sistema Completo</div>
      
      <button id="login-btn" class="btn btn-dark w-full mb-3 flex items-center justify-center gap-2">
        <svg width="20" height="20" viewBox="0 0 48 48">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
          <path fill="none" d="M0 0h48v48H0z"/>
        </svg>
        <span id="login-btn-text">Entrar com Google</span>
      </button>
      
      <div id="login-msg" class="text-xs text-slate-500 mt-4 min-h-[16px]"></div>
      
      <button id="login-redirect-btn" class="hidden text-sm text-blue-600 hover:underline mt-2">
        M√©todo alternativo (redirect)
      </button>
      
      <div id="debug-info" class="hidden mt-6 p-4 bg-slate-100 rounded text-left text-xs">
        <div class="font-bold mb-2">Debug Info:</div>
        <div id="debug-content" class="space-y-1"></div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" class="hidden min-h-screen pb-20">
    
    <!-- Header -->
    <div class="bg-slate-900 text-white py-4 px-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="text-2xl font-black">üèóÔ∏è VG CONSTRUTORA</div>
        <select id="obra-select" class="select text-sm" onchange="switchObra()">
          <option value="">Carregando...</option>
        </select>
      </div>
      <div class="flex items-center gap-4">
        <button id="menu-obras" class="btn btn-soft text-sm">Obras</button>
        <button id="menu-unidades" class="btn btn-soft text-sm">Unidades</button>
        <button id="menu-fornecedores" class="btn btn-soft text-sm">Fornecedores</button>
        <button id="menu-categorias" class="btn btn-soft text-sm">Categorias</button>
        <div id="user-email" class="text-sm muted"></div>
        <button id="logout-btn" class="btn btn-danger text-sm">Sair</button>
      </div>
    </div>

    <!-- Content -->
    <div class="max-w-7xl mx-auto p-6">
      
      <!-- Alertas de Vencimento -->
      <div id="alertas-vencimento"></div>
      
      <!-- View Selector -->
      <div class="flex gap-3 mb-6">
        <button class="btn btn-dark view-btn" data-view="DASHBOARD">üìä Dashboard</button>
        <button class="btn btn-soft view-btn" data-view="LANCAMENTOS">üí∞ Lan√ßamentos</button>
        <button class="btn btn-soft view-btn" data-view="RATEIOS">‚öñÔ∏è Rateios</button>
        <button class="btn btn-soft view-btn" data-view="ACERTOS">ü§ù Acertos S√≥cios</button>
        <button class="btn btn-soft view-btn" data-view="CONFIG">‚öôÔ∏è Config</button>
      </div>

      <!-- DASHBOARD VIEW -->
      <div id="view-DASHBOARD" class="view-content">
        
        <!-- Filtros Avan√ßados -->
        <div class="card p-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
              <div class="text-xs muted mb-1">Per√≠odo</div>
              <select id="filter-periodo" class="select text-sm" onchange="rerender()">
                <option value="TODOS">Todos</option>
                <option value="MES_ATUAL">M√™s Atual</option>
                <option value="MES_ANTERIOR">M√™s Anterior</option>
                <option value="TRIMESTRE">√öltimo Trimestre</option>
                <option value="ANO">Ano Atual</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Status</div>
              <select id="filter-status" class="select text-sm" onchange="rerender()">
                <option value="TODOS">Todos</option>
                <option value="pendente">‚è≥ Pendente</option>
                <option value="pago">‚úÖ Pago</option>
                <option value="atrasado">üö® Atrasado</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Categoria</div>
              <select id="filter-categoria" class="select text-sm" onchange="rerender()">
                <option value="TODAS">Todas</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Fornecedor</div>
              <select id="filter-fornecedor" class="select text-sm" onchange="rerender()">
                <option value="TODOS">Todos</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Buscar</div>
              <input id="filter-text" type="text" class="input text-sm" placeholder="Descri√ß√£o..." oninput="rerender()" />
            </div>
          </div>
          <button id="filters-clear" class="btn btn-soft text-sm mt-3">Limpar Filtros</button>
        </div>

        <!-- KPIs -->
        <div id="kpis-grid" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"></div>
        
        <!-- Custo por m¬≤ -->
        <div id="custo-m2-section"></div>
        
        <!-- Analytics -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üèÜ Top 5 Categorias</div>
            <div id="top-categorias"></div>
          </div>
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üõí Top 5 Fornecedores</div>
            <div id="top-fornecedores"></div>
          </div>
        </div>
        
        <!-- Lucro Previsto -->
        <div class="card p-6 mt-6">
          <div class="font-black text-lg mb-4">üíé Lucro Previsto por S√≥cio</div>
          <div id="lucro-section"></div>
        </div>

        <!-- Equaliza√ß√£o -->
        <div class="card p-6 mt-6">
          <div class="font-black text-lg mb-4">‚öñÔ∏è Equaliza√ß√£o entre S√≥cios</div>
          <div id="equalizacao-section"></div>
        </div>

        <!-- Export -->
        <div class="mt-6 text-center">
          <button id="export-pdf-btn" class="btn btn-danger">üìÑ Exportar Dashboard PDF</button>
        </div>
      </div>

      <!-- LAN√áAMENTOS VIEW -->
      <div id="view-LANCAMENTOS" class="view-content hidden">
        <div class="card p-6 mb-6">
          <div class="font-black text-lg mb-4">üí∞ Novo Lan√ßamento</div>
          <form id="lanc-form">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Data *</div>
                <input id="lanc-data" type="date" class="input" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">Data Vencimento</div>
                <input id="lanc-vencimento" type="date" class="input" />
              </div>
              <div>
                <div class="text-xs muted mb-1">Data Compet√™ncia</div>
                <input id="lanc-competencia" type="date" class="input" />
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Unidade *</div>
                <select id="lanc-unidade" class="select" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div>
                <div class="text-xs muted mb-1">Categoria *</div>
                <select id="lanc-categoria" class="select" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Fornecedor *</div>
                <select id="lanc-fornecedor" class="select" required>
                  <option value="">Selecione...</option>
                </select>
              </div>
              <div>
                <div class="text-xs muted mb-1">Pagador (S√≥cio) *</div>
                <select id="lanc-pagador" class="select" required>
                  <option value="A">S√≥cio A</option>
                  <option value="B">S√≥cio B</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Valor * (R$)</div>
                <input id="lanc-valor" type="number" step="0.01" class="input" placeholder="1000.00" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">Status de Pagamento</div>
                <select id="lanc-status" class="select">
                  <option value="pendente">‚è≥ Pendente</option>
                  <option value="pago">‚úÖ Pago</option>
                  <option value="atrasado">üö® Atrasado</option>
                </select>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="text-xs muted mb-1">Descri√ß√£o *</div>
              <input id="lanc-descricao" type="text" class="input" placeholder="Ex: Material el√©trico..." required />
            </div>
            
            <div class="mb-4">
              <div class="text-xs muted mb-1">Link Comprovante (Google Drive)</div>
              <input id="lanc-comprovante" type="url" class="input" placeholder="https://drive.google.com/file/d/..." />
            </div>
            
            <div class="flex gap-3">
              <button type="submit" class="btn btn-green">üíæ Salvar Lan√ßamento</button>
              <button type="button" id="lanc-quick" class="btn btn-soft">‚ö° Atalho: Transit√≥rio</button>
            </div>
          </form>
        </div>

        <div class="card p-6">
          <div class="font-black text-lg mb-4">üìã Lista de Lan√ßamentos</div>
          <div id="lanc-list" class="overflow-x-auto"></div>
        </div>
      </div>

      <!-- RATEIOS VIEW -->
      <div id="view-RATEIOS" class="view-content hidden">
        <div class="card p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="font-black text-lg">‚öñÔ∏è Novo Rateio</div>
              <div class="text-xs muted mt-1">Distribua custos entre m√∫ltiplas obras/unidades</div>
            </div>
            <button id="rat-igual-btn" class="btn btn-purple text-sm">‚ö° Ratear Igualmente</button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
              <div class="text-xs muted mb-1">Data *</div>
              <input id="rat-data" type="date" class="input" required />
            </div>
            <div>
              <div class="text-xs muted mb-1">Data Vencimento</div>
              <input id="rat-vencimento" type="date" class="input" />
            </div>
            <div>
              <div class="text-xs muted mb-1">Status</div>
              <select id="rat-status" class="select">
                <option value="pendente">‚è≥ Pendente</option>
                <option value="pago">‚úÖ Pago</option>
                <option value="atrasado">üö® Atrasado</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <div class="text-xs muted mb-1">Fornecedor *</div>
              <select id="rat-fornecedor" class="select" required>
                <option value="">Selecione...</option>
              </select>
            </div>
            <div>
              <div class="text-xs muted mb-1">Categoria *</div>
              <select id="rat-categoria" class="select" required>
                <option value="">Selecione...</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <div class="text-xs muted mb-1">Descri√ß√£o *</div>
              <input id="rat-descricao" type="text" class="input" placeholder="Ex: Conta de luz" required />
            </div>
            <div>
              <div class="text-xs muted mb-1">Valor Total * (R$)</div>
              <input id="rat-valor-total" type="number" step="0.01" class="input" placeholder="1000.00" required />
            </div>
          </div>
          
          <div class="mb-4">
            <div class="font-bold mb-2">Distribui√ß√£o por Unidade:</div>
            <div id="rat-dests" class="space-y-2"></div>
            <button id="rat-add-dest" class="btn btn-soft text-sm mt-2">+ Adicionar Destino</button>
          </div>
          
          <button id="rat-save" class="btn btn-green">üíæ Salvar Rateio</button>
        </div>

        <div class="card p-6">
          <div class="font-black text-lg mb-4">üìã Lista de Rateios</div>
          <div id="rat-list"></div>
        </div>
      </div>

      <!-- ACERTOS VIEW -->
      <div id="view-ACERTOS" class="view-content hidden">
        <div class="card p-6 mb-6">
          <div class="font-black text-lg mb-4">ü§ù Novo Acerto entre S√≥cios</div>
          <form id="acerto-form">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Data *</div>
                <input id="ac-data" type="date" class="input" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">De (S√≥cio) *</div>
                <select id="ac-de" class="select" required>
                  <option value="A">S√≥cio A</option>
                  <option value="B">S√≥cio B</option>
                </select>
              </div>
              <div>
                <div class="text-xs muted mb-1">Para (S√≥cio) *</div>
                <select id="ac-para" class="select" required>
                  <option value="A">S√≥cio A</option>
                  <option value="B">S√≥cio B</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-xs muted mb-1">Valor * (R$)</div>
                <input id="ac-valor" type="number" step="0.01" class="input" placeholder="1000.00" required />
              </div>
              <div>
                <div class="text-xs muted mb-1">Descri√ß√£o *</div>
                <input id="ac-descricao" type="text" class="input" placeholder="Ex: Acerto m√™s 01/2026" required />
              </div>
            </div>
            
            <div class="flex gap-3">
              <button type="submit" class="btn btn-green">üíæ Salvar Acerto</button>
              <button type="button" id="acerto-sugerir" class="btn btn-indigo">üí° Sugerir Equaliza√ß√£o</button>
            </div>
          </form>
        </div>

        <div class="card p-6">
          <div class="font-black text-lg mb-4">üìã Hist√≥rico de Acertos</div>
          <div id="acerto-list"></div>
        </div>
      </div>

      <!-- CONFIG VIEW -->
      <div id="view-CONFIG" class="view-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card p-6">
            <div class="font-black text-lg mb-4">üë• Configurar S√≥cios</div>
            <div class="mb-3">
              <div class="text-xs muted mb-1">Nome S√≥cio A</div>
              <input id="socio-a" type="text" class="input" placeholder="Ex: Jo√£o" />
            </div>
            <div class="mb-3">
              <div class="text-xs muted mb-1">Nome S√≥cio B</div>
              <input id="socio-b" type="text" class="input" placeholder="Ex: Maria" />
            </div>
            <button id="socios-save" class="btn btn-green">üíæ Salvar</button>
          </div>

          <div class="card p-6">
            <div class="font-black text-lg mb-4">üí∏ Dedu√ß√µes de Lucro</div>
            <div class="text-xs muted mb-3">Impostos, taxas e outras dedu√ß√µes que reduzem o lucro</div>
            
            <div class="grid grid-cols-12 gap-2 mb-3">
              <div class="col-span-7">
                <input id="ded-nome" type="text" class="input text-sm" placeholder="Ex: INSS" />
              </div>
              <div class="col-span-3">
                <input id="ded-percent" type="number" step="0.01" class="input text-sm" placeholder="11.00" />
              </div>
              <div class="col-span-2">
                <button id="ded-create" class="btn btn-dark w-full text-sm">+</button>
              </div>
            </div>
            
            <div id="ded-list" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODALS -->
  <div id="modal-obras" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="card p-6 w-full max-w-3xl">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-xl">üèóÔ∏è Obras</div>
        <button data-close="modal-obras" class="btn btn-soft">Fechar</button>
      </div>

      <div class="grid grid-cols-12 gap-3 mb-4">
        <div class="col-span-9">
          <div class="text-xs muted mb-1">Nome da Obra</div>
          <input id="obra-new-nome" class="input" placeholder="Ex: Obra Residencial X" />
        </div>
        <div class="col-span-3 flex items-end">
          <button id="obra-create" class="btn btn-dark w-full">Criar Obra</button>
        </div>
      </div>

      <div>
        <div class="font-bold mb-2">Lista de Obras:</div>
        <div id="obras-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <div id="modal-unidades" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="card p-6 w-full max-w-3xl">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-xl">üè† Unidades (Casas)</div>
        <button data-close="modal-unidades" class="btn btn-soft">Fechar</button>
      </div>

      <div class="grid grid-cols-12 gap-3 mb-4">
        <div class="col-span-5">
          <div class="text-xs muted mb-1">Nome</div>
          <input id="unid-new-nome" class="input" placeholder="Ex: Casa A" />
        </div>
        <div class="col-span-4">
          <div class="text-xs muted mb-1">VGV Previsto (R$)</div>
          <input id="unid-new-vgv" type="number" step="0.01" class="input" placeholder="450000.00" />
        </div>
        <div class="col-span-3 flex items-end">
          <button id="unid-create" class="btn btn-dark w-full">Criar</button>
        </div>
      </div>

      <div>
        <div class="font-bold mb-2">Lista de Unidades:</div>
        <div id="unidades-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <div id="modal-fornecedores" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="card p-6 w-full max-w-3xl">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-xl">üõí Fornecedores</div>
        <button data-close="modal-fornecedores" class="btn btn-soft">Fechar</button>
      </div>

      <div class="grid grid-cols-12 gap-3 mb-4">
        <div class="col-span-4">
          <div class="text-xs muted mb-1">Nome</div>
          <input id="forn-nome" class="input" placeholder="Ex: Dep√≥sito X" />
        </div>
        <div class="col-span-3">
          <div class="text-xs muted mb-1">Contato</div>
          <input id="forn-contato" class="input" placeholder="(11) 99999-9999" />
        </div>
        <div class="col-span-3">
          <div class="text-xs muted mb-1">CNPJ/CPF</div>
          <input id="forn-doc" class="input" placeholder="Opcional" />
        </div>
        <div class="col-span-2 flex items-end">
          <button id="forn-create" class="btn btn-dark w-full">+</button>
        </div>
      </div>

      <div>
        <div class="font-bold mb-2">Lista de Fornecedores:</div>
        <div id="fornecedores-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <div id="modal-categorias" class="modal fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="card p-6 w-full max-w-3xl">
      <div class="flex items-center justify-between mb-4">
        <div class="font-black text-xl">üìÇ Categorias</div>
        <button data-close="modal-categorias" class="btn btn-soft">Fechar</button>
      </div>

      <div class="grid grid-cols-12 gap-3 mb-4">
        <div class="col-span-5">
          <div class="text-xs muted mb-1">Nome</div>
          <input id="cat-nome" class="input" placeholder="Ex: Material El√©trico" />
        </div>
        <div class="col-span-3">
          <div class="text-xs muted mb-1">Grupo</div>
          <input id="cat-grupo" class="input" placeholder="Ex: Materiais" />
        </div>
        <div class="col-span-2">
          <div class="text-xs muted mb-1">Cor</div>
          <input id="cat-cor" type="color" class="input" value="#3b82f6" />
        </div>
        <div class="col-span-2 flex items-end">
          <button id="cat-create" class="btn btn-dark w-full">+</button>
        </div>
      </div>

      <div>
        <div class="font-bold mb-2">Lista de Categorias:</div>
        <div id="categorias-list" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase imports
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js");
    const { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js");
    const { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, getDocs, onSnapshot, query, where, orderBy, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js");

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCOrMx8Hv2qRkoIBwBBVq4V2DONUa7T0lU",
      authDomain: "qd20-lt2-a-b.firebaseapp.com",
      projectId: "qd20-lt2-a-b",
      storageBucket: "qd20-lt2-a-b.firebasestorage.app",
      messagingSenderId: "648174167866",
      appId: "1:648174167866:web:98fb10be18b73fcc7a9203"
    };

    // Initialize
    console.log("üî• Inicializando Firebase...");
    console.log("Project ID:", firebaseConfig.projectId);
    console.log("Auth Domain:", firebaseConfig.authDomain);
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    
    console.log("‚úì Firebase inicializado");
    console.log("‚úì Auth configurado");
    console.log("‚úì Firestore configurado");

    // Whitelist
    const ALLOWED_EMAILS = ["viictor.castro@gmail.com", "gcm.conceicao@gmail.com"];

    // Utils
    const $ = (id) => document.getElementById(id);
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'info') {
      const container = $('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úì',
        error: '‚úó',
        warning: '‚ö†',
        info: '‚Ñπ'
      };
      
      toast.innerHTML = `<span style="font-size: 20px;">${icons[type]}</span><span>${escapeHtml(message)}</span>`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => toast.remove(), 300);
      }, 3500);
    }

    // Global state
    let VIEW = "DASHBOARD";
    let OBRA_ID = null;
    let filterText = "";
    let filterCategoria = "TODAS";
    let filterFornecedor = "TODOS";
    let filterPeriodo = "TODOS";
    let filterStatus = "TODOS";
    let rateioDestCount = 0;

    const state = {
      user: null,
      obras: [],
      unidades: [],
      categorias: [],
      fornecedores: [],
      deducoes: [],
      lancamentos: [],
      rateios: [],
      acertos: [],
      config: {}
    };

    const listeners = [];

    // Firestore refs
    function refs(obraId) {
      return {
        obrasCol: collection(db, "obras"),
        obraDoc: doc(db, "obras", obraId),
        unidadesCol: collection(db, "obras", obraId, "unidades"),
        categoriasCol: collection(db, "obras", obraId, "categorias"),
        fornecedoresCol: collection(db, "obras", obraId, "fornecedores"),
        deducoesCol: collection(db, "obras", obraId, "deducoes"),
        lancamentosCol: collection(db, "obras", obraId, "lancamentos"),
        rateiosCol: collection(db, "obras", obraId, "rateios"),
        acertosCol: collection(db, "obras", obraId, "acertos"),
        configDoc: doc(db, "obras", obraId, "config", "main")
      };
    }

    // AUTH
    onAuthStateChanged(auth, async (user) => {
      console.log("‚Üí Auth state:", user?.email || "deslogado");
      
      if (user) {
        if (!ALLOWED_EMAILS.includes(user.email)) {
          alert("‚õî Acesso negado. E-mail n√£o autorizado.");
          await signOut(auth);
          return;
        }
        
        state.user = user;
        $("user-email").textContent = user.email;
        $("login-screen").classList.add("hidden");
        $("app").classList.remove("hidden");
        
        subscribeObrasList();
        setupEventListeners();
        showToast(`Bem-vindo, ${user.email}!`, 'success');
      } else {
        state.user = null;
        $("login-screen").classList.remove("hidden");
        $("app").classList.add("hidden");
        listeners.forEach(unsub => unsub());
        listeners.length = 0;
      }
    });

    // Check redirect result
    getRedirectResult(auth).then((result) => {
      if (result?.user) {
        console.log("‚úì Login via redirect:", result.user.email);
      }
    }).catch((error) => {
      console.error("‚úó Erro redirect result:", error);
    });

    // Setup login buttons (needs to be before auth state changes)
    $("login-btn").onclick = handleLogin;
    $("login-redirect-btn").onclick = async () => {
      console.log("üîê Login via redirect");
      $("login-msg").textContent = "Redirecionando...";
      try {
        await signInWithRedirect(auth, provider);
      } catch (err) {
        console.error("‚úó Erro redirect:", err);
        showLoginError(err);
      }
    };

    function setupEventListeners() {
      // Modal triggers
      $("menu-obras").onclick = () => openModal("modal-obras");
      $("menu-unidades").onclick = () => openModal("modal-unidades");
      $("menu-fornecedores").onclick = () => openModal("modal-fornecedores");
      $("menu-categorias").onclick = () => openModal("modal-categorias");

      // View switching
      document.querySelectorAll(".view-btn").forEach(btn => {
        btn.onclick = () => {
          VIEW = btn.dataset.view;
          localStorage.setItem("view", VIEW);
          rerender();
        };
      });

      // Filters
      $("filters-clear").onclick = () => {
        $("filter-text").value = "";
        $("filter-categoria").value = "TODAS";
        $("filter-fornecedor").value = "TODOS";
        $("filter-periodo").value = "TODOS";
        $("filter-status").value = "TODOS";
        filterText = "";
        filterCategoria = "TODAS";
        filterFornecedor = "TODOS";
        filterPeriodo = "TODOS";
        filterStatus = "TODOS";
        rerender();
      };

      // CRUD buttons
      $("obra-create").onclick = createObra;
      $("unid-create").onclick = createUnidade;
      $("forn-create").onclick = createFornecedor;
      $("cat-create").onclick = createCategoria;
      $("ded-create").onclick = createDeducao;

      $("socios-save").onclick = saveSocios;
      $("logout-btn").onclick = () => signOut(auth);

      // Forms
      $("lanc-form").onsubmit = addLancamento;
      $("lanc-quick").onclick = () => {
        const trans = state.unidades.find(u => (u.nome||"").toLowerCase().includes("transit"));
        if (trans) $("lanc-unidade").value = trans.id;
      };

      $("rat-add-dest").onclick = rateioAddDest;
      $("rat-save").onclick = addRateio;
      $("rat-igual-btn").onclick = ratearIgualmente;

      $("acerto-form").onsubmit = addAcerto;
      $("acerto-sugerir").onclick = () => {
        const eq = computeEqualizacao();
        if (eq) {
          showToast(eq, 'info');
        } else {
          showToast('Sem sugest√£o (saldos zerados)', 'info');
        }
      };

      $("export-pdf-btn").onclick = exportPDF;

      // Modal close
      document.querySelectorAll("[data-close]").forEach(btn => {
        btn.onclick = () => closeModal(btn.dataset.close);
      });
    }

    async function handleLogin() {
      console.log("üîê Tentando login...");
      $("login-btn-text").textContent = "Conectando...";
      $("login-msg").textContent = "";
      
      try {
        console.log("‚Üí Tentando popup...");
        const result = await signInWithPopup(auth, provider);
        console.log("‚úì Login OK:", result.user.email);
        $("login-msg").textContent = "‚úì Login realizado!";
      } catch (err) {
        console.error("‚úó Erro popup:", err.code);
        $("login-btn-text").textContent = "Entrar com Google";
        
        if (err.code === "auth/popup-blocked" || err.code === "auth/popup-closed-by-user" || err.code === "auth/cancelled-popup-request") {
          console.log("‚Üí Popup falhou, tentando redirect...");
          $("login-redirect-btn").classList.remove("hidden");
          try {
            await signInWithRedirect(auth, provider);
            return;
          } catch (err2) {
            showLoginError(err2);
            return;
          }
        }
        
        showLoginError(err);
      }
    }

    function showLoginError(err) {
      let msg = "";
      let debugInfo = "";
      
      if (err.code === "auth/api-key-not-valid.-please-pass-a-valid-api-key.") {
        msg = "‚ö†Ô∏è API Key inv√°lida. Problema de configura√ß√£o do Firebase.";
        debugInfo = "A API key precisa ser verificada no Firebase Console > Project Settings > General";
      } else if (err.code === "auth/unauthorized-domain") {
        msg = "‚ö†Ô∏è Dom√≠nio n√£o autorizado no Firebase.";
        debugInfo = `Adicione "${window.location.hostname}" em Authentication > Settings`;
      } else if (err.code === "auth/operation-not-allowed") {
        msg = "‚ö†Ô∏è Google Sign-In n√£o habilitado.";
      } else if (err.code === "auth/popup-blocked") {
        msg = "‚ö†Ô∏è Popup bloqueado. Use o bot√£o alternativo.";
      } else if (err.code === "auth/popup-closed-by-user") {
        msg = "Login cancelado.";
      } else {
        msg = `Erro: ${err.code || "desconhecido"}`;
        debugInfo = err.message;
      }
      
      $("login-msg").textContent = msg;
      $("login-msg").className = "text-xs text-red-600 mt-4 min-h-[16px]";
      
      $("debug-content").innerHTML = `
        <div>‚Ä¢ Code: ${err.code || 'N/A'}</div>
        <div>‚Ä¢ Message: ${err.message || 'N/A'}</div>
        ${debugInfo ? `<div class="mt-2 font-bold">‚Üí ${debugInfo}</div>` : ''}
      `;
      $("debug-info").classList.remove("hidden");
    }

    // SUBSCRIPTIONS
    function subscribeObrasList() {
      const r = refs("dummy").obrasCol;
      listeners.push(onSnapshot(query(r, orderBy("createdAt", "desc")), (snap) => {
        state.obras = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        hydrateObrasSelect();
      }));
    }

    function hydrateObrasSelect() {
      const sel = $("obra-select");
      if (!state.obras.length) {
        sel.innerHTML = `<option value="">Nenhuma obra</option>`;
        return;
      }
      sel.innerHTML = state.obras.map(o => `<option value="${o.id}">${escapeHtml(o.nome || o.id)}</option>`).join("");
      if (!OBRA_ID) OBRA_ID = state.obras[0].id;
      sel.value = OBRA_ID;
      subscribeObra();
    }

    function subscribeObra() {
      if (!OBRA_ID) return;
      
      // Clear previous listeners
      while (listeners.length > 1) {
        const unsub = listeners.pop();
        unsub();
      }

      const r = refs(OBRA_ID);

      listeners.push(onSnapshot(r.unidadesCol, (snap) => {
        state.unidades = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.categoriasCol, (snap) => {
        state.categorias = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.fornecedoresCol, (snap) => {
        state.fornecedores = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.deducoesCol, (snap) => {
        state.deducoes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.lancamentosCol, (snap) => {
        state.lancamentos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.rateiosCol, (snap) => {
        state.rateios = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.acertosCol, (snap) => {
        state.acertos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        rerender();
      }));

      listeners.push(onSnapshot(r.configDoc, (snap) => {
        state.config = snap.exists() ? snap.data() : {};
        rerender();
      }));

      rerender();
    }

    function switchObra() {
      OBRA_ID = $("obra-select").value;
      if (OBRA_ID) {
        localStorage.setItem("obraId", OBRA_ID);
        subscribeObra();
      }
    }

    // RENDER
    function rerender() {
      if (!OBRA_ID || !state.user) return;

      // Update view buttons
      document.querySelectorAll(".view-btn").forEach(btn => {
        if (btn.dataset.view === VIEW) {
          btn.classList.remove("btn-soft");
          btn.classList.add("btn-dark");
        } else {
          btn.classList.remove("btn-dark");
          btn.classList.add("btn-soft");
        }
      });

      // Show/hide views
      document.querySelectorAll(".view-content").forEach(el => {
        el.classList.add("hidden");
      });
      $(`view-${VIEW}`)?.classList.remove("hidden");

      // Read filters
      filterText = $("filter-text")?.value?.trim().toLowerCase() || "";
      filterCategoria = $("filter-categoria")?.value || "TODAS";
      filterFornecedor = $("filter-fornecedor")?.value || "TODOS";
      filterPeriodo = $("filter-periodo")?.value || "TODOS";
      filterStatus = $("filter-status")?.value || "TODOS";

      // Render specific view
      if (VIEW === "DASHBOARD") {
        renderDashboard();
      } else if (VIEW === "LANCAMENTOS") {
        renderLancamentosView();
      } else if (VIEW === "RATEIOS") {
        renderRateiosView();
      } else if (VIEW === "ACERTOS") {
        renderAcertosView();
      } else if (VIEW === "CONFIG") {
        renderConfigView();
      }

      // Render modals
      renderObrasModal();
      renderUnidadesModal();
      renderFornecedoresModal();
      renderCategoriasModal();
    }

    // FILTER FUNCTIONS
    function getLancamentosFiltrados() {
      let lancs = [...state.lancamentos];

      // Per√≠odo
      if (filterPeriodo !== "TODOS") {
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const inicioMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
        const inicioTrimestre = new Date(hoje.getFullYear(), hoje.getMonth() - 3, 1);
        const inicioAno = new Date(hoje.getFullYear(), 0, 1);

        lancs = lancs.filter(l => {
          const dataLanc = new Date(l.dataCompetencia || l.data);
          switch(filterPeriodo) {
            case "MES_ATUAL": return dataLanc >= inicioMes;
            case "MES_ANTERIOR": return dataLanc >= inicioMesAnterior && dataLanc < inicioMes;
            case "TRIMESTRE": return dataLanc >= inicioTrimestre;
            case "ANO": return dataLanc >= inicioAno;
            default: return true;
          }
        });
      }

      // Status
      if (filterStatus !== "TODOS") {
        lancs = lancs.filter(l => (l.status || "pendente") === filterStatus);
      }

      // Categoria
      if (filterCategoria !== "TODAS") {
        lancs = lancs.filter(l => l.categoriaId === filterCategoria);
      }

      // Fornecedor
      if (filterFornecedor !== "TODOS") {
        lancs = lancs.filter(l => l.fornecedorId === filterFornecedor);
      }

      // Busca textual
      if (filterText) {
        lancs = lancs.filter(l => {
          const forn = state.fornecedores.find(f => f.id === l.fornecedorId)?.nome || "";
          const cat = state.categorias.find(c => c.id === l.categoriaId)?.nome || "";
          return forn.toLowerCase().includes(filterText) ||
                 cat.toLowerCase().includes(filterText) ||
                 (l.descricao || "").toLowerCase().includes(filterText);
        });
      }

      return lancs;
    }

    function getRateiosFiltrados() {
      let rats = [...state.rateios];

      // Per√≠odo
      if (filterPeriodo !== "TODOS") {
        const hoje = new Date();
        const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const inicioMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
        const inicioTrimestre = new Date(hoje.getFullYear(), hoje.getMonth() - 3, 1);
        const inicioAno = new Date(hoje.getFullYear(), 0, 1);

        rats = rats.filter(r => {
          const dataRat = new Date(r.dataCompetencia || r.data);
          switch(filterPeriodo) {
            case "MES_ATUAL": return dataRat >= inicioMes;
            case "MES_ANTERIOR": return dataRat >= inicioMesAnterior && dataRat < inicioMes;
            case "TRIMESTRE": return dataRat >= inicioTrimestre;
            case "ANO": return dataRat >= inicioAno;
            default: return true;
          }
        });
      }

      // Status
      if (filterStatus !== "TODOS") {
        rats = rats.filter(r => (r.status || "pendente") === filterStatus);
      }

      return rats;
    }

    // DASHBOARD
    function renderDashboard() {
      renderAlertasVencimento();
      
      const lancs = getLancamentosFiltrados();
      const rats = getRateiosFiltrados();
      
      const custoTotal = computeCustoTotal(lancs, rats);
      const lucroData = computeLucro(lancs, rats);
      const equalizacao = computeEqualizacao();

      // KPIs
      const kpisHTML = `
        <div class="card p-6">
          <div class="text-xs muted mb-2">üí∞ CUSTO TOTAL</div>
          <div class="text-3xl font-black">R$ ${custoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
        <div class="card p-6">
          <div class="text-xs muted mb-2">üíé VGV PREVISTO</div>
          <div class="text-3xl font-black">R$ ${lucroData.vgvTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
        <div class="card p-6">
          <div class="text-xs muted mb-2">üìä LUCRO BRUTO</div>
          <div class="text-3xl font-black ${lucroData.lucroBruto >= 0 ? 'ok' : 'danger'}">R$ ${lucroData.lucroBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
        <div class="card p-6">
          <div class="text-xs muted mb-2">üíµ LUCRO L√çQUIDO</div>
          <div class="text-3xl font-black ${lucroData.lucroLiquido >= 0 ? 'ok' : 'danger'}">R$ ${lucroData.lucroLiquido.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        </div>
      `;
      $("kpis-grid").innerHTML = kpisHTML;

      // Custo por m¬≤
      renderCustoM2(lancs, rats);

      // Top categorias
      renderTopCategorias(lancs, rats);

      // Top fornecedores
      renderTopFornecedores(lancs, rats);

      // Lucro por s√≥cio
      renderLucroSection(lucroData);

      // Equaliza√ß√£o
      renderEqualizacaoSection();

      // Hydrate filter selects
      hydrateFilterSelects();
    }

    function renderAlertasVencimento() {
      const hoje = new Date();
      const em7Dias = new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000);

      const lancamentosPendentes = state.lancamentos.filter(l => {
        if ((l.status || "pendente") === "pago" || !l.dataVencimento) return false;
        const venc = new Date(l.dataVencimento);
        return venc <= em7Dias;
      });

      const rateiosPendentes = state.rateios.filter(r => {
        if ((r.status || "pendente") === "pago" || !r.dataVencimento) return false;
        const venc = new Date(r.dataVencimento);
        return venc <= em7Dias;
      });

      const vencidos = [...lancamentosPendentes, ...rateiosPendentes].filter(item => {
        return new Date(item.dataVencimento) < hoje;
      });

      const vencendoEmBreve = [...lancamentosPendentes, ...rateiosPendentes].filter(item => {
        const venc = new Date(item.dataVencimento);
        return venc >= hoje && venc <= em7Dias;
      });

      const container = $("alertas-vencimento");
      if (vencidos.length === 0 && vencendoEmBreve.length === 0) {
        container.innerHTML = "";
        return;
      }

      let html = "";

      if (vencidos.length > 0) {
        const valorTotal = vencidos.reduce((sum, item) => sum + (item.valor || item.valorTotal), 0);
        html += `
          <div class="alert alert-danger">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-bold text-red-800 text-lg">üö® ${vencidos.length} Pagamento(s) Vencido(s)</h4>
                <p class="text-sm text-red-700 mt-1">Total: R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
              </div>
            </div>
          </div>
        `;
      }

      if (vencendoEmBreve.length > 0) {
        const valorTotal = vencendoEmBreve.reduce((sum, item) => sum + (item.valor || item.valorTotal), 0);
        html += `
          <div class="alert alert-warning">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-bold text-yellow-800 text-lg">‚ö†Ô∏è ${vencendoEmBreve.length} Pagamento(s) Vencendo em 7 Dias</h4>
                <p class="text-sm text-yellow-700 mt-1">Total: R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
              </div>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function renderCustoM2(lancs, rats) {
      const custoPorUnidade = {};

      lancs.forEach(l => {
        if (!custoPorUnidade[l.unidadeId]) custoPorUnidade[l.unidadeId] = 0;
        custoPorUnidade[l.unidadeId] += l.valor;
      });

      rats.forEach(r => {
        r.distribuicao?.forEach(d => {
          if (!custoPorUnidade[d.unidadeId]) custoPorUnidade[d.unidadeId] = 0;
          custoPorUnidade[d.unidadeId] += d.valor;
        });
      });

      const unidadesComCusto = Object.entries(custoPorUnidade)
        .map(([unidadeId, custo]) => {
          const unidade = state.unidades.find(u => u.id === unidadeId);
          if (!unidade) return null;

          const areaTotal = unidade.areaConstruida || 0;
          const custoM2 = areaTotal > 0 ? custo / areaTotal : 0;

          return { unidade, custo, areaTotal, custoM2 };
        })
        .filter(Boolean)
        .sort((a, b) => b.custoM2 - a.custoM2);

      if (unidadesComCusto.length === 0) {
        $("custo-m2-section").innerHTML = "";
        return;
      }

      const html = `
        <div class="card p-6 mb-6">
          <div class="font-black text-lg mb-4">üìê Custo por m¬≤ / Unidade</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${unidadesComCusto.map(item => `
              <div class="border rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">${escapeHtml(item.unidade.nome)}</h4>
                <div class="space-y-1 text-sm">
                  <p><span class="muted">Custo Total:</span> <span class="font-bold">R$ ${item.custo.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></p>
                  <p><span class="muted">√Årea:</span> ${item.areaTotal.toFixed(2)} m¬≤</p>
                  <p><span class="muted">Custo/m¬≤:</span> <span class="font-bold text-blue-600">R$ ${item.custoM2.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      $("custo-m2-section").innerHTML = html;
    }

    function renderTopCategorias(lancs, rats) {
      const custoPorCategoria = {};

      lancs.forEach(l => {
        if (!custoPorCategoria[l.categoriaId]) custoPorCategoria[l.categoriaId] = 0;
        custoPorCategoria[l.categoriaId] += l.valor;
      });

      rats.forEach(r => {
        if (!custoPorCategoria[r.categoriaId]) custoPorCategoria[r.categoriaId] = 0;
        custoPorCategoria[r.categoriaId] += r.valorTotal;
      });

      const sorted = Object.entries(custoPorCategoria)
        .map(([catId, valor]) => {
          const cat = state.categorias.find(c => c.id === catId);
          return { nome: cat?.nome || "Sem categoria", valor };
        })
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 5);

      if (sorted.length === 0) {
        $("top-categorias").innerHTML = '<p class="text-sm muted">Nenhum dado</p>';
        return;
      }

      const html = sorted.map((item, i) => `
        <div class="flex justify-between items-center py-2 border-b">
          <div class="flex items-center gap-2">
            <span class="font-bold text-slate-400">${i + 1}.</span>
            <span class="text-sm">${escapeHtml(item.nome)}</span>
          </div>
          <span class="font-bold text-sm">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
      `).join('');

      $("top-categorias").innerHTML = html;
    }

    function renderTopFornecedores(lancs, rats) {
      const custoPorFornecedor = {};

      lancs.forEach(l => {
        if (!custoPorFornecedor[l.fornecedorId]) custoPorFornecedor[l.fornecedorId] = 0;
        custoPorFornecedor[l.fornecedorId] += l.valor;
      });

      rats.forEach(r => {
        if (!custoPorFornecedor[r.fornecedorId]) custoPorFornecedor[r.fornecedorId] = 0;
        custoPorFornecedor[r.fornecedorId] += r.valorTotal;
      });

      const sorted = Object.entries(custoPorFornecedor)
        .map(([fornId, valor]) => {
          const forn = state.fornecedores.find(f => f.id === fornId);
          return { nome: forn?.nome || "Sem fornecedor", valor };
        })
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 5);

      if (sorted.length === 0) {
        $("top-fornecedores").innerHTML = '<p class="text-sm muted">Nenhum dado</p>';
        return;
      }

      const html = sorted.map((item, i) => `
        <div class="flex justify-between items-center py-2 border-b">
          <div class="flex items-center gap-2">
            <span class="font-bold text-slate-400">${i + 1}.</span>
            <span class="text-sm">${escapeHtml(item.nome)}</span>
          </div>
          <span class="font-bold text-sm">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
      `).join('');

      $("top-fornecedores").innerHTML = html;
    }

    function renderLucroSection(lucroData) {
      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      let html = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="border rounded-lg p-4">
            <div class="text-sm muted mb-1">üë§ ${escapeHtml(socioA)}</div>
            <div class="text-2xl font-black ${lucroData.lucroLiquidoA >= 0 ? 'ok' : 'danger'}">
              R$ ${lucroData.lucroLiquidoA.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </div>
          </div>
          <div class="border rounded-lg p-4">
            <div class="text-sm muted mb-1">üë§ ${escapeHtml(socioB)}</div>
            <div class="text-2xl font-black ${lucroData.lucroLiquidoB >= 0 ? 'ok' : 'danger'}">
              R$ ${lucroData.lucroLiquidoB.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
            </div>
          </div>
        </div>
      `;

      if (lucroData.deducoes.length > 0) {
        html += `
          <div class="text-xs muted mt-4">
            <div class="font-bold mb-2">Dedu√ß√µes aplicadas:</div>
            ${lucroData.deducoes.map(d => `
              <div>‚Ä¢ ${escapeHtml(d.nome)}: ${d.percentual.toFixed(2)}% = R$ ${d.valorDeducao.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            `).join('')}
          </div>
        `;
      }

      $("lucro-section").innerHTML = html;
    }

    function renderEqualizacaoSection() {
      const eq = computeEqualizacao();
      if (!eq) {
        $("equalizacao-section").innerHTML = '<p class="text-sm muted">Saldos zerados</p>';
        return;
      }
      $("equalizacao-section").innerHTML = `<p class="text-lg">${eq}</p>`;
    }

    function hydrateFilterSelects() {
      // Categorias
      const catSel = $("filter-categoria");
      catSel.innerHTML = '<option value="TODAS">Todas</option>' +
        state.categorias.map(c => `<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join('');
      catSel.value = filterCategoria;

      // Fornecedores
      const fornSel = $("filter-fornecedor");
      fornSel.innerHTML = '<option value="TODOS">Todos</option>' +
        state.fornecedores.map(f => `<option value="${f.id}">${escapeHtml(f.nome)}</option>`).join('');
      fornSel.value = filterFornecedor;
    }

    // LANCAMENTOS VIEW
    function renderLancamentosView() {
      // Hydrate selects
      const unidSel = $("lanc-unidade");
      unidSel.innerHTML = '<option value="">Selecione...</option>' +
        state.unidades.map(u => `<option value="${u.id}">${escapeHtml(u.nome)}</option>`).join('');

      const catSel = $("lanc-categoria");
      catSel.innerHTML = '<option value="">Selecione...</option>' +
        state.categorias.map(c => `<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join('');

      const fornSel = $("lanc-fornecedor");
      fornSel.innerHTML = '<option value="">Selecione...</option>' +
        state.fornecedores.map(f => `<option value="${f.id}">${escapeHtml(f.nome)}</option>`).join('');

      // Render list
      renderLancamentosList();
    }

    function renderLancamentosList() {
      const container = $("lanc-list");
      if (state.lancamentos.length === 0) {
        container.innerHTML = '<p class="text-center muted py-8">Nenhum lan√ßamento cadastrado</p>';
        return;
      }

      const html = `
        <table class="table w-full">
          <thead>
            <tr>
              <th class="text-left">Data</th>
              <th class="text-left">Status</th>
              <th class="text-left">Unidade</th>
              <th class="text-left">Categoria</th>
              <th class="text-left">Fornecedor</th>
              <th class="text-left">Descri√ß√£o</th>
              <th class="text-left">Valor</th>
              <th class="text-left">Vencimento</th>
              <th class="text-left">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${state.lancamentos.map(l => {
              const unid = state.unidades.find(u => u.id === l.unidadeId);
              const cat = state.categorias.find(c => c.id === l.categoriaId);
              const forn = state.fornecedores.find(f => f.id === l.fornecedorId);
              const statusClass = (l.status || "pendente") === "pago" ? "badge-pago" : (l.status === "atrasado" ? "badge-atrasado" : "badge-pendente");
              const statusIcon = (l.status || "pendente") === "pago" ? "‚úÖ" : (l.status === "atrasado" ? "üö®" : "‚è≥");
              
              return `
                <tr>
                  <td>${new Date(l.data).toLocaleDateString('pt-BR')}</td>
                  <td><span class="badge ${statusClass}">${statusIcon} ${(l.status || "pendente").toUpperCase()}</span></td>
                  <td>${escapeHtml(unid?.nome || '-')}</td>
                  <td>${escapeHtml(cat?.nome || '-')}</td>
                  <td>${escapeHtml(forn?.nome || '-')}</td>
                  <td>${escapeHtml(l.descricao)}</td>
                  <td class="font-bold">R$ ${l.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                  <td>${l.dataVencimento ? new Date(l.dataVencimento).toLocaleDateString('pt-BR') : '-'}</td>
                  <td>
                    ${l.comprovante ? `<a href="${l.comprovante}" target="_blank" class="text-blue-600 hover:underline mr-2">üìé</a>` : ''}
                    <button onclick="window.mudarStatusLancamento('${l.id}')" class="text-green-600 hover:underline mr-2" title="Mudar status">üí≥</button>
                    <button onclick="window.deleteLancamento('${l.id}')" class="text-red-600 hover:underline" title="Deletar">üóëÔ∏è</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // RATEIOS VIEW
    function renderRateiosView() {
      // Hydrate selects
      const catSel = $("rat-categoria");
      catSel.innerHTML = '<option value="">Selecione...</option>' +
        state.categorias.map(c => `<option value="${c.id}">${escapeHtml(c.nome)}</option>`).join('');

      const fornSel = $("rat-fornecedor");
      fornSel.innerHTML = '<option value="">Selecione...</option>' +
        state.fornecedores.map(f => `<option value="${f.id}">${escapeHtml(f.nome)}</option>`).join('');

      // Init destinations
      rateioDestCount = 0;
      $("rat-dests").innerHTML = "";
      rateioAddDest();

      // Render list
      renderRateiosList();
    }

    function rateioAddDest() {
      const container = $("rat-dests");
      const id = rateioDestCount++;
      const div = document.createElement('div');
      div.className = "grid grid-cols-12 gap-2";
      div.id = `rat-dest-${id}`;
      div.innerHTML = `
        <div class="col-span-6">
          <select class="select text-sm rat-dest-unidade" required>
            <option value="">Selecione unidade...</option>
            ${state.unidades.map(u => `<option value="${u.id}">${escapeHtml(u.nome)}</option>`).join('')}
          </select>
        </div>
        <div class="col-span-4">
          <input type="number" step="0.01" class="input text-sm rat-dest-valor" placeholder="Valor (R$)" required />
        </div>
        <div class="col-span-2">
          <button type="button" onclick="window.rateioRemoveDest('${id}')" class="btn btn-danger w-full text-sm">üóëÔ∏è</button>
        </div>
      `;
      container.appendChild(div);
    }

    window.rateioRemoveDest = (id) => {
      $(`rat-dest-${id}`)?.remove();
    };

    function renderRateiosList() {
      const container = $("rat-list");
      if (state.rateios.length === 0) {
        container.innerHTML = '<p class="text-center muted py-8">Nenhum rateio cadastrado</p>';
        return;
      }

      const html = `
        <table class="table w-full">
          <thead>
            <tr>
              <th class="text-left">Data</th>
              <th class="text-left">Status</th>
              <th class="text-left">Descri√ß√£o</th>
              <th class="text-left">Fornecedor</th>
              <th class="text-left">Categoria</th>
              <th class="text-left">Valor Total</th>
              <th class="text-left">Destinos</th>
              <th class="text-left">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${state.rateios.map(r => {
              const forn = state.fornecedores.find(f => f.id === r.fornecedorId);
              const cat = state.categorias.find(c => c.id === r.categoriaId);
              const statusClass = (r.status || "pendente") === "pago" ? "badge-pago" : (r.status === "atrasado" ? "badge-atrasado" : "badge-pendente");
              const statusIcon = (r.status || "pendente") === "pago" ? "‚úÖ" : (r.status === "atrasado" ? "üö®" : "‚è≥");
              
              return `
                <tr>
                  <td>${new Date(r.data).toLocaleDateString('pt-BR')}</td>
                  <td><span class="badge ${statusClass}">${statusIcon} ${(r.status || "pendente").toUpperCase()}</span></td>
                  <td>${escapeHtml(r.descricao)}</td>
                  <td>${escapeHtml(forn?.nome || '-')}</td>
                  <td>${escapeHtml(cat?.nome || '-')}</td>
                  <td class="font-bold">R$ ${r.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                  <td class="text-sm">${r.distribuicao?.length || 0} unidades</td>
                  <td>
                    <button onclick="window.mudarStatusRateio('${r.id}')" class="text-green-600 hover:underline mr-2" title="Mudar status">üí≥</button>
                    <button onclick="window.deleteRateio('${r.id}')" class="text-red-600 hover:underline" title="Deletar">üóëÔ∏è</button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // ACERTOS VIEW
    function renderAcertosView() {
      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      $("ac-de").innerHTML = `
        <option value="A">${escapeHtml(socioA)}</option>
        <option value="B">${escapeHtml(socioB)}</option>
      `;

      $("ac-para").innerHTML = `
        <option value="A">${escapeHtml(socioA)}</option>
        <option value="B">${escapeHtml(socioB)}</option>
      `;

      renderAcertosList();
    }

    function renderAcertosList() {
      const container = $("acerto-list");
      if (state.acertos.length === 0) {
        container.innerHTML = '<p class="text-center muted py-8">Nenhum acerto cadastrado</p>';
        return;
      }

      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      const html = `
        <table class="table w-full">
          <thead>
            <tr>
              <th class="text-left">Data</th>
              <th class="text-left">De</th>
              <th class="text-left">Para</th>
              <th class="text-left">Valor</th>
              <th class="text-left">Descri√ß√£o</th>
              <th class="text-left">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${state.acertos.map(a => `
              <tr>
                <td>${new Date(a.data).toLocaleDateString('pt-BR')}</td>
                <td>${escapeHtml(a.de === 'A' ? socioA : socioB)}</td>
                <td>${escapeHtml(a.para === 'A' ? socioA : socioB)}</td>
                <td class="font-bold">R$ ${a.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${escapeHtml(a.descricao)}</td>
                <td>
                  <button onclick="window.deleteAcerto('${a.id}')" class="text-red-600 hover:underline">üóëÔ∏è</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    // CONFIG VIEW
    function renderConfigView() {
      $("socio-a").value = state.config.socioA || "";
      $("socio-b").value = state.config.socioB || "";

      renderDeducoesList();
    }

    function renderDeducoesList() {
      const container = $("ded-list");
      if (state.deducoes.length === 0) {
        container.innerHTML = '<p class="muted">Nenhuma dedu√ß√£o cadastrada</p>';
        return;
      }

      const html = state.deducoes.map(d => `
        <div class="flex justify-between items-center p-2 border rounded">
          <span>${escapeHtml(d.nome)} ‚Äî ${d.percentual.toFixed(2)}%</span>
          <button onclick="window.deleteDeducao('${d.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è</button>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // MODALS
    function openModal(id) {
      $(id).classList.remove("hidden");
      $(id).classList.add("flex");
    }

    function closeModal(id) {
      $(id).classList.add("hidden");
      $(id).classList.remove("flex");
    }

    function renderObrasModal() {
      const container = $("obras-list");
      if (state.obras.length === 0) {
        container.innerHTML = '<p class="muted">Nenhuma obra cadastrada</p>';
        return;
      }

      const html = state.obras.map(o => `
        <div class="flex justify-between items-center p-3 border rounded">
          <span class="font-bold">${escapeHtml(o.nome)}</span>
          <button onclick="window.deleteObra('${o.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è Deletar</button>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function renderUnidadesModal() {
      const container = $("unidades-list");
      if (state.unidades.length === 0) {
        container.innerHTML = '<p class="muted">Nenhuma unidade cadastrada</p>';
        return;
      }

      const html = state.unidades.map(u => `
        <div class="flex justify-between items-center p-3 border rounded">
          <div>
            <div class="font-bold">${escapeHtml(u.nome)}</div>
            <div class="text-xs muted">VGV: R$ ${(u.vgvPrevisto || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
          </div>
          <button onclick="window.deleteUnidade('${u.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è</button>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function renderFornecedoresModal() {
      const container = $("fornecedores-list");
      if (state.fornecedores.length === 0) {
        container.innerHTML = '<p class="muted">Nenhum fornecedor cadastrado</p>';
        return;
      }

      const html = state.fornecedores.map(f => `
        <div class="flex justify-between items-center p-3 border rounded">
          <div>
            <div class="font-bold">${escapeHtml(f.nome)}</div>
            <div class="text-xs muted">${escapeHtml(f.contato || '-')} ${f.documento ? '‚Ä¢ ' + f.documento : ''}</div>
          </div>
          <button onclick="window.deleteFornecedor('${f.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è</button>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    function renderCategoriasModal() {
      const container = $("categorias-list");
      if (state.categorias.length === 0) {
        container.innerHTML = '<p class="muted">Nenhuma categoria cadastrada</p>';
        return;
      }

      const html = state.categorias.map(c => `
        <div class="flex justify-between items-center p-3 border rounded">
          <div class="flex items-center gap-2">
            <div style="width: 16px; height: 16px; border-radius: 4px; background: ${c.cor || '#ccc'};"></div>
            <div>
              <div class="font-bold">${escapeHtml(c.nome)}</div>
              ${c.grupo ? `<div class="text-xs muted">Grupo: ${escapeHtml(c.grupo)}</div>` : ''}
            </div>
          </div>
          <button onclick="window.deleteCategoria('${c.id}')" class="text-red-600 hover:underline text-sm">üóëÔ∏è</button>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // CRUD FUNCTIONS
    async function createObra() {
      const nome = $("obra-new-nome").value.trim();
      if (!nome) {
        showToast('Digite o nome da obra', 'warning');
        return;
      }

      try {
        await addDoc(refs("dummy").obrasCol, {
          nome,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("obra-new-nome").value = "";
        showToast('Obra criada com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar obra', 'error');
      }
    }

    async function createUnidade() {
      const nome = $("unid-new-nome").value.trim();
      const vgv = parseFloat($("unid-new-vgv").value) || 0;

      if (!nome) {
        showToast('Digite o nome da unidade', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).unidadesCol, {
          nome,
          vgvPrevisto: vgv,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("unid-new-nome").value = "";
        $("unid-new-vgv").value = "";
        showToast('Unidade criada com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar unidade', 'error');
      }
    }

    async function createFornecedor() {
      const nome = $("forn-nome").value.trim();
      const contato = $("forn-contato").value.trim();
      const doc = $("forn-doc").value.trim();

      if (!nome) {
        showToast('Digite o nome do fornecedor', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).fornecedoresCol, {
          nome,
          contato: contato || null,
          documento: doc || null,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("forn-nome").value = "";
        $("forn-contato").value = "";
        $("forn-doc").value = "";
        showToast('Fornecedor criado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar fornecedor', 'error');
      }
    }

    async function createCategoria() {
      const nome = $("cat-nome").value.trim();
      const grupo = $("cat-grupo").value.trim();
      const cor = $("cat-cor").value;

      if (!nome) {
        showToast('Digite o nome da categoria', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).categoriasCol, {
          nome,
          grupo: grupo || null,
          cor: cor || "#3b82f6",
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("cat-nome").value = "";
        $("cat-grupo").value = "";
        showToast('Categoria criada com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar categoria', 'error');
      }
    }

    async function createDeducao() {
      const nome = $("ded-nome").value.trim();
      const percentual = parseFloat($("ded-percent").value);

      if (!nome || !percentual) {
        showToast('Preencha nome e percentual', 'warning');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).deducoesCol, {
          nome,
          percentual,
          createdAt: serverTimestamp()
        });
        $("ded-nome").value = "";
        $("ded-percent").value = "";
        showToast('Dedu√ß√£o criada com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar dedu√ß√£o', 'error');
      }
    }

    async function saveSocios() {
      const socioA = $("socio-a").value.trim() || "S√≥cio A";
      const socioB = $("socio-b").value.trim() || "S√≥cio B";

      try {
        await setDoc(refs(OBRA_ID).configDoc, {
          socioA,
          socioB,
          updatedAt: serverTimestamp()
        }, { merge: true });
        showToast('S√≥cios salvos com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao salvar s√≥cios', 'error');
      }
    }

    async function addLancamento(e) {
      e.preventDefault();

      const data = $("lanc-data").value;
      const vencimento = $("lanc-vencimento").value || null;
      const competencia = $("lanc-competencia").value || data;
      const unidadeId = $("lanc-unidade").value;
      const categoriaId = $("lanc-categoria").value;
      const fornecedorId = $("lanc-fornecedor").value;
      const pagador = $("lanc-pagador").value;
      const valor = parseFloat($("lanc-valor").value);
      const status = $("lanc-status").value;
      const descricao = $("lanc-descricao").value.trim();
      const comprovante = $("lanc-comprovante").value.trim();

      if (!data || !unidadeId || !categoriaId || !fornecedorId || !valor || !descricao) {
        showToast('Preencha todos os campos obrigat√≥rios', 'error');
        return;
      }

      // Valida√ß√£o de duplicatas
      const possiveisDuplicatas = state.lancamentos.filter(l =>
        l.fornecedorId === fornecedorId &&
        Math.abs(l.valor - valor) < 0.01 &&
        Math.abs(new Date(l.data) - new Date(data)) < 7 * 24 * 60 * 60 * 1000
      );

      if (possiveisDuplicatas.length > 0) {
        const fornecedorNome = state.fornecedores.find(f => f.id === fornecedorId)?.nome;
        if (!confirm(`‚ö†Ô∏è POSS√çVEL DUPLICATA!\n\nJ√° existe ${possiveisDuplicatas.length} lan√ßamento(s) similar(es):\n- Fornecedor: ${fornecedorNome}\n- Valor: R$ ${valor.toFixed(2)}\n- Data pr√≥xima\n\nDeseja continuar mesmo assim?`)) {
          return;
        }
      }

      try {
        await addDoc(refs(OBRA_ID).lancamentosCol, {
          data,
          dataVencimento: vencimento,
          dataCompetencia: competencia,
          unidadeId,
          categoriaId,
          fornecedorId,
          pagador,
          valor,
          status,
          descricao,
          comprovante: comprovante || null,
          createdAt: serverTimestamp(),
          createdBy: state.user.email,
          historico: [{
            acao: 'created',
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        $("lanc-form").reset();
        showToast('Lan√ßamento criado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar lan√ßamento', 'error');
      }
    }

    async function ratearIgualmente() {
      const fornecedorId = $("rat-fornecedor").value;
      const categoriaId = $("rat-categoria").value;
      const descricao = $("rat-descricao").value.trim();
      const valorTotal = parseFloat($("rat-valor-total").value);
      const data = $("rat-data").value;

      if (!fornecedorId || !categoriaId || !descricao || !valorTotal || !data) {
        showToast('Preencha os campos principais antes de ratear', 'warning');
        return;
      }

      if (state.unidades.length === 0) {
        showToast('Nenhuma unidade cadastrada', 'error');
        return;
      }

      if (!confirm(`Ratear R$ ${valorTotal.toFixed(2)} igualmente entre ${state.unidades.length} unidades?`)) {
        return;
      }

      const valorPorUnidade = valorTotal / state.unidades.length;
      const vencimento = $("rat-vencimento").value || null;
      const status = $("rat-status").value;

      try {
        await addDoc(refs(OBRA_ID).rateiosCol, {
          data,
          dataVencimento: vencimento,
          dataCompetencia: data,
          fornecedorId,
          categoriaId,
          descricao,
          valorTotal,
          status,
          distribuicao: state.unidades.map(u => ({
            unidadeId: u.id,
            valor: parseFloat(valorPorUnidade.toFixed(2))
          })),
          createdAt: serverTimestamp(),
          createdBy: state.user.email,
          historico: [{
            acao: 'created',
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        $("rat-form")?.reset();
        rateioDestCount = 0;
        $("rat-dests").innerHTML = "";
        rateioAddDest();
        showToast(`Rateio criado! R$ ${valorPorUnidade.toFixed(2)} por unidade`, 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar rateio', 'error');
      }
    }

    async function addRateio() {
      const data = $("rat-data").value;
      const vencimento = $("rat-vencimento").value || null;
      const status = $("rat-status").value;
      const fornecedorId = $("rat-fornecedor").value;
      const categoriaId = $("rat-categoria").value;
      const descricao = $("rat-descricao").value.trim();
      const valorTotal = parseFloat($("rat-valor-total").value);

      if (!data || !fornecedorId || !categoriaId || !descricao || !valorTotal) {
        showToast('Preencha todos os campos obrigat√≥rios', 'error');
        return;
      }

      // Collect destinations
      const distribuicao = [];
      const destEls = document.querySelectorAll(".rat-dest-unidade");
      for (let i = 0; i < destEls.length; i++) {
        const unidadeId = destEls[i].value;
        const valorInput = destEls[i].parentElement.parentElement.querySelector(".rat-dest-valor");
        const valor = parseFloat(valorInput.value);
        if (unidadeId && valor) {
          distribuicao.push({ unidadeId, valor });
        }
      }

      if (distribuicao.length === 0) {
        showToast('Adicione pelo menos um destino', 'warning');
        return;
      }

      const somaDistribuicao = distribuicao.reduce((sum, d) => sum + d.valor, 0);
      if (Math.abs(somaDistribuicao - valorTotal) > 0.01) {
        showToast(`A soma da distribui√ß√£o (R$ ${somaDistribuicao.toFixed(2)}) n√£o bate com o valor total (R$ ${valorTotal.toFixed(2)})`, 'error');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).rateiosCol, {
          data,
          dataVencimento: vencimento,
          dataCompetencia: data,
          fornecedorId,
          categoriaId,
          descricao,
          valorTotal,
          status,
          distribuicao,
          createdAt: serverTimestamp(),
          createdBy: state.user.email,
          historico: [{
            acao: 'created',
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        $("rat-data").value = "";
        $("rat-vencimento").value = "";
        $("rat-fornecedor").value = "";
        $("rat-categoria").value = "";
        $("rat-descricao").value = "";
        $("rat-valor-total").value = "";
        rateioDestCount = 0;
        $("rat-dests").innerHTML = "";
        rateioAddDest();
        showToast('Rateio criado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao criar rateio', 'error');
      }
    }

    async function addAcerto(e) {
      e.preventDefault();

      const data = $("ac-data").value;
      const de = $("ac-de").value;
      const para = $("ac-para").value;
      const valor = parseFloat($("ac-valor").value);
      const descricao = $("ac-descricao").value.trim();

      if (!data || !valor || !descricao || de === para) {
        showToast('Preencha corretamente (De ‚â† Para)', 'error');
        return;
      }

      try {
        await addDoc(refs(OBRA_ID).acertosCol, {
          data,
          de,
          para,
          valor,
          descricao,
          createdAt: serverTimestamp(),
          createdBy: state.user.email
        });
        $("acerto-form").reset();
        showToast('Acerto registrado com sucesso!', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao registrar acerto', 'error');
      }
    }

    // DELETE FUNCTIONS
    window.deleteObra = async (id) => {
      if (!confirm('Deletar obra? ATEN√á√ÉO: Todos os dados da obra ser√£o perdidos!')) return;
      try {
        await deleteDoc(doc(db, "obras", id));
        showToast('Obra deletada', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar obra', 'error');
      }
    };

    window.deleteUnidade = async (id) => {
      if (!confirm('Deletar unidade?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "unidades", id));
        showToast('Unidade deletada', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar unidade', 'error');
      }
    };

    window.deleteFornecedor = async (id) => {
      if (!confirm('Deletar fornecedor?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "fornecedores", id));
        showToast('Fornecedor deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar fornecedor', 'error');
      }
    };

    window.deleteCategoria = async (id) => {
      if (!confirm('Deletar categoria?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "categorias", id));
        showToast('Categoria deletada', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar categoria', 'error');
      }
    };

    window.deleteDeducao = async (id) => {
      if (!confirm('Deletar dedu√ß√£o?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "deducoes", id));
        showToast('Dedu√ß√£o deletada', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar dedu√ß√£o', 'error');
      }
    };

    window.deleteLancamento = async (id) => {
      if (!confirm('Deletar lan√ßamento?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "lancamentos", id));
        showToast('Lan√ßamento deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar lan√ßamento', 'error');
      }
    };

    window.deleteRateio = async (id) => {
      if (!confirm('Deletar rateio?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "rateios", id));
        showToast('Rateio deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar rateio', 'error');
      }
    };

    window.deleteAcerto = async (id) => {
      if (!confirm('Deletar acerto?')) return;
      try {
        await deleteDoc(doc(db, "obras", OBRA_ID, "acertos", id));
        showToast('Acerto deletado', 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao deletar acerto', 'error');
      }
    };

    // STATUS CHANGE
    window.mudarStatusLancamento = async (id) => {
      const lancamento = state.lancamentos.find(l => l.id === id);
      if (!lancamento) return;

      const statusAtual = lancamento.status || "pendente";
      const proximoStatus = {
        "pendente": "pago",
        "pago": "pendente",
        "atrasado": "pago"
      };

      const novoStatus = proximoStatus[statusAtual];

      try {
        await updateDoc(doc(db, "obras", OBRA_ID, "lancamentos", id), {
          status: novoStatus,
          historico: [...(lancamento.historico || []), {
            acao: 'status_changed',
            de: statusAtual,
            para: novoStatus,
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        showToast(`Status alterado para: ${novoStatus}`, 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao alterar status', 'error');
      }
    };

    window.mudarStatusRateio = async (id) => {
      const rateio = state.rateios.find(r => r.id === id);
      if (!rateio) return;

      const statusAtual = rateio.status || "pendente";
      const proximoStatus = {
        "pendente": "pago",
        "pago": "pendente",
        "atrasado": "pago"
      };

      const novoStatus = proximoStatus[statusAtual];

      try {
        await updateDoc(doc(db, "obras", OBRA_ID, "rateios", id), {
          status: novoStatus,
          historico: [...(rateio.historico || []), {
            acao: 'status_changed',
            de: statusAtual,
            para: novoStatus,
            usuario: state.user.email,
            data: new Date().toISOString()
          }]
        });
        showToast(`Status alterado para: ${novoStatus}`, 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro ao alterar status', 'error');
      }
    };

    // COMPUTE FUNCTIONS
    function computeCustoTotal(lancs = null, rats = null) {
      if (!lancs) lancs = getLancamentosFiltrados();
      if (!rats) rats = getRateiosFiltrados();

      const custoLanc = lancs.reduce((sum, l) => sum + l.valor, 0);
      const custoRat = rats.reduce((sum, r) => sum + r.valorTotal, 0);
      return custoLanc + custoRat;
    }

    function computeLucro(lancs = null, rats = null) {
      if (!lancs) lancs = getLancamentosFiltrados();
      if (!rats) rats = getRateiosFiltrados();

      const vgvTotal = state.unidades.reduce((sum, u) => sum + (u.vgvPrevisto || 0), 0);
      const custoTotal = computeCustoTotal(lancs, rats);
      const lucroBruto = vgvTotal - custoTotal;

      let valorDeducoes = 0;
      const deducoesAplicadas = [];
      state.deducoes.forEach(d => {
        const valor = (d.percentual / 100) * lucroBruto;
        valorDeducoes += valor;
        deducoesAplicadas.push({ ...d, valorDeducao: valor });
      });

      const lucroLiquido = lucroBruto - valorDeducoes;

      const lucroLiquidoA = lucroLiquido / 2;
      const lucroLiquidoB = lucroLiquido / 2;

      return {
        vgvTotal,
        custoTotal,
        lucroBruto,
        valorDeducoes,
        deducoes: deducoesAplicadas,
        lucroLiquido,
        lucroLiquidoA,
        lucroLiquidoB
      };
    }

    function computeEqualizacao() {
      const pagamentosA = {};
      const pagamentosB = {};

      state.unidades.forEach(u => {
        pagamentosA[u.id] = 0;
        pagamentosB[u.id] = 0;
      });

      state.lancamentos.forEach(l => {
        const metade = l.valor / 2;
        if (l.pagador === "A") {
          pagamentosA[l.unidadeId] = (pagamentosA[l.unidadeId] || 0) + l.valor;
          pagamentosA[l.unidadeId] -= metade;
          pagamentosB[l.unidadeId] = (pagamentosB[l.unidadeId] || 0) - metade;
        } else {
          pagamentosB[l.unidadeId] = (pagamentosB[l.unidadeId] || 0) + l.valor;
          pagamentosB[l.unidadeId] -= metade;
          pagamentosA[l.unidadeId] = (pagamentosA[l.unidadeId] || 0) - metade;
        }
      });

      state.rateios.forEach(r => {
        r.distribuicao?.forEach(d => {
          const metade = d.valor / 2;
          pagamentosA[d.unidadeId] = (pagamentosA[d.unidadeId] || 0) - metade;
          pagamentosB[d.unidadeId] = (pagamentosB[d.unidadeId] || 0) - metade;
        });
      });

      state.acertos.forEach(a => {
        if (a.de === "A" && a.para === "B") {
          Object.keys(pagamentosA).forEach(uid => {
            pagamentosA[uid] -= a.valor / state.unidades.length;
            pagamentosB[uid] += a.valor / state.unidades.length;
          });
        } else if (a.de === "B" && a.para === "A") {
          Object.keys(pagamentosA).forEach(uid => {
            pagamentosA[uid] += a.valor / state.unidades.length;
            pagamentosB[uid] -= a.valor / state.unidades.length;
          });
        }
      });

      const saldoA = Object.values(pagamentosA).reduce((sum, v) => sum + v, 0);
      const saldoB = Object.values(pagamentosB).reduce((sum, v) => sum + v, 0);

      const socioA = state.config.socioA || "S√≥cio A";
      const socioB = state.config.socioB || "S√≥cio B";

      if (Math.abs(saldoA) < 1 && Math.abs(saldoB) < 1) {
        return null;
      }

      if (saldoA > 0) {
        return `${socioB} deve R$ ${Math.abs(saldoA).toFixed(2)} para ${socioA}`;
      } else {
        return `${socioA} deve R$ ${Math.abs(saldoA).toFixed(2)} para ${socioB}`;
      }
    }

    // PDF EXPORT
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      pdf.setFontSize(18);
      pdf.text("VG CONSTRUTORA - Dashboard", 14, 20);

      const obra = state.obras.find(o => o.id === OBRA_ID);
      pdf.setFontSize(12);
      pdf.text(`Obra: ${obra?.nome || "N/A"}`, 14, 30);
      pdf.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 36);

      const lancs = getLancamentosFiltrados();
      const rats = getRateiosFiltrados();
      const custoTotal = computeCustoTotal(lancs, rats);
      const lucroData = computeLucro(lancs, rats);

      pdf.setFontSize(10);
      let y = 50;
      pdf.text(`Custo Total: R$ ${custoTotal.toFixed(2)}`, 14, y);
      y += 6;
      pdf.text(`VGV Previsto: R$ ${lucroData.vgvTotal.toFixed(2)}`, 14, y);
      y += 6;
      pdf.text(`Lucro Bruto: R$ ${lucroData.lucroBruto.toFixed(2)}`, 14, y);
      y += 6;
      pdf.text(`Lucro L√≠quido: R$ ${lucroData.lucroLiquido.toFixed(2)}`, 14, y);
      y += 10;

      pdf.text(`${state.config.socioA || 'S√≥cio A'}: R$ ${lucroData.lucroLiquidoA.toFixed(2)}`, 14, y);
      y += 6;
      pdf.text(`${state.config.socioB || 'S√≥cio B'}: R$ ${lucroData.lucroLiquidoB.toFixed(2)}`, 14, y);

      pdf.save(`VG_CONSTRUTORA_${new Date().toISOString().split('T')[0]}.pdf`);
      showToast('PDF exportado com sucesso!', 'success');
    }

  </script>
</body>
</html>
